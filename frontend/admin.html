<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã - HTIC Legal App v10.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 50: '#e8eef5', 100: '#c5d4e8', 500: '#3d6d9e', 600: '#1e3a5f', 700: '#162d4a', 800: '#0f1f33' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 3px solid #f97316; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .table-row:hover { background: #f8fafc; }
        .stat-card:hover { transform: translateY(-2px); }
        .ql-toolbar.ql-snow { border-radius: 12px 12px 0 0; border-color: #e5e7eb; background: #f9fafb; }
        .ql-container.ql-snow { border-radius: 0 0 12px 12px; border-color: #e5e7eb; font-size: 16px; }
        .ql-editor { min-height: 200px; max-height: 400px; overflow-y: auto; }
        .ql-editor.ql-blank::before { font-style: normal; color: #9ca3af; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .tab-btn.active { background: linear-gradient(135deg, #1e3a5f, #162d4a); color: white; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>
    <div id="modal-root"></div>

    <script>
        // ========== CONFIGURATION ==========
        const API = '/api';
        let token = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';
        let allData = { events: [], news: [], agencies: [], provinces: [], settings: {}, stats: {}, users: [], lawyers: [], payments: [] };
        let quillEditor = null;

        const app = document.getElementById('app');
        const modalRoot = document.getElementById('modal-root');

        // ========== CONSTANTS ==========
        const CATEGORIES = [
            { id: 'tax', name: 'Thu·∫ø', icon: 'üí∞', color: 'blue' },
            { id: 'insurance', name: 'B·∫£o hi·ªÉm', icon: 'üè•', color: 'green' },
            { id: 'labor', name: 'Lao ƒë·ªông', icon: 'üë∑', color: 'orange' },
            { id: 'safety', name: 'An to√†n lao ƒë·ªông', icon: 'üõ°Ô∏è', color: 'red' },
            { id: 'environment', name: 'M√¥i tr∆∞·ªùng', icon: 'üåø', color: 'emerald' },
            { id: 'investment', name: 'ƒê·∫ßu t∆∞', icon: 'üìà', color: 'purple' },
            { id: 'report', name: 'B√°o c√°o', icon: 'üìä', color: 'indigo' },
            { id: 'license', name: 'Gi·∫•y ph√©p', icon: 'üìã', color: 'gray' },
            { id: 'holiday', name: 'Ngh·ªâ l·ªÖ', icon: 'üéâ', color: 'pink' }
        ];

        const FREQUENCIES = [
            { id: 'once', name: 'M·ªôt l·∫ßn (ng√†y c·ª• th·ªÉ)' },
            { id: 'monthly', name: 'H√†ng th√°ng' },
            { id: 'quarterly', name: 'H√†ng qu√Ω' },
            { id: 'yearly', name: 'H√†ng nƒÉm' }
        ];

        const NEWS_CATEGORIES = [
            { id: 'tax', name: 'Thu·∫ø' },
            { id: 'insurance', name: 'B·∫£o hi·ªÉm' },
            { id: 'labor', name: 'Lao ƒë·ªông' },
            { id: 'investment', name: 'ƒê·∫ßu t∆∞' },
            { id: 'environment', name: 'M√¥i tr∆∞·ªùng' },
            { id: 'other', name: 'Tin t·ª©c' }
        ];

        const AGENCY_CATEGORIES = [
            { id: 'government', name: 'C∆° quan Nh√† n∆∞·ªõc', icon: 'üèõÔ∏è' },
            { id: 'lawfirm', name: 'C√¥ng ty Lu·∫≠t / VP Lu·∫≠t s∆∞', icon: '‚öñÔ∏è' },
            { id: 'notary', name: 'VƒÉn ph√≤ng C√¥ng ch·ª©ng', icon: 'üìù' },
            { id: 'bailiff', name: 'VƒÉn ph√≤ng Th·ª´a ph√°t l·∫°i', icon: 'üìú' }
        ];

        // ========== AUTHENTICATION ==========
        function checkAuth() {
            if (!token) showLogin();
            else loadDashboard();
        }

        function showLogin() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-600 to-navy-800 p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-navy-600 to-navy-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <span class="text-white text-3xl font-bold">H</span>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900">HTIC Legal Admin</h1>
                            <p class="text-gray-500 mt-2">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n tr·ªã h·ªá th·ªëng</p>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="username" value="admin" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="password" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition" onkeypress="if(event.key==='Enter')login()">
                            </div>
                            <button onclick="login()" class="w-full bg-gradient-to-r from-navy-600 to-navy-700 text-white py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                                ƒêƒÉng nh·∫≠p
                            </button>
                        </div>
                        <p class="text-center text-gray-400 text-sm mt-6">¬© 2024 HTIC Law Firm - v10.0</p>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${API}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    loadDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loginError').textContent = 'L·ªói k·∫øt n·ªëi m√°y ch·ªß!';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // ========== DATA LOADING ==========
        async function loadDashboard() {
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="text-center">
                        <div class="animate-spin w-12 h-12 border-4 border-navy-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </div>
                </div>
            `;

            try {
                const [stats, events, news, agencies, provinces, settings, users, lawyers, payments] = await Promise.all([
                    fetch(`${API}/admin/stats`).then(r => r.json()),
                    fetch(`${API}/admin/events`).then(r => r.json()),
                    fetch(`${API}/admin/news`).then(r => r.json()),
                    fetch(`${API}/admin/agencies`).then(r => r.json()),
                    fetch(`${API}/admin/provinces`).then(r => r.json()),
                    fetch(`${API}/settings`).then(r => r.json()),
                    fetch(`${API}/admin/users`).then(r => r.json()).catch(() => ({ data: [] })),
                    fetch(`${API}/admin/lawyers`).then(r => r.json()).catch(() => ({ data: [] })),
                    fetch(`${API}/admin/payments`).then(r => r.json()).catch(() => ({ data: [] }))
                ]);

                allData = {
                    stats: stats.data || {},
                    events: events.data || [],
                    news: news.data || [],
                    agencies: agencies.data || [],
                    provinces: provinces.data || [],
                    settings: settings.data || {},
                    users: users.data || [],
                    lawyers: lawyers.data || [],
                    payments: payments.data || []
                };

                renderApp();
            } catch (e) {
                console.error(e);
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <p class="text-red-500 text-lg mb-4">L·ªói t·∫£i d·ªØ li·ªáu!</p>
                            <button onclick="loadDashboard()" class="px-6 py-3 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Th·ª≠ l·∫°i</button>
                        </div>
                    </div>
                `;
            }
        }

        // ========== MAIN APP RENDER ==========
        function renderApp() {
            const userCount = allData.users.length;
            const proCount = allData.users.filter(u => u.isPro).length;
            const pendingPayments = allData.payments.filter(p => p.status === 'pending').length;
            
            app.innerHTML = `
                <div class="flex min-h-screen">
                    <!-- Sidebar -->
                    <div class="w-64 bg-gradient-to-b from-navy-700 to-navy-800 text-white flex flex-col shadow-xl">
                        <div class="p-6 border-b border-navy-600">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <span class="font-bold text-lg">H</span>
                                </div>
                                <div>
                                    <h1 class="text-lg font-bold">HTIC Admin</h1>
                                    <p class="text-navy-100 text-xs">Phi√™n b·∫£n 10.0</p>
                                </div>
                            </div>
                        </div>
                        <nav class="flex-1 py-4 overflow-y-auto hide-scrollbar">
                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider">T·ªïng quan</p>
                            <div onclick="setSection('dashboard')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'dashboard' ? 'active' : ''}">
                                <span>üìä</span> <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">N·ªôi dung</p>
                            <div onclick="setSection('events')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'events' ? 'active' : ''}">
                                <span>üìÖ</span> <span>L·ªãch ph√°p l√Ω</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.events.length}</span>
                            </div>
                            <div onclick="setSection('news')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'news' ? 'active' : ''}">
                                <span>üì∞</span> <span>Tin t·ª©c</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.news.length}</span>
                            </div>
                            <div onclick="setSection('agencies')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'agencies' ? 'active' : ''}">
                                <span>üè¢</span> <span>C∆° quan / T·ªï ch·ª©c</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.agencies.length}</span>
                            </div>
                            <div onclick="setSection('provinces')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'provinces' ? 'active' : ''}">
                                <span>üó∫Ô∏è</span> <span>T·ªânh / Th√†nh ph·ªë</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.provinces.length}</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">Ng∆∞·ªùi d√πng</p>
                            <div onclick="setSection('users')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'users' ? 'active' : ''}">
                                <span>üë•</span> <span>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</span>
                                <span class="ml-auto bg-green-600 px-2 py-0.5 rounded-full text-xs">${userCount}</span>
                            </div>
                            <div onclick="setSection('lawyers')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'lawyers' ? 'active' : ''}">
                                <span>‚öñÔ∏è</span> <span>Qu·∫£n l√Ω lu·∫≠t s∆∞</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.lawyers.length}</span>
                            </div>
                            <div onclick="setSection('payments')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'payments' ? 'active' : ''}">
                                <span>üí≥</span> <span>Thanh to√°n Pro</span>
                                ${pendingPayments > 0 ? `<span class="ml-auto bg-orange-500 px-2 py-0.5 rounded-full text-xs animate-pulse">${pendingPayments}</span>` : ''}
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">H·ªá th·ªëng</p>
                            <div onclick="setSection('settings')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'settings' ? 'active' : ''}">
                                <span>‚öôÔ∏è</span> <span>C√†i ƒë·∫∑t</span>
                            </div>
                        </nav>
                        <div class="p-4 border-t border-navy-600">
                            <div class="flex items-center gap-3 mb-4 px-2">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-sm font-bold">A</div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium">Admin</p>
                                    <p class="text-xs text-navy-300">Qu·∫£n tr·ªã vi√™n</p>
                                </div>
                            </div>
                            <button onclick="logout()" class="w-full py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2">
                                <span>üö™</span> ƒêƒÉng xu·∫•t
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 overflow-auto bg-gray-50">
                        <div id="content" class="p-6"></div>
                    </div>
                </div>
            `;
            renderSection();
        }

        function setSection(section) {
            currentSection = section;
            renderApp();
        }

        function renderSection() {
            const content = document.getElementById('content');
            switch (currentSection) {
                case 'dashboard': renderDashboard(content); break;
                case 'events': renderEvents(content); break;
                case 'news': renderNews(content); break;
                case 'agencies': renderAgencies(content); break;
                case 'provinces': renderProvinces(content); break;
                case 'users': renderUsers(content); break;
                case 'lawyers': renderLawyers(content); break;
                case 'payments': renderPayments(content); break;
                case 'settings': renderSettings(content); break;
            }
        }

        // ========== DASHBOARD ==========
        function renderDashboard(el) {
            const s = allData.stats;
            const pendingPayments = allData.payments.filter(p => p.status === 'pending').length;
            const recentUsers = [...allData.users].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            
            el.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                    <p class="text-gray-500">T·ªïng quan h·ªá th·ªëng HTIC Legal App</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-blue-500 transition cursor-pointer" onclick="setSection('users')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Ng∆∞·ªùi d√πng</p>
                                <p class="text-3xl font-bold text-gray-900">${allData.users.length}</p>
                                <p class="text-xs text-purple-600 mt-1">${allData.users.filter(u => u.isPro).length} Pro users</p>
                            </div>
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">üë•</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-green-500 transition cursor-pointer" onclick="setSection('events')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">S·ª± ki·ªán ph√°p l√Ω</p>
                                <p class="text-3xl font-bold text-gray-900">${allData.events.length}</p>
                                <p class="text-xs text-green-600 mt-1">${allData.events.filter(e => e.isActive).length} ƒëang ho·∫°t ƒë·ªông</p>
                            </div>
                            <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center text-2xl">üìÖ</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-purple-500 transition cursor-pointer" onclick="setSection('news')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tin t·ª©c</p>
                                <p class="text-3xl font-bold text-gray-900">${allData.news.length}</p>
                                <p class="text-xs text-gray-400 mt-1">b√†i vi·∫øt</p>
                            </div>
                            <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">üì∞</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-orange-500 transition cursor-pointer" onclick="setSection('payments')">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Thanh to√°n</p>
                                <p class="text-3xl font-bold text-gray-900">${allData.payments.length}</p>
                                <p class="text-xs ${pendingPayments > 0 ? 'text-orange-600' : 'text-gray-400'} mt-1">${pendingPayments} ch·ªù x√°c nh·∫≠n</p>
                            </div>
                            <div class="w-14 h-14 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">üí≥</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-gray-900 mb-4">‚ö° Thao t√°c nhanh</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="setSection('events'); setTimeout(() => showEventModal(), 100)" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition flex items-center gap-2">
                            <span>üìÖ</span> Th√™m s·ª± ki·ªán
                        </button>
                        <button onclick="setSection('news'); setTimeout(() => showNewsModal(), 100)" class="px-4 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition flex items-center gap-2">
                            <span>üì∞</span> Th√™m tin t·ª©c
                        </button>
                        <button onclick="setSection('lawyers'); setTimeout(() => showLawyerModal(), 100)" class="px-4 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition flex items-center gap-2">
                            <span>‚öñÔ∏è</span> Th√™m lu·∫≠t s∆∞
                        </button>
                        <button onclick="setSection('agencies'); setTimeout(() => showAgencyModal(), 100)" class="px-4 py-2 bg-orange-50 text-orange-600 rounded-lg hover:bg-orange-100 transition flex items-center gap-2">
                            <span>üè¢</span> Th√™m c∆° quan
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-4 border-b flex items-center justify-between">
                            <h3 class="font-bold text-gray-900">üë• Ng∆∞·ªùi d√πng m·ªõi ƒëƒÉng k√Ω</h3>
                            <button onclick="setSection('users')" class="text-sm text-blue-600 hover:underline">Xem t·∫•t c·∫£</button>
                        </div>
                        <div class="p-4 space-y-3">
                            ${recentUsers.length > 0 ? recentUsers.map(u => `
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                                        ${(u.name || u.email || '?')[0].toUpperCase()}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-gray-900 truncate">${u.name || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                                        <p class="text-sm text-gray-500 truncate">${u.email}</p>
                                    </div>
                                    ${u.isPro ? '<span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full font-bold">PRO</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">Free</span>'}
                                </div>
                            `).join('') : '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ ng∆∞·ªùi d√πng</p>'}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-4 border-b"><h3 class="font-bold text-gray-900">üì∞ Tin t·ª©c m·ªõi nh·∫•t</h3></div>
                        <div class="p-4 space-y-3">
                            ${[...allData.news].sort((a, b) => b.id - a.id).slice(0, 5).map(n => `
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="w-12 h-12 bg-gray-200 rounded-lg bg-cover bg-center" style="background-image: url('${n.image || n.imageUrl || ''}')"></div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-gray-900 truncate">${n.title}</p>
                                        <p class="text-sm text-gray-500">${n.category} ‚Ä¢ ${n.date}</p>
                                    </div>
                                    ${n.isHot ? '<span class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full">üî•</span>' : ''}
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ tin t·ª©c</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== USERS MANAGEMENT ==========
        function renderUsers(el) {
            const sortedUsers = [...allData.users].sort((a, b) => b.id - a.id);
            const todayUsers = allData.users.filter(u => u.createdAt && u.createdAt.startsWith(new Date().toISOString().split('T')[0])).length;
            
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.users.length} ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng k√Ω</p>
                    </div>
                    <button onclick="exportUsers()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>üì•</span> Xu·∫•t Excel
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">T·ªïng ng∆∞·ªùi d√πng</p>
                        <p class="text-2xl font-bold text-gray-900">${allData.users.length}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Pro Users</p>
                        <p class="text-2xl font-bold text-purple-600">${allData.users.filter(u => u.isPro).length}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">Free Users</p>
                        <p class="text-2xl font-bold text-gray-600">${allData.users.filter(u => !u.isPro).length}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm">
                        <p class="text-gray-500 text-sm">ƒêƒÉng k√Ω h√¥m nay</p>
                        <p class="text-2xl font-bold text-green-600">${todayUsers}</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ID</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Th√¥ng tin</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">C√¥ng ty</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ƒêi·ªán tho·∫°i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Lo·∫°i TK</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng√†y ƒêK</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${sortedUsers.map(u => `
                                <tr class="table-row transition">
                                    <td class="px-4 py-3 font-mono text-sm text-gray-500">#${u.id}</td>
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                                                ${(u.name || u.email || '?')[0].toUpperCase()}
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-900">${u.name || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                                                <p class="text-sm text-gray-500">${u.email}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${u.company || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${u.phone || '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        ${u.isPro 
                                            ? '<span class="px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs rounded-full font-bold">‚≠ê PRO</span>' 
                                            : '<span class="px-3 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">Free</span>'}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${u.createdAt ? new Date(u.createdAt).toLocaleDateString('vi-VN') : '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showUserDetail(${JSON.stringify(u).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-2 text-sm">Chi ti·∫øt</button>
                                        <button onclick="toggleUserPro(${u.id}, ${!u.isPro})" class="text-purple-600 hover:text-purple-800 text-sm">${u.isPro ? 'H·ªßy Pro' : 'N√¢ng Pro'}</button>
                                    </td>
                                </tr>
                                `).join('')}
                                ${allData.users.length === 0 ? '<tr><td colspan="7" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showUserDetail(user) {
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-t-2xl">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold">
                                    ${(user.name || user.email || '?')[0].toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold">${user.name || 'Ch∆∞a c·∫≠p nh·∫≠t'}</h3>
                                    <p class="text-blue-100">${user.email}</p>
                                </div>
                                <button onclick="closeModal()" class="ml-auto text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">ID</p>
                                    <p class="font-semibold">#${user.id}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">Lo·∫°i t√†i kho·∫£n</p>
                                    <p class="font-semibold">${user.isPro ? '‚≠ê Pro' : 'Free'}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">ƒêi·ªán tho·∫°i</p>
                                    <p class="font-semibold">${user.phone || '-'}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">ƒêƒÉng k√Ω qua</p>
                                    <p class="font-semibold">${user.provider || 'Email'}</p>
                                </div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">C√¥ng ty</p>
                                <p class="font-semibold">${user.company || '-'}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">M√£ s·ªë thu·∫ø</p>
                                <p class="font-semibold">${user.taxCode || '-'}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">ƒê·ªãa ch·ªâ</p>
                                <p class="font-semibold">${user.address || '-'}</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Ng√†nh ngh·ªÅ</p>
                                <p class="font-semibold">${user.industry || '-'}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">Ng√†y ƒëƒÉng k√Ω</p>
                                    <p class="font-semibold">${user.createdAt ? new Date(user.createdAt).toLocaleString('vi-VN') : '-'}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">Pro h·∫øt h·∫°n</p>
                                    <p class="font-semibold">${user.proExpiry || '-'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">ƒê√≥ng</button>
                            <button onclick="toggleUserPro(${user.id}, ${!user.isPro}); closeModal();" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${user.isPro ? 'H·ªßy Pro' : 'N√¢ng c·∫•p Pro'}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function toggleUserPro(userId, isPro) {
            try {
                const proExpiry = isPro ? new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] : null;
                await fetch(`${API}/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isPro, proExpiry })
                });
                loadDashboard();
            } catch (e) {
                alert('L·ªói c·∫≠p nh·∫≠t!');
            }
        }

        function exportUsers() {
            let csv = 'ID,T√™n,Email,ƒêi·ªán tho·∫°i,C√¥ng ty,M√£ s·ªë thu·∫ø,ƒê·ªãa ch·ªâ,Ng√†nh ngh·ªÅ,Pro,Ng√†y ƒêK\n';
            allData.users.forEach(u => {
                csv += `${u.id},"${u.name || ''}","${u.email}","${u.phone || ''}","${u.company || ''}","${u.taxCode || ''}","${u.address || ''}","${u.industry || ''}",${u.isPro ? 'C√≥' : 'Kh√¥ng'},"${u.createdAt || ''}"\n`;
            });
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ========== LAWYERS MANAGEMENT ==========
        function renderLawyers(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Qu·∫£n l√Ω lu·∫≠t s∆∞</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.lawyers.length} lu·∫≠t s∆∞ t∆∞ v·∫•n</p>
                    </div>
                    <button onclick="showLawyerModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m lu·∫≠t s∆∞
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Lu·∫≠t s∆∞</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ch·ª©c danh</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Chuy√™n m√¥n</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Li√™n h·ªá</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Tr·∫°ng th√°i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.lawyers.map(l => `
                                <tr class="table-row transition">
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white font-bold">
                                                ${(l.name || '?')[0]}
                                            </div>
                                            <div>
                                                <p class="font-medium text-gray-900">${l.name}</p>
                                                ${l.isPrimary ? '<span class="text-xs text-orange-600">‚≠ê Ch√≠nh</span>' : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${l.title || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">${l.specialty || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${l.phone || '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        <span class="px-2 py-1 ${l.isAvailable ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'} text-xs rounded-full">
                                            ${l.isAvailable ? '‚úì S·∫µn s√†ng' : '‚óã B·∫≠n'}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showLawyerModal(${JSON.stringify(l).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-2 text-sm">S·ª≠a</button>
                                        <button onclick="deleteLawyer(${l.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                    </td>
                                </tr>
                                `).join('')}
                                ${allData.lawyers.length === 0 ? '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ lu·∫≠t s∆∞ n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showLawyerModal(lawyer = null) {
            const isEdit = !!lawyer;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a lu·∫≠t s∆∞' : 'Th√™m lu·∫≠t s∆∞ m·ªõi'}</h3>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">H·ªç t√™n <span class="text-red-500">*</span></label>
                                <input type="text" id="lawyerName" value="${lawyer?.name || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="VD: Lu·∫≠t s∆∞ Nguy·ªÖn VƒÉn A">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ch·ª©c danh</label>
                                <input type="text" id="lawyerTitle" value="${lawyer?.title || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="VD: Lu·∫≠t s∆∞ ƒëi·ªÅu h√†nh">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Chuy√™n m√¥n</label>
                                <input type="text" id="lawyerSpecialty" value="${lawyer?.specialty || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="VD: Doanh nghi·ªáp, Thu·∫ø, ƒê·∫ßu t∆∞">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="text" id="lawyerPhone" value="${lawyer?.phone || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Zalo</label>
                                    <input type="text" id="lawyerZalo" value="${lawyer?.zalo || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                <input type="email" id="lawyerEmail" value="${lawyer?.email || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Kinh nghi·ªám</label>
                                <input type="text" id="lawyerExperience" value="${lawyer?.experience || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="VD: 15 nƒÉm">
                            </div>
                            <div class="flex items-center gap-6 p-4 bg-gray-50 rounded-xl">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="lawyerAvailable" ${lawyer?.isAvailable !== false ? 'checked' : ''} class="w-5 h-5 accent-purple-600">
                                    <span class="text-sm font-semibold text-gray-700">S·∫µn s√†ng t∆∞ v·∫•n</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="lawyerPrimary" ${lawyer?.isPrimary ? 'checked' : ''} class="w-5 h-5 accent-orange-500">
                                    <span class="text-sm font-semibold text-gray-700">‚≠ê Lu·∫≠t s∆∞ ch√≠nh</span>
                                </label>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveLawyer(${lawyer?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveLawyer(id) {
            const data = {
                name: document.getElementById('lawyerName').value,
                title: document.getElementById('lawyerTitle').value,
                specialty: document.getElementById('lawyerSpecialty').value,
                phone: document.getElementById('lawyerPhone').value,
                zalo: document.getElementById('lawyerZalo').value,
                email: document.getElementById('lawyerEmail').value,
                experience: document.getElementById('lawyerExperience').value,
                isAvailable: document.getElementById('lawyerAvailable').checked,
                isPrimary: document.getElementById('lawyerPrimary').checked
            };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p h·ªç t√™n!'); return; }
            const url = id ? `${API}/admin/lawyers/${id}` : `${API}/admin/lawyers`;
            const method = id ? 'PUT' : 'POST';
            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteLawyer(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a lu·∫≠t s∆∞ n√†y?')) return;
            try {
                await fetch(`${API}/admin/lawyers/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('L·ªói x√≥a d·ªØ li·ªáu!'); }
        }

        // ========== PAYMENTS MANAGEMENT ==========
        function renderPayments(el) {
            const sortedPayments = [...allData.payments].sort((a, b) => b.id - a.id);
            const pending = sortedPayments.filter(p => p.status === 'pending');
            const completed = sortedPayments.filter(p => p.status === 'completed');
            const totalRevenue = completed.reduce((sum, p) => sum + (p.amount || 0), 0);
            
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Qu·∫£n l√Ω thanh to√°n Pro</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.payments.length} giao d·ªãch</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-orange-500">
                        <p class="text-gray-500 text-sm">Ch·ªù x√°c nh·∫≠n</p>
                        <p class="text-2xl font-bold text-orange-600">${pending.length}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-sm">ƒê√£ ho√†n th√†nh</p>
                        <p class="text-2xl font-bold text-green-600">${completed.length}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-purple-500">
                        <p class="text-gray-500 text-sm">T·ªïng doanh thu</p>
                        <p class="text-2xl font-bold text-purple-600">${totalRevenue.toLocaleString('vi-VN')}ƒë</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">M√£ ƒë∆°n</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng∆∞·ªùi d√πng</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">G√≥i</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">S·ªë ti·ªÅn</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Tr·∫°ng th√°i</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng√†y t·∫°o</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${sortedPayments.map(p => {
                                    const user = allData.users.find(u => u.id === p.userId) || {};
                                    return `
                                    <tr class="table-row transition ${p.status === 'pending' ? 'bg-orange-50' : ''}">
                                        <td class="px-4 py-3 font-mono text-sm">${p.orderId || '#' + p.id}</td>
                                        <td class="px-4 py-3">
                                            <p class="font-medium text-gray-900">${user.name || user.email || 'ID: ' + p.userId}</p>
                                            <p class="text-sm text-gray-500">${user.email || ''}</p>
                                        </td>
                                        <td class="px-4 py-3 text-sm">
                                            <span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full">${p.package === 'monthly' ? 'Th√°ng' : p.package === 'yearly' ? 'NƒÉm' : 'Tr·ªçn ƒë·ªùi'}</span>
                                        </td>
                                        <td class="px-4 py-3 text-right font-semibold text-gray-900">${(p.amount || 0).toLocaleString('vi-VN')}ƒë</td>
                                        <td class="px-4 py-3 text-center">
                                            ${p.status === 'completed' 
                                                ? '<span class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full">‚úì Ho√†n th√†nh</span>'
                                                : p.status === 'pending'
                                                ? '<span class="px-2 py-1 bg-orange-100 text-orange-600 text-xs rounded-full animate-pulse">‚è≥ Ch·ªù x√°c nh·∫≠n</span>'
                                                : '<span class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full">‚úó H·ªßy</span>'}
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${p.createdAt ? new Date(p.createdAt).toLocaleString('vi-VN') : '-'}</td>
                                        <td class="px-4 py-3 text-center">
                                            ${p.status === 'pending' 
                                                ? `<button onclick="confirmPayment(${p.id})" class="px-3 py-1 bg-green-500 text-white text-xs rounded-lg hover:bg-green-600">X√°c nh·∫≠n</button>`
                                                : '<span class="text-gray-400 text-sm">-</span>'}
                                        </td>
                                    </tr>`;
                                }).join('')}
                                ${allData.payments.length === 0 ? '<tr><td colspan="7" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ giao d·ªãch n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function confirmPayment(paymentId) {
            if (!confirm('X√°c nh·∫≠n thanh to√°n n√†y? User s·∫Ω ƒë∆∞·ª£c n√¢ng c·∫•p Pro.')) return;
            try {
                await fetch(`${API}/admin/payments/${paymentId}/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transactionId: 'MANUAL-' + Date.now() })
                });
                alert('‚úì ƒê√£ x√°c nh·∫≠n thanh to√°n th√†nh c√¥ng!');
                loadDashboard();
            } catch (e) {
                alert('L·ªói x√°c nh·∫≠n thanh to√°n!');
            }
        }

        // ========== SETTINGS ==========
        let settingsTab = 'company';
        
        function renderSettings(el) {
            const s = allData.settings || {};
            el.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                    <p class="text-gray-500">C·∫•u h√¨nh th√¥ng tin c√¥ng ty v√† ·ª©ng d·ª•ng</p>
                </div>

                <!-- Tabs -->
                <div class="flex gap-2 mb-6 bg-gray-200 p-1 rounded-xl flex-wrap">
                    <button onclick="showSettingsTab('company')" class="tab-btn flex-1 py-2 px-4 rounded-lg font-medium text-sm ${settingsTab === 'company' ? 'active' : ''}">üè¢ C√¥ng ty</button>
                    <button onclick="showSettingsTab('splash')" class="tab-btn flex-1 py-2 px-4 rounded-lg font-medium text-sm ${settingsTab === 'splash' ? 'active' : ''}">üé® Logo Splash</button>
                    <button onclick="showSettingsTab('legal')" class="tab-btn flex-1 py-2 px-4 rounded-lg font-medium text-sm ${settingsTab === 'legal' ? 'active' : ''}">üìú ƒêi·ªÅu kho·∫£n</button>
                    <button onclick="showSettingsTab('payment')" class="tab-btn flex-1 py-2 px-4 rounded-lg font-medium text-sm ${settingsTab === 'payment' ? 'active' : ''}">üí≥ Thanh to√°n</button>
                </div>

                <div id="settingsContent"></div>
            `;
            showSettingsTab(settingsTab);
        }

        function showSettingsTab(tab) {
            settingsTab = tab;
            const content = document.getElementById('settingsContent');
            const s = allData.settings || {};
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-btn')[['company', 'splash', 'legal', 'payment'].indexOf(tab)]?.classList.add('active');

            switch (tab) {
                case 'company':
                    content.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>üè¢</span> Th√¥ng tin c√¥ng ty</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n c√¥ng ty</label>
                                    <input type="text" id="settingCompanyName" value="${s.companyName || 'HTIC LAW FIRM'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
                                    <input type="text" id="settingWebsite" value="${s.website || 'www.htic.com.vn'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Hotline</label>
                                    <input type="text" id="settingPhone" value="${s.phone || '0379 044 299'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email li√™n h·ªá</label>
                                    <input type="text" id="settingEmail" value="${s.email || 'contact@htic.com.vn'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</label>
                                    <textarea id="settingAddress" rows="2" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">${s.address || 'H√† N·ªôi, Vi·ªát Nam'}</textarea>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button onclick="saveCompanySettings()" class="px-8 py-3 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg flex items-center gap-2">
                                    <span>üíæ</span> L∆∞u c√†i ƒë·∫∑t
                                </button>
                            </div>
                        </div>
                    `;
                    break;

                case 'splash':
                    content.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>üé®</span> Logo m√†n h√¨nh kh·ªüi ƒë·ªông</h3>
                            <p class="text-gray-500 text-sm mb-6">C·∫≠p nh·∫≠t logo hi·ªÉn th·ªã tr√™n m√†n h√¨nh splash khi m·ªü app</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center">
                                    <p class="font-semibold text-gray-700 mb-4">Logo hi·ªán t·∫°i</p>
                                    <div class="mb-4">
                                        ${s.splashLogo 
                                            ? `<img src="${s.splashLogo}" class="max-w-48 max-h-48 mx-auto rounded-xl shadow-lg" alt="Splash Logo">`
                                            : '<div class="w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl mx-auto flex items-center justify-center text-white text-4xl font-bold shadow-lg">H</div>'}
                                    </div>
                                    <p class="text-xs text-gray-400">PNG/JPG, khuy·∫øn ngh·ªã 512x512px</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">URL Logo m·ªõi</label>
                                    <input type="text" id="settingSplashLogo" value="${s.splashLogo || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition mb-4" placeholder="https://example.com/logo.png">
                                    
                                    <p class="text-sm text-gray-500 mb-2">Ho·∫∑c s·ª≠ d·ª•ng Base64:</p>
                                    <textarea id="settingSplashLogoBase64" rows="4" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition text-xs" placeholder="data:image/png;base64,...">${s.splashLogo?.startsWith('data:') ? s.splashLogo : ''}</textarea>
                                    
                                    <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                                        <p class="text-sm text-blue-800"><strong>üí° H∆∞·ªõng d·∫´n:</strong></p>
                                        <ul class="text-xs text-blue-700 mt-2 space-y-1">
                                            <li>‚Ä¢ S·ª≠ d·ª•ng ·∫£nh PNG v·ªõi n·ªÅn trong su·ªët</li>
                                            <li>‚Ä¢ K√≠ch th∆∞·ªõc khuy·∫øn ngh·ªã: 512x512 pixels</li>
                                            <li>‚Ä¢ Dung l∆∞·ª£ng t·ªëi ƒëa: 2MB</li>
                                            <li>‚Ä¢ App s·∫Ω t·∫£i logo t·ª´ URL ho·∫∑c Base64</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end">
                                <button onclick="saveSplashSettings()" class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg flex items-center gap-2">
                                    <span>üíæ</span> L∆∞u logo
                                </button>
                            </div>
                        </div>
                    `;
                    break;

                case 'legal':
                    content.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>üìú</span> ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng & Ch√≠nh s√°ch b·∫£o m·∫≠t</h3>
                            
                            <div class="flex gap-2 mb-4">
                                <button onclick="showLegalTab('tos')" id="tosTabBtn" class="px-4 py-2 bg-navy-600 text-white rounded-lg text-sm font-medium">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</button>
                                <button onclick="showLegalTab('privacy')" id="privacyTabBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">Ch√≠nh s√°ch b·∫£o m·∫≠t</button>
                            </div>

                            <div id="tosContent">
                                <div id="tosEditor"></div>
                            </div>
                            <div id="privacyContent" class="hidden">
                                <div id="privacyEditor"></div>
                            </div>

                            <div class="mt-6 flex justify-between items-center">
                                <button onclick="previewLegal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium flex items-center gap-2">
                                    <span>üëÅÔ∏è</span> Xem tr∆∞·ªõc
                                </button>
                                <button onclick="saveLegalSettings()" class="px-8 py-3 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg flex items-center gap-2">
                                    <span>üíæ</span> L∆∞u ƒëi·ªÅu kho·∫£n
                                </button>
                            </div>
                        </div>
                    `;
                    setTimeout(() => initLegalEditors(), 100);
                    break;

                case 'payment':
                    content.innerHTML = `
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>üí≥</span> Th√¥ng tin thanh to√°n</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n ng√¢n h√†ng</label>
                                    <input type="text" id="settingBankName" value="${s.bankName || 'Vietcombank'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Chi nh√°nh</label>
                                    <input type="text" id="settingBankBranch" value="${s.bankBranch || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">S·ªë t√†i kho·∫£n</label>
                                    <input type="text" id="settingBankAccount" value="${s.bankAccount || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n t√†i kho·∫£n</label>
                                    <input type="text" id="settingBankAccountName" value="${s.bankAccountName || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">N·ªôi dung chuy·ªÉn kho·∫£n</label>
                                    <input type="text" id="settingTransferContent" value="${s.transferContent || 'HTIC PRO [M√£ ƒë∆°n h√†ng]'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button onclick="savePaymentSettings()" class="px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg flex items-center gap-2">
                                    <span>üíæ</span> L∆∞u th√¥ng tin
                                </button>
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        let currentLegalTab = 'tos';
        let tosQuill = null;
        let privacyQuill = null;

        function initLegalEditors() {
            const s = allData.settings || {};
            tosQuill = new Quill('#tosEditor', {
                theme: 'snow',
                placeholder: 'Nh·∫≠p n·ªôi dung ƒëi·ªÅu kho·∫£n s·ª≠ d·ª•ng...',
                modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean']] }
            });
            if (s.termsOfService) tosQuill.root.innerHTML = s.termsOfService;

            privacyQuill = new Quill('#privacyEditor', {
                theme: 'snow',
                placeholder: 'Nh·∫≠p n·ªôi dung ch√≠nh s√°ch b·∫£o m·∫≠t...',
                modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean']] }
            });
            if (s.privacyPolicy) privacyQuill.root.innerHTML = s.privacyPolicy;
        }

        function showLegalTab(tab) {
            currentLegalTab = tab;
            document.getElementById('tosTabBtn').className = tab === 'tos' ? 'px-4 py-2 bg-navy-600 text-white rounded-lg text-sm font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium';
            document.getElementById('privacyTabBtn').className = tab === 'privacy' ? 'px-4 py-2 bg-navy-600 text-white rounded-lg text-sm font-medium' : 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium';
            document.getElementById('tosContent').className = tab === 'tos' ? '' : 'hidden';
            document.getElementById('privacyContent').className = tab === 'privacy' ? '' : 'hidden';
        }

        function previewLegal() {
            const content = currentLegalTab === 'tos' ? (tosQuill?.root.innerHTML || '') : (privacyQuill?.root.innerHTML || '');
            const title = currentLegalTab === 'tos' ? 'ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng' : 'Ch√≠nh s√°ch b·∫£o m·∫≠t';
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-navy-700 text-white rounded-t-2xl flex items-center justify-between">
                            <h3 class="text-xl font-bold">üìú ${title}</h3>
                            <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div class="p-6 prose max-w-none">${content || '<p class="text-gray-400">Ch∆∞a c√≥ n·ªôi dung</p>'}</div>
                    </div>
                </div>
            `;
        }

        async function saveCompanySettings() {
            const data = {
                companyName: document.getElementById('settingCompanyName').value,
                website: document.getElementById('settingWebsite').value,
                phone: document.getElementById('settingPhone').value,
                email: document.getElementById('settingEmail').value,
                address: document.getElementById('settingAddress').value
            };
            await saveSettings(data);
        }

        async function saveSplashSettings() {
            const urlLogo = document.getElementById('settingSplashLogo').value.trim();
            const base64Logo = document.getElementById('settingSplashLogoBase64').value.trim();
            const data = { splashLogo: base64Logo || urlLogo };
            await saveSettings(data);
        }

        async function saveLegalSettings() {
            const data = {
                termsOfService: tosQuill?.root.innerHTML || '',
                privacyPolicy: privacyQuill?.root.innerHTML || ''
            };
            await saveSettings(data);
        }

        async function savePaymentSettings() {
            const data = {
                bankName: document.getElementById('settingBankName').value,
                bankBranch: document.getElementById('settingBankBranch').value,
                bankAccount: document.getElementById('settingBankAccount').value,
                bankAccountName: document.getElementById('settingBankAccountName').value,
                transferContent: document.getElementById('settingTransferContent').value
            };
            await saveSettings(data);
        }

        async function saveSettings(data) {
            try {
                await fetch(`${API}/admin/settings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                alert('‚úì ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!');
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u c√†i ƒë·∫∑t!'); }
        }

        // ========== EVENTS ==========
        function renderEvents(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">L·ªãch ph√°p l√Ω</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.events.length} s·ª± ki·ªán ph√°p l√Ω</p>
                    </div>
                    <button onclick="showEventModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m s·ª± ki·ªán
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Danh m·ª•c</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T·∫ßn su·∫•t</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng√†y</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Tr·∫°ng th√°i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.events.map(e => {
                                    const cat = CATEGORIES.find(c => c.id === e.category) || {};
                                    return `
                                    <tr class="table-row transition">
                                        <td class="px-4 py-3">
                                            <p class="font-medium text-gray-900">${e.title}</p>
                                            <p class="text-sm text-gray-500 truncate max-w-xs">${stripHtml(e.description || '')}</p>
                                        </td>
                                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full">${cat.icon || ''} ${cat.name || e.category}</span></td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${getFrequencyName(e.frequency)}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${e.specificDate || (e.dayOfMonth ? 'Ng√†y ' + e.dayOfMonth : '-')}</td>
                                        <td class="px-4 py-3 text-center"><span class="px-2 py-1 ${e.isActive ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'} text-xs rounded-full">${e.isActive ? '‚úì Hi·ªán' : '‚óã ·∫®n'}</span></td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick='showEventModal(${JSON.stringify(e).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-3 text-sm">S·ª≠a</button>
                                            <button onclick="deleteEvent(${e.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                                ${allData.events.length === 0 ? '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ s·ª± ki·ªán n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showEventModal(event = null) {
            const isEdit = !!event;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a s·ª± ki·ªán' : 'Th√™m s·ª± ki·ªán m·ªõi'}</h3>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ti√™u ƒë·ªÅ s·ª± ki·ªán <span class="text-red-500">*</span></label>
                                <input type="text" id="eventTitle" value="${event?.title || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Danh m·ª•c</label>
                                    <select id="eventCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                        ${CATEGORIES.map(c => `<option value="${c.id}" ${event?.category === c.id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T·∫ßn su·∫•t</label>
                                    <select id="eventFrequency" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                        ${FREQUENCIES.map(f => `<option value="${f.id}" ${event?.frequency === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ng√†y trong th√°ng</label>
                                    <input type="number" id="eventDayOfMonth" min="1" max="31" value="${event?.dayOfMonth || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ho·∫∑c ng√†y c·ª• th·ªÉ</label>
                                    <input type="date" id="eventSpecificDate" value="${event?.specificDate || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M√¥ t·∫£ chi ti·∫øt</label>
                                <div id="eventDescriptionEditor"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">CƒÉn c·ª© ph√°p l√Ω</label>
                                <input type="text" id="eventLegalRef" value="${event?.legalReference || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M·ª©c ph·∫°t n·∫øu vi ph·∫°m</label>
                                <input type="text" id="eventPenalty" value="${event?.penalty || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                            </div>
                            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                                <input type="checkbox" id="eventIsActive" ${event?.isActive !== false ? 'checked' : ''} class="w-5 h-5 accent-navy-600">
                                <label class="text-sm font-semibold text-gray-700">Hi·ªÉn th·ªã trong ·ª©ng d·ª•ng</label>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveEvent(${event?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                quillEditor = new Quill('#eventDescriptionEditor', { theme: 'snow', placeholder: 'Nh·∫≠p m√¥ t·∫£...', modules: { toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean']] } });
                if (event?.description) quillEditor.root.innerHTML = event.description;
            }, 100);
        }

        async function saveEvent(id) {
            const data = {
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                frequency: document.getElementById('eventFrequency').value,
                dayOfMonth: parseInt(document.getElementById('eventDayOfMonth').value) || null,
                specificDate: document.getElementById('eventSpecificDate').value || null,
                description: quillEditor ? quillEditor.root.innerHTML : '',
                legalReference: document.getElementById('eventLegalRef').value,
                penalty: document.getElementById('eventPenalty').value,
                isActive: document.getElementById('eventIsActive').checked
            };
            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!'); return; }
            const url = id ? `${API}/admin/events/${id}` : `${API}/admin/events`;
            try {
                await fetch(url, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteEvent(id) {
            if (!confirm('X√≥a s·ª± ki·ªán n√†y?')) return;
            try { await fetch(`${API}/admin/events/${id}`, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); }
        }

        // ========== NEWS ==========
        function renderNews(el) {
            const sortedNews = [...allData.news].sort((a, b) => b.id - a.id);
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Tin t·ª©c ph√°p lu·∫≠t</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.news.length} b√†i vi·∫øt</p>
                    </div>
                    <button onclick="showNewsModal()" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m tin t·ª©c
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-16">·∫¢nh</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Danh m·ª•c</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Ng√†y ƒëƒÉng</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-20">N·ªïi b·∫≠t</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-28">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${sortedNews.map(n => `
                                <tr class="table-row transition">
                                    <td class="px-4 py-3"><div class="w-14 h-14 bg-gray-200 rounded-lg bg-cover bg-center" style="background-image: url('${n.image || n.imageUrl || ''}')"></div></td>
                                    <td class="px-4 py-3">
                                        <p class="font-medium text-gray-900 line-clamp-1">${n.title}</p>
                                        <p class="text-sm text-gray-500 line-clamp-1">${stripHtml(n.summary || n.content || '')}</p>
                                    </td>
                                    <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full">${n.category}</span></td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${n.date}</td>
                                    <td class="px-4 py-3 text-center">${n.isHot ? '<span class="px-2 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full">üî•</span>' : '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showNewsModal(${JSON.stringify(n).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-2 text-sm">S·ª≠a</button>
                                        <button onclick="deleteNews(${n.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                    </td>
                                </tr>
                                `).join('')}
                                ${allData.news.length === 0 ? '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ tin t·ª©c</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showNewsModal(news = null) {
            const isEdit = !!news;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-green-500 to-green-600 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a tin t·ª©c' : 'Th√™m tin t·ª©c m·ªõi'}</h3>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ti√™u ƒë·ªÅ <span class="text-red-500">*</span></label>
                                <input type="text" id="newsTitle" value="${news?.title || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Danh m·ª•c</label>
                                    <select id="newsCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">
                                        ${NEWS_CATEGORIES.map(c => `<option value="${c.id}" ${news?.category === c.id || news?.category === c.name ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ng√†y ƒëƒÉng</label>
                                    <input type="date" id="newsDate" value="${news?.date ? formatDateForInput(news.date) : new Date().toISOString().split('T')[0]}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Link ·∫£nh ƒë·∫°i di·ªán</label>
                                <input type="text" id="newsImage" value="${news?.image || news?.imageUrl || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="https://...">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√≥m t·∫Øt</label>
                                <textarea id="newsSummary" rows="2" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">${news?.summary || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">N·ªôi dung</label>
                                <div id="newsContentEditor"></div>
                            </div>
                            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                                <input type="checkbox" id="newsIsHot" ${news?.isHot ? 'checked' : ''} class="w-5 h-5 accent-orange-500">
                                <label class="text-sm font-semibold text-gray-700">üî• Tin n·ªïi b·∫≠t</label>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveNews(${news?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'ƒêƒÉng b√†i'}</button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => {
                quillEditor = new Quill('#newsContentEditor', { theme: 'snow', placeholder: 'Nh·∫≠p n·ªôi dung...', modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link', 'image'], ['clean']] } });
                if (news?.content) quillEditor.root.innerHTML = news.content;
            }, 100);
        }

        function formatDateForInput(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length === 3) return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            try { return new Date(dateStr).toISOString().split('T')[0]; } catch { return ''; }
        }

        async function saveNews(id) {
            const dateInput = document.getElementById('newsDate').value;
            const dateParts = dateInput.split('-');
            const formattedDate = dateParts.length === 3 ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : dateInput;
            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                date: formattedDate,
                summary: document.getElementById('newsSummary').value,
                content: quillEditor ? quillEditor.root.innerHTML : '',
                image: document.getElementById('newsImage').value,
                imageUrl: document.getElementById('newsImage').value,
                isHot: document.getElementById('newsIsHot').checked
            };
            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!'); return; }
            const url = id ? `${API}/admin/news/${id}` : `${API}/admin/news`;
            try {
                await fetch(url, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteNews(id) {
            if (!confirm('X√≥a tin t·ª©c n√†y?')) return;
            try { await fetch(`${API}/admin/news/${id}`, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); }
        }

        // ========== AGENCIES ==========
        function renderAgencies(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Danh b·∫° c∆° quan / T·ªï ch·ª©c</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.agencies.length} ƒë∆°n v·ªã</p>
                    </div>
                    <button onclick="showAgencyModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m c∆° quan
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T√™n c∆° quan</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Lo·∫°i h√¨nh</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T·ªânh/TP</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ƒêi·ªán tho·∫°i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.agencies.map(a => {
                                    const cat = AGENCY_CATEGORIES.find(c => c.id === a.category) || {};
                                    const province = allData.provinces.find(p => p.id === a.provinceId) || {};
                                    return `
                                    <tr class="table-row transition">
                                        <td class="px-4 py-3"><p class="font-medium text-gray-900">${a.name}</p></td>
                                        <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full">${cat.icon || ''} ${cat.name || a.category}</span></td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${province.name || a.provinceId || '-'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${a.phone || '-'}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick='showAgencyModal(${JSON.stringify(a).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-3 text-sm">S·ª≠a</button>
                                            <button onclick="deleteAgency(${a.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                                ${allData.agencies.length === 0 ? '<tr><td colspan="5" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ c∆° quan n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showAgencyModal(agency = null) {
            const isEdit = !!agency;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a c∆° quan' : 'Th√™m c∆° quan m·ªõi'}</h3>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n c∆° quan <span class="text-red-500">*</span></label>
                                <input type="text" id="agencyName" value="${agency?.name || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Lo·∫°i h√¨nh</label>
                                    <select id="agencyCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                        ${AGENCY_CATEGORIES.map(c => `<option value="${c.id}" ${agency?.category === c.id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T·ªânh / Th√†nh ph·ªë</label>
                                    <select id="agencyProvince" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                        <option value="">-- Ch·ªçn --</option>
                                        ${allData.provinces.map(p => `<option value="${p.id}" ${agency?.provinceId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</label>
                                <input type="text" id="agencyAddress" value="${agency?.address || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ƒêi·ªán tho·∫°i</label>
                                    <input type="text" id="agencyPhone" value="${agency?.phone || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
                                    <input type="text" id="agencyWebsite" value="${agency?.website || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveAgency(${agency?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveAgency(id) {
            const data = {
                name: document.getElementById('agencyName').value,
                category: document.getElementById('agencyCategory').value,
                provinceId: document.getElementById('agencyProvince').value,
                address: document.getElementById('agencyAddress').value,
                phone: document.getElementById('agencyPhone').value,
                website: document.getElementById('agencyWebsite').value
            };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p t√™n!'); return; }
            const url = id ? `${API}/admin/agencies/${id}` : `${API}/admin/agencies`;
            try {
                await fetch(url, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteAgency(id) {
            if (!confirm('X√≥a c∆° quan n√†y?')) return;
            try { await fetch(`${API}/admin/agencies/${id}`, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); }
        }

        // ========== PROVINCES ==========
        function renderProvinces(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Danh s√°ch T·ªânh / Th√†nh ph·ªë</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.provinces.length} ƒë·ªãa ph∆∞∆°ng</p>
                    </div>
                    <button onclick="showProvinceModal()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m t·ªânh/TP
                    </button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">M√£</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T√™n</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">S·ªë c∆° quan</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.provinces.map(p => `
                                <tr class="table-row transition">
                                    <td class="px-4 py-3 font-mono text-sm text-gray-600">${p.id}</td>
                                    <td class="px-4 py-3 font-medium text-gray-900">${p.name}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${allData.agencies.filter(a => a.provinceId === p.id).length} ƒë∆°n v·ªã</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showProvinceModal(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-3 text-sm">S·ª≠a</button>
                                        <button onclick="deleteProvince('${p.id}')" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                    </td>
                                </tr>
                                `).join('')}
                                ${allData.provinces.length === 0 ? '<tr><td colspan="4" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ t·ªânh/th√†nh ph·ªë</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showProvinceModal(province = null) {
            const isEdit = !!province;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a' : 'Th√™m'} T·ªânh / TP</h3>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M√£ <span class="text-red-500">*</span></label>
                                <input type="text" id="provinceId" value="${province?.id || ''}" ${isEdit ? 'readonly' : ''} class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:outline-none transition ${isEdit ? 'bg-gray-100' : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n <span class="text-red-500">*</span></label>
                                <input type="text" id="provinceName" value="${province?.name || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:outline-none transition">
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveProvince('${province?.id || ''}')" class="px-6 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveProvince(oldId) {
            const id = document.getElementById('provinceId').value.trim();
            const name = document.getElementById('provinceName').value.trim();
            if (!id || !name) { alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!'); return; }
            const url = oldId ? `${API}/admin/provinces/${oldId}` : `${API}/admin/provinces`;
            try {
                const res = await fetch(url, { method: oldId ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, name }) });
                const result = await res.json();
                if (!result.success) { alert(result.message || 'L·ªói!'); return; }
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteProvince(id) {
            const count = allData.agencies.filter(a => a.provinceId === id).length;
            if (count > 0) { alert(`Kh√¥ng th·ªÉ x√≥a! C√≥ ${count} c∆° quan.`); return; }
            if (!confirm('X√≥a t·ªânh/TP n√†y?')) return;
            try { await fetch(`${API}/admin/provinces/${id}`, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); }
        }

        // ========== HELPERS ==========
        function closeModal() { modalRoot.innerHTML = ''; quillEditor = null; }
        function stripHtml(html) { const t = document.createElement('div'); t.innerHTML = html; return t.textContent || t.innerText || ''; }
        function getFrequencyName(freq) { const f = FREQUENCIES.find(x => x.id === freq); return f ? f.name : freq; }

        // ========== START ==========
        checkAuth();
    </script>
</body>
</html>
