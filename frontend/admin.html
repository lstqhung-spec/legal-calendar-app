<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTIC Legal - Admin Panel v2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-item.active { background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%); color: white; }
        .sidebar-item:hover:not(.active) { background: #f1f5f9; }
        .card { transition: all 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .modal { display: none; }
        .modal.active { display: flex; }
        
        /* Rich Text Editor Styles */
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 12px 12px 0 0;
        }
        .editor-toolbar button {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .editor-toolbar button:hover {
            background: #e2e8f0;
        }
        .editor-toolbar button.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .editor-toolbar input[type="color"] {
            width: 36px;
            height: 36px;
            padding: 2px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
        }
        .editor-content {
            min-height: 150px;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 12px 12px;
            outline: none;
            overflow-y: auto;
        }
        .editor-content:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Subscription Cards */
        .subscription-card {
            position: relative;
            transition: all 0.3s;
        }
        .subscription-card:hover {
            transform: translateY(-4px);
        }
        .subscription-card.popular {
            border: 2px solid #3b82f6;
        }
        .popular-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Modal -->
    <div id="loginModal" class="modal active fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-scale-balanced text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">HTIC Legal Admin</h2>
                <p class="text-gray-500 mt-1">Đăng nhập để quản lý hệ thống</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên đăng nhập</label>
                    <input type="text" id="username" value="admin" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="admin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                    <input type="password" id="password" value="htic2025" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Đăng nhập
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-center mt-4 hidden">Sai tên đăng nhập hoặc mật khẩu</p>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="mainApp" class="hidden flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 fixed h-full">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-scale-balanced text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-800">HTIC Legal</h1>
                        <p class="text-xs text-gray-500">Admin Panel v2.1</p>
                    </div>
                </div>
            </div>
            <nav class="p-4 space-y-1">
                <a href="#" onclick="showSection('dashboard')" class="sidebar-item active flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </a>
                <a href="#" onclick="showSection('events')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-calendar-check w-5"></i> Sự kiện pháp lý
                </a>
                <a href="#" onclick="showSection('news')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-newspaper w-5"></i> Tin tức
                </a>
                <a href="#" onclick="showSection('agencies')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-building-columns w-5"></i> Cơ quan pháp lý
                </a>
                <a href="#" onclick="showSection('users')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-users w-5"></i> Người dùng
                </a>
                <a href="#" onclick="showSection('subscriptions')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-crown w-5"></i> Gói dịch vụ
                </a>
                <a href="#" onclick="showSection('company')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-building w-5"></i> Thông tin công ty
                </a>
                <a href="#" onclick="showSection('settings')" class="sidebar-item flex items-center gap-3 px-4 py-3 rounded-xl text-gray-600">
                    <i class="fas fa-cog w-5"></i> Cài đặt
                </a>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-100">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 text-red-600 hover:bg-red-50 rounded-xl transition">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 ml-64 p-8">
            <!-- Dashboard Section -->
            <section id="section-dashboard" class="section">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                    <p class="text-gray-500">Tổng quan hệ thống HTIC Legal App</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Sự kiện pháp lý</p>
                                <p id="stat-events" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-calendar-check text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tin tức</p>
                                <p id="stat-news" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-newspaper text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Cơ quan</p>
                                <p id="stat-agencies" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-building-columns text-purple-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-white rounded-2xl p-6 border border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Người dùng</p>
                                <p id="stat-users" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-users text-orange-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Subscription Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card bg-gradient-to-r from-gray-500 to-gray-600 rounded-2xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-200 text-sm">Gói Miễn phí</p>
                                <p id="stat-free" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-gray-200 text-xs mt-1">người dùng</p>
                            </div>
                            <i class="fas fa-user text-3xl text-gray-300"></i>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-200 text-sm">Gói Pro</p>
                                <p id="stat-pro" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-blue-200 text-xs mt-1">người dùng</p>
                            </div>
                            <i class="fas fa-crown text-3xl text-blue-300"></i>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-200 text-sm">Gói Doanh nghiệp</p>
                                <p id="stat-enterprise" class="text-3xl font-bold mt-1">0</p>
                                <p class="text-purple-200 text-xs mt-1">người dùng</p>
                            </div>
                            <i class="fas fa-building text-3xl text-purple-300"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 border border-gray-100">
                    <h3 class="font-semibold text-gray-800 mb-4">API Endpoints</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-gray-600">/api/events</code>
                        </div>
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-gray-600">/api/news</code>
                        </div>
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-gray-600">/api/agencies</code>
                        </div>
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-gray-600">/api/subscriptions</code>
                        </div>
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">GET</span>
                            <code class="text-gray-600">/api/company</code>
                        </div>
                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">POST</span>
                            <code class="text-gray-600">/api/auth/login</code>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Events Section -->
            <section id="section-events" class="section hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Sự kiện pháp lý</h2>
                        <p class="text-gray-500">Quản lý lịch pháp lý cho doanh nghiệp</p>
                    </div>
                    <button onclick="openEventModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Thêm sự kiện
                    </button>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Tiêu đề</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Danh mục</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Hạn chót</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Trạng thái</th>
                                <th class="text-right px-6 py-4 text-sm font-semibold text-gray-600">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- News Section -->
            <section id="section-news" class="section hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Tin tức pháp lý</h2>
                        <p class="text-gray-500">Quản lý tin tức và bài viết</p>
                    </div>
                    <button onclick="openNewsModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Thêm tin tức
                    </button>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Hình ảnh</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Tiêu đề</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Danh mục</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Ngày</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Nổi bật</th>
                                <th class="text-right px-6 py-4 text-sm font-semibold text-gray-600">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="newsTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- Agencies Section -->
            <section id="section-agencies" class="section hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Cơ quan pháp lý</h2>
                        <p class="text-gray-500">Danh sách cơ quan nhà nước và tổ chức pháp lý</p>
                    </div>
                    <button onclick="openAgencyModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Thêm cơ quan
                    </button>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Tên cơ quan</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Loại</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Thành phố</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Điện thoại</th>
                                <th class="text-right px-6 py-4 text-sm font-semibold text-gray-600">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="agenciesTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="section-users" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">Người dùng</h2>
                    <p class="text-gray-500">Danh sách người dùng đã đăng ký</p>
                </div>
                
                <!-- Filter by subscription -->
                <div class="flex gap-2 mb-6">
                    <button onclick="filterUsers('all')" class="user-filter active px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-medium" data-filter="all">Tất cả</button>
                    <button onclick="filterUsers('free')" class="user-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200" data-filter="free">Miễn phí</button>
                    <button onclick="filterUsers('pro')" class="user-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200" data-filter="pro">Pro</button>
                    <button onclick="filterUsers('enterprise')" class="user-filter px-4 py-2 rounded-lg bg-gray-100 text-gray-600 text-sm font-medium hover:bg-gray-200" data-filter="enterprise">Doanh nghiệp</button>
                </div>
                
                <div class="bg-white rounded-2xl border border-gray-100 overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Email</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Công ty</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Mã số thuế</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Gói dịch vụ</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Ngày đăng ký</th>
                                <th class="text-left px-6 py-4 text-sm font-semibold text-gray-600">Trạng thái</th>
                                <th class="text-right px-6 py-4 text-sm font-semibold text-gray-600">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- Subscriptions Section -->
            <section id="section-subscriptions" class="section hidden">
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Gói dịch vụ</h2>
                        <p class="text-gray-500">Quản lý các gói dịch vụ và theo dõi khách hàng</p>
                    </div>
                    <button onclick="openSubscriptionModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> Thêm gói mới
                    </button>
                </div>
                
                <!-- Subscription Cards -->
                <div id="subscriptionsList" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"></div>
                
                <!-- Users by Subscription Table -->
                <div class="bg-white rounded-2xl border border-gray-100 p-6">
                    <h3 class="font-semibold text-gray-800 mb-4">
                        <i class="fas fa-users mr-2 text-blue-600"></i>
                        Khách hàng theo gói dịch vụ
                    </h3>
                    <div id="subscriptionUsersTable"></div>
                </div>
            </section>

            <!-- Company Section -->
            <section id="section-company" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">Thông tin công ty</h2>
                    <p class="text-gray-500">Cập nhật thông tin Công ty Luật HTIC</p>
                </div>
                <form id="companyForm" class="bg-white rounded-2xl border border-gray-100 p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên công ty</label>
                            <input type="text" id="companyName" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên viết tắt</label>
                            <input type="text" id="companyShortName" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Slogan</label>
                            <input type="text" id="companySlogan" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
                            <textarea id="companyDescription" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ</label>
                            <input type="text" id="companyAddress" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Điện thoại</label>
                            <input type="text" id="companyPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hotline</label>
                            <input type="text" id="companyHotline" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="companyEmail" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                            <input type="url" id="companyWebsite" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-blue-700 transition">
                            <i class="fas fa-save mr-2"></i>Lưu thông tin
                        </button>
                    </div>
                </form>
            </section>

            <!-- Settings Section -->
            <section id="section-settings" class="section hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">Cài đặt</h2>
                    <p class="text-gray-500">Cấu hình ứng dụng</p>
                </div>
                <form id="settingsForm" class="bg-white rounded-2xl border border-gray-100 p-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tên ứng dụng</label>
                            <input type="text" id="settingAppName" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phiên bản</label>
                            <input type="text" id="settingAppVersion" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Màu chủ đạo</label>
                            <input type="color" id="settingPrimaryColor" class="w-full h-12 border border-gray-200 rounded-xl cursor-pointer">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Logo URL</label>
                            <input type="url" id="settingLogo" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="submit" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-blue-700 transition">
                            <i class="fas fa-save mr-2"></i>Lưu cài đặt
                        </button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <!-- Event Modal with Rich Text Editor -->
    <div id="eventModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 overflow-y-auto py-8">
        <div class="bg-white rounded-2xl w-full max-w-3xl mx-4">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 id="eventModalTitle" class="text-xl font-bold text-gray-800">Thêm sự kiện mới</h3>
                <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="eventForm" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="eventId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề *</label>
                    <input type="text" id="eventTitle" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Danh mục *</label>
                        <select id="eventCategory" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="tax">Thuế</option>
                            <option value="insurance">Bảo hiểm</option>
                            <option value="labor">Lao động</option>
                            <option value="finance">Tài chính</option>
                            <option value="investment">Đầu tư</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hạn chót *</label>
                        <input type="date" id="eventDeadline" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label>
                    <div class="editor-toolbar">
                        <button type="button" onclick="execCmd('eventDescEditor', 'bold')" title="In đậm"><i class="fas fa-bold"></i></button>
                        <button type="button" onclick="execCmd('eventDescEditor', 'italic')" title="In nghiêng"><i class="fas fa-italic"></i></button>
                        <button type="button" onclick="execCmd('eventDescEditor', 'underline')" title="Gạch chân"><i class="fas fa-underline"></i></button>
                        <button type="button" onclick="execCmd('eventDescEditor', 'strikeThrough')" title="Gạch ngang"><i class="fas fa-strikethrough"></i></button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <input type="color" id="eventTextColor" value="#000000" onchange="execCmdColor('eventDescEditor', this.value)" title="Màu chữ">
                        <button type="button" onclick="execCmd('eventDescEditor', 'removeFormat')" title="Xóa định dạng"><i class="fas fa-eraser"></i></button>
                    </div>
                    <div id="eventDescEditor" class="editor-content" contenteditable="true"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Căn cứ pháp lý</label>
                    <input type="text" id="eventLegalBasis" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mức phạt</label>
                    <input type="text" id="eventPenalty" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="eventIsActive" checked class="w-5 h-5 rounded border-gray-300">
                    <label class="text-sm text-gray-700">Kích hoạt</label>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeEventModal()" class="px-6 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">Hủy</button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- News Modal with Rich Text Editor -->
    <div id="newsModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 overflow-y-auto py-8">
        <div class="bg-white rounded-2xl w-full max-w-3xl mx-4">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 id="newsModalTitle" class="text-xl font-bold text-gray-800">Thêm tin tức mới</h3>
                <button onclick="closeNewsModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="newsForm" class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="newsId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tiêu đề *</label>
                    <input type="text" id="newsTitle" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Danh mục *</label>
                        <select id="newsCategory" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="tax">Thuế</option>
                            <option value="insurance">Bảo hiểm</option>
                            <option value="labor">Lao động</option>
                            <option value="investment">Đầu tư</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày đăng</label>
                        <input type="date" id="newsDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">URL Hình ảnh</label>
                    <input type="url" id="newsImageUrl" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/image.jpg">
                    <div id="newsImagePreview" class="mt-2 hidden">
                        <img src="" alt="Preview" class="h-32 object-cover rounded-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tóm tắt *</label>
                    <textarea id="newsSummary" rows="2" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nội dung *</label>
                    <div class="editor-toolbar">
                        <button type="button" onclick="execCmd('newsContentEditor', 'bold')" title="In đậm"><i class="fas fa-bold"></i></button>
                        <button type="button" onclick="execCmd('newsContentEditor', 'italic')" title="In nghiêng"><i class="fas fa-italic"></i></button>
                        <button type="button" onclick="execCmd('newsContentEditor', 'underline')" title="Gạch chân"><i class="fas fa-underline"></i></button>
                        <button type="button" onclick="execCmd('newsContentEditor', 'strikeThrough')" title="Gạch ngang"><i class="fas fa-strikethrough"></i></button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <button type="button" onclick="execCmd('newsContentEditor', 'insertUnorderedList')" title="Danh sách"><i class="fas fa-list-ul"></i></button>
                        <button type="button" onclick="execCmd('newsContentEditor', 'insertOrderedList')" title="Danh sách số"><i class="fas fa-list-ol"></i></button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <input type="color" id="newsTextColor" value="#000000" onchange="execCmdColor('newsContentEditor', this.value)" title="Màu chữ">
                        <button type="button" onclick="execCmd('newsContentEditor', 'removeFormat')" title="Xóa định dạng"><i class="fas fa-eraser"></i></button>
                    </div>
                    <div id="newsContentEditor" class="editor-content" contenteditable="true" style="min-height: 200px;"></div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="newsIsHot" class="w-5 h-5 rounded border-gray-300">
                    <label class="text-sm text-gray-700">Tin nổi bật</label>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeNewsModal()" class="px-6 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">Hủy</button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Agency Modal -->
    <div id="agencyModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 id="agencyModalTitle" class="text-xl font-bold text-gray-800">Thêm cơ quan mới</h3>
                <button onclick="closeAgencyModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="agencyForm" class="p-6 space-y-4">
                <input type="hidden" id="agencyId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tên cơ quan *</label>
                    <input type="text" id="agencyName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loại *</label>
                        <select id="agencyType" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="tax">Thuế</option>
                            <option value="insurance">Bảo hiểm</option>
                            <option value="notary">Công chứng</option>
                            <option value="court">Tòa án</option>
                            <option value="police">Công an</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Thành phố *</label>
                        <input type="text" id="agencyCity" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ</label>
                    <input type="text" id="agencyAddress" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Điện thoại</label>
                        <input type="text" id="agencyPhone" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="agencyEmail" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Giờ làm việc</label>
                    <input type="text" id="agencyWorkingHours" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Mô tả</label>
                    <textarea id="agencyDescription" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeAgencyModal()" class="px-6 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">Hủy</button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-4">
            <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                <h3 id="subscriptionModalTitle" class="text-xl font-bold text-gray-800">Thêm gói dịch vụ</h3>
                <button onclick="closeSubscriptionModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="subscriptionForm" class="p-6 space-y-4">
                <input type="hidden" id="subId">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên gói *</label>
                        <input type="text" id="subName" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Giá (VNĐ) *</label>
                        <input type="number" id="subPrice" required class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chu kỳ</label>
                        <select id="subPeriod" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                            <option value="monthly">Hàng tháng</option>
                            <option value="yearly">Hàng năm</option>
                            <option value="forever">Vĩnh viễn</option>
                        </select>
                    </div>
                    <div class="flex items-end gap-4">
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="subPopular" class="w-5 h-5 rounded border-gray-300">
                            <span class="text-sm text-gray-700">Phổ biến</span>
                        </label>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="subActive" checked class="w-5 h-5 rounded border-gray-300">
                            <span class="text-sm text-gray-700">Kích hoạt</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tính năng (mỗi dòng 1 tính năng)</label>
                    <textarea id="subFeatures" rows="5" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Xem lịch pháp lý&#10;Nhắc nhở tự động&#10;Liên hệ luật sư"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tính năng không có (mỗi dòng 1 tính năng)</label>
                    <textarea id="subNotIncluded" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Hỗ trợ ưu tiên&#10;API tích hợp"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                    <button type="button" onclick="closeSubscriptionModal()" class="px-6 py-3 border border-gray-200 rounded-xl text-gray-600 hover:bg-gray-50">Hủy</button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">Lưu</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('adminToken');
        let allUsers = [];

        // Rich Text Editor Functions
        function execCmd(editorId, command) {
            document.getElementById(editorId).focus();
            document.execCommand(command, false, null);
        }

        function execCmdColor(editorId, color) {
            document.getElementById(editorId).focus();
            document.execCommand('foreColor', false, color);
        }

        // Image preview
        document.getElementById('newsImageUrl')?.addEventListener('input', function() {
            const preview = document.getElementById('newsImagePreview');
            const img = preview.querySelector('img');
            if (this.value) {
                img.src = this.value;
                preview.classList.remove('hidden');
                img.onerror = () => preview.classList.add('hidden');
            } else {
                preview.classList.add('hidden');
            }
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadDashboard();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        if (authToken) {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('mainApp').classList.remove('hidden');
            loadDashboard();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // Navigation
        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            event.target.closest('.sidebar-item').classList.add('active');
            
            if (name === 'dashboard') loadDashboard();
            else if (name === 'events') loadEvents();
            else if (name === 'news') loadNews();
            else if (name === 'agencies') loadAgencies();
            else if (name === 'users') loadUsers();
            else if (name === 'subscriptions') loadSubscriptions();
            else if (name === 'company') loadCompany();
            else if (name === 'settings') loadSettings();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const [statsRes, usersRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/stats`),
                    fetch(`${API_BASE}/api/admin/users`)
                ]);
                const stats = await statsRes.json();
                const users = await usersRes.json();
                
                if (stats.success) {
                    document.getElementById('stat-events').textContent = stats.data.events?.total || 0;
                    document.getElementById('stat-news').textContent = stats.data.news?.total || 0;
                    document.getElementById('stat-agencies').textContent = stats.data.agencies?.total || 0;
                    document.getElementById('stat-users').textContent = stats.data.users?.total || 0;
                }
                
                if (users.success) {
                    allUsers = users.data;
                    const freeCount = allUsers.filter(u => !u.subscription || u.subscription === 'free').length;
                    const proCount = allUsers.filter(u => u.subscription === 'pro').length;
                    const enterpriseCount = allUsers.filter(u => u.subscription === 'enterprise').length;
                    
                    document.getElementById('stat-free').textContent = freeCount;
                    document.getElementById('stat-pro').textContent = proCount;
                    document.getElementById('stat-enterprise').textContent = enterpriseCount;
                }
            } catch (err) { console.error(err); }
        }

        // Events
        async function loadEvents() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/events`);
                const data = await res.json();
                const tbody = document.getElementById('eventsTable');
                tbody.innerHTML = data.data.map(e => `
                    <tr>
                        <td class="px-6 py-4"><div class="font-medium text-gray-800">${e.title}</div></td>
                        <td class="px-6 py-4"><span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs">${getCategoryName(e.category)}</span></td>
                        <td class="px-6 py-4 text-gray-600">${e.deadline || ''}</td>
                        <td class="px-6 py-4">${e.isActive !== false ? '<span class="text-green-600">✓ Hoạt động</span>' : '<span class="text-gray-400">Ẩn</span>'}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editEvent(${e.id})" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteEvent(${e.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) { console.error(err); }
        }

        function openEventModal() {
            document.getElementById('eventModalTitle').textContent = 'Thêm sự kiện mới';
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            document.getElementById('eventDescEditor').innerHTML = '';
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        async function editEvent(id) {
            const res = await fetch(`${API_BASE}/api/admin/events`);
            const data = await res.json();
            const event = data.data.find(e => e.id === id);
            if (event) {
                document.getElementById('eventModalTitle').textContent = 'Sửa sự kiện';
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventTitle').value = event.title;
                document.getElementById('eventCategory').value = event.category;
                document.getElementById('eventDeadline').value = event.deadline;
                document.getElementById('eventDescEditor').innerHTML = event.description || '';
                document.getElementById('eventLegalBasis').value = event.legalBasis || '';
                document.getElementById('eventPenalty').value = event.penalty || '';
                document.getElementById('eventIsActive').checked = event.isActive !== false;
                document.getElementById('eventModal').classList.add('active');
            }
        }

        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('eventId').value;
            const eventData = {
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                deadline: document.getElementById('eventDeadline').value,
                description: document.getElementById('eventDescEditor').innerHTML,
                legalBasis: document.getElementById('eventLegalBasis').value,
                penalty: document.getElementById('eventPenalty').value,
                isActive: document.getElementById('eventIsActive').checked
            };
            const url = id ? `${API_BASE}/api/admin/events/${id}` : `${API_BASE}/api/admin/events`;
            const method = id ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(eventData) });
            closeEventModal();
            loadEvents();
        });

        async function deleteEvent(id) {
            if (confirm('Bạn có chắc muốn xóa sự kiện này?')) {
                await fetch(`${API_BASE}/api/admin/events/${id}`, { method: 'DELETE' });
                loadEvents();
            }
        }

        // News
        async function loadNews() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/news`);
                const data = await res.json();
                const tbody = document.getElementById('newsTable');
                tbody.innerHTML = data.data.map(n => `
                    <tr>
                        <td class="px-6 py-4">
                            ${n.imageUrl ? `<img src="${n.imageUrl}" class="w-16 h-12 object-cover rounded-lg" onerror="this.style.display='none'">` : '<div class="w-16 h-12 bg-gray-100 rounded-lg flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>'}
                        </td>
                        <td class="px-6 py-4"><div class="font-medium text-gray-800 max-w-xs truncate">${n.title}</div></td>
                        <td class="px-6 py-4"><span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs">${getCategoryName(n.category)}</span></td>
                        <td class="px-6 py-4 text-gray-600">${formatDate(n.date)}</td>
                        <td class="px-6 py-4">${n.isHot ? '<span class="text-orange-500"><i class="fas fa-fire"></i></span>' : ''}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editNews(${n.id})" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteNews(${n.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) { console.error(err); }
        }

        function openNewsModal() {
            document.getElementById('newsModalTitle').textContent = 'Thêm tin tức mới';
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').value = '';
            document.getElementById('newsContentEditor').innerHTML = '';
            document.getElementById('newsImagePreview').classList.add('hidden');
            document.getElementById('newsModal').classList.add('active');
        }

        function closeNewsModal() {
            document.getElementById('newsModal').classList.remove('active');
        }

        async function editNews(id) {
            const res = await fetch(`${API_BASE}/api/admin/news`);
            const data = await res.json();
            const news = data.data.find(n => n.id === id);
            if (news) {
                document.getElementById('newsModalTitle').textContent = 'Sửa tin tức';
                document.getElementById('newsId').value = news.id;
                document.getElementById('newsTitle').value = news.title;
                document.getElementById('newsCategory').value = news.category;
                document.getElementById('newsDate').value = news.date ? news.date.split('T')[0] : '';
                document.getElementById('newsImageUrl').value = news.imageUrl || '';
                document.getElementById('newsSummary').value = news.summary || '';
                document.getElementById('newsContentEditor').innerHTML = news.content || '';
                document.getElementById('newsIsHot').checked = news.isHot;
                
                const preview = document.getElementById('newsImagePreview');
                if (news.imageUrl) {
                    preview.querySelector('img').src = news.imageUrl;
                    preview.classList.remove('hidden');
                } else {
                    preview.classList.add('hidden');
                }
                
                document.getElementById('newsModal').classList.add('active');
            }
        }

        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('newsId').value;
            const newsData = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                date: document.getElementById('newsDate').value ? new Date(document.getElementById('newsDate').value).toISOString() : new Date().toISOString(),
                imageUrl: document.getElementById('newsImageUrl').value,
                summary: document.getElementById('newsSummary').value,
                content: document.getElementById('newsContentEditor').innerHTML,
                isHot: document.getElementById('newsIsHot').checked
            };
            const url = id ? `${API_BASE}/api/admin/news/${id}` : `${API_BASE}/api/admin/news`;
            const method = id ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newsData) });
            closeNewsModal();
            loadNews();
        });

        async function deleteNews(id) {
            if (confirm('Bạn có chắc muốn xóa tin tức này?')) {
                await fetch(`${API_BASE}/api/admin/news/${id}`, { method: 'DELETE' });
                loadNews();
            }
        }

        // Agencies
        async function loadAgencies() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/agencies`);
                const data = await res.json();
                const tbody = document.getElementById('agenciesTable');
                tbody.innerHTML = data.data.map(a => `
                    <tr>
                        <td class="px-6 py-4"><div class="font-medium text-gray-800">${a.name}</div></td>
                        <td class="px-6 py-4"><span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs">${getTypeName(a.type)}</span></td>
                        <td class="px-6 py-4 text-gray-600">${a.city || ''}</td>
                        <td class="px-6 py-4 text-gray-600">${a.phone || ''}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editAgency(${a.id})" class="text-blue-600 hover:text-blue-800 mr-3"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteAgency(${a.id})" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) { console.error(err); }
        }

        function openAgencyModal() {
            document.getElementById('agencyModalTitle').textContent = 'Thêm cơ quan mới';
            document.getElementById('agencyForm').reset();
            document.getElementById('agencyId').value = '';
            document.getElementById('agencyModal').classList.add('active');
        }

        function closeAgencyModal() {
            document.getElementById('agencyModal').classList.remove('active');
        }

        async function editAgency(id) {
            const res = await fetch(`${API_BASE}/api/admin/agencies`);
            const data = await res.json();
            const agency = data.data.find(a => a.id === id);
            if (agency) {
                document.getElementById('agencyModalTitle').textContent = 'Sửa cơ quan';
                document.getElementById('agencyId').value = agency.id;
                document.getElementById('agencyName').value = agency.name;
                document.getElementById('agencyType').value = agency.type;
                document.getElementById('agencyCity').value = agency.city || '';
                document.getElementById('agencyAddress').value = agency.address || '';
                document.getElementById('agencyPhone').value = agency.phone || '';
                document.getElementById('agencyEmail').value = agency.email || '';
                document.getElementById('agencyWorkingHours').value = agency.workingHours || '';
                document.getElementById('agencyDescription').value = agency.description || '';
                document.getElementById('agencyModal').classList.add('active');
            }
        }

        document.getElementById('agencyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('agencyId').value;
            const agencyData = {
                name: document.getElementById('agencyName').value,
                type: document.getElementById('agencyType').value,
                city: document.getElementById('agencyCity').value,
                address: document.getElementById('agencyAddress').value,
                phone: document.getElementById('agencyPhone').value,
                email: document.getElementById('agencyEmail').value,
                workingHours: document.getElementById('agencyWorkingHours').value,
                description: document.getElementById('agencyDescription').value
            };
            const url = id ? `${API_BASE}/api/admin/agencies/${id}` : `${API_BASE}/api/admin/agencies`;
            const method = id ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(agencyData) });
            closeAgencyModal();
            loadAgencies();
        });

        async function deleteAgency(id) {
            if (confirm('Bạn có chắc muốn xóa cơ quan này?')) {
                await fetch(`${API_BASE}/api/admin/agencies/${id}`, { method: 'DELETE' });
                loadAgencies();
            }
        }

        // Users
        async function loadUsers() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/users`);
                const data = await res.json();
                allUsers = data.data;
                renderUsers(allUsers);
            } catch (err) { console.error(err); }
        }

        function filterUsers(filter) {
            document.querySelectorAll('.user-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-600');
            });
            event.target.classList.add('active', 'bg-blue-600', 'text-white');
            event.target.classList.remove('bg-gray-100', 'text-gray-600');
            
            let filtered = allUsers;
            if (filter === 'free') filtered = allUsers.filter(u => !u.subscription || u.subscription === 'free');
            else if (filter === 'pro') filtered = allUsers.filter(u => u.subscription === 'pro');
            else if (filter === 'enterprise') filtered = allUsers.filter(u => u.subscription === 'enterprise');
            
            renderUsers(filtered);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTable');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">Chưa có người dùng</td></tr>';
            } else {
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td class="px-6 py-4"><div class="font-medium text-gray-800">${u.email}</div></td>
                        <td class="px-6 py-4 text-gray-600">${u.companyName || '-'}</td>
                        <td class="px-6 py-4 text-gray-600">${u.taxCode || '-'}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${getSubscriptionColor(u.subscription)}">${getSubscriptionName(u.subscription)}</span>
                        </td>
                        <td class="px-6 py-4 text-gray-600">${formatDate(u.createdAt)}</td>
                        <td class="px-6 py-4">${u.isActive !== false ? '<span class="text-green-600">✓ Hoạt động</span>' : '<span class="text-red-600">Khóa</span>'}</td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="changeUserSubscription(${u.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Đổi gói"><i class="fas fa-crown"></i></button>
                            <button onclick="toggleUserStatus(${u.id})" class="text-orange-600 hover:text-orange-800" title="Khóa/Mở khóa"><i class="fas fa-ban"></i></button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function changeUserSubscription(id) {
            const user = allUsers.find(u => u.id === id);
            const newSub = prompt('Nhập gói mới (free, pro, enterprise):', user.subscription || 'free');
            if (newSub && ['free', 'pro', 'enterprise'].includes(newSub)) {
                // This would need a PUT endpoint for users - for now just show alert
                alert('Chức năng đang phát triển. Cần thêm API PUT /api/admin/users/:id');
            }
        }

        async function toggleUserStatus(id) {
            alert('Chức năng đang phát triển. Cần thêm API PUT /api/admin/users/:id');
        }

        // Subscriptions
        async function loadSubscriptions() {
            try {
                const [subsRes, usersRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/subscriptions`),
                    fetch(`${API_BASE}/api/admin/users`)
                ]);
                const subs = await subsRes.json();
                const users = await usersRes.json();
                allUsers = users.data;
                
                const container = document.getElementById('subscriptionsList');
                container.innerHTML = subs.data.map(s => {
                    const userCount = allUsers.filter(u => {
                        if (s.name === 'Miễn phí') return !u.subscription || u.subscription === 'free';
                        if (s.name === 'Pro') return u.subscription === 'pro';
                        if (s.name === 'Doanh nghiệp') return u.subscription === 'enterprise';
                        return false;
                    }).length;
                    
                    return `
                    <div class="subscription-card bg-white rounded-2xl border border-gray-100 p-6 ${s.popular ? 'popular' : ''}">
                        ${s.popular ? '<div class="popular-badge"><span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-medium">PHỔ BIẾN</span></div>' : ''}
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-bold text-gray-800">${s.name}</h3>
                            <div class="flex gap-1">
                                <button onclick="editSubscription(${s.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteSubscription(${s.id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="text-center my-4">
                            <span class="text-3xl font-bold text-gray-800">${s.price.toLocaleString()}đ</span>
                            <span class="text-gray-500">/${getPeriodName(s.period)}</span>
                        </div>
                        <div class="bg-blue-50 rounded-xl p-3 mb-4 text-center">
                            <span class="text-2xl font-bold text-blue-600">${userCount}</span>
                            <span class="text-blue-600 text-sm ml-1">người dùng</span>
                        </div>
                        <ul class="space-y-2">
                            ${(s.features || []).map(f => `<li class="flex items-center gap-2 text-sm text-gray-600"><i class="fas fa-check text-green-500 w-4"></i>${f}</li>`).join('')}
                            ${(s.notIncluded || []).map(f => `<li class="flex items-center gap-2 text-sm text-gray-400"><i class="fas fa-times text-gray-300 w-4"></i>${f}</li>`).join('')}
                        </ul>
                    </div>
                `}).join('');
                
                // Render users by subscription
                renderSubscriptionUsers();
            } catch (err) { console.error(err); }
        }

        function renderSubscriptionUsers() {
            const container = document.getElementById('subscriptionUsersTable');
            
            const groupedUsers = {
                'Miễn phí': allUsers.filter(u => !u.subscription || u.subscription === 'free'),
                'Pro': allUsers.filter(u => u.subscription === 'pro'),
                'Doanh nghiệp': allUsers.filter(u => u.subscription === 'enterprise')
            };
            
            let html = '';
            for (const [subName, users] of Object.entries(groupedUsers)) {
                html += `
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-700 mb-2 flex items-center gap-2">
                            <span class="px-2 py-1 ${subName === 'Pro' ? 'bg-blue-100 text-blue-700' : subName === 'Doanh nghiệp' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'} rounded text-xs">${subName}</span>
                            <span class="text-gray-400">(${users.length} người dùng)</span>
                        </h4>
                        ${users.length > 0 ? `
                            <div class="bg-gray-50 rounded-xl overflow-hidden">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="text-left px-4 py-2 text-gray-600">Email</th>
                                            <th class="text-left px-4 py-2 text-gray-600">Công ty</th>
                                            <th class="text-left px-4 py-2 text-gray-600">Ngày đăng ký</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${users.map(u => `
                                            <tr>
                                                <td class="px-4 py-2 text-gray-800">${u.email}</td>
                                                <td class="px-4 py-2 text-gray-600">${u.companyName || '-'}</td>
                                                <td class="px-4 py-2 text-gray-600">${formatDate(u.createdAt)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<p class="text-gray-400 text-sm italic">Chưa có người dùng</p>'}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function openSubscriptionModal() {
            document.getElementById('subscriptionModalTitle').textContent = 'Thêm gói dịch vụ';
            document.getElementById('subscriptionForm').reset();
            document.getElementById('subId').value = '';
            document.getElementById('subscriptionModal').classList.add('active');
        }

        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').classList.remove('active');
        }

        async function editSubscription(id) {
            const res = await fetch(`${API_BASE}/api/admin/subscriptions`);
            const data = await res.json();
            const sub = data.data.find(s => s.id === id);
            if (sub) {
                document.getElementById('subscriptionModalTitle').textContent = 'Sửa gói dịch vụ';
                document.getElementById('subId').value = sub.id;
                document.getElementById('subName').value = sub.name;
                document.getElementById('subPrice').value = sub.price;
                document.getElementById('subPeriod').value = sub.period;
                document.getElementById('subPopular').checked = sub.popular || false;
                document.getElementById('subActive').checked = sub.isActive !== false;
                document.getElementById('subFeatures').value = (sub.features || []).join('\n');
                document.getElementById('subNotIncluded').value = (sub.notIncluded || []).join('\n');
                document.getElementById('subscriptionModal').classList.add('active');
            }
        }

        document.getElementById('subscriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('subId').value;
            const subData = {
                name: document.getElementById('subName').value,
                price: parseInt(document.getElementById('subPrice').value),
                period: document.getElementById('subPeriod').value,
                popular: document.getElementById('subPopular').checked,
                isActive: document.getElementById('subActive').checked,
                features: document.getElementById('subFeatures').value.split('\n').filter(f => f.trim()),
                notIncluded: document.getElementById('subNotIncluded').value.split('\n').filter(f => f.trim())
            };
            const url = id ? `${API_BASE}/api/admin/subscriptions/${id}` : `${API_BASE}/api/admin/subscriptions`;
            const method = id ? 'PUT' : 'POST';
            await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(subData) });
            closeSubscriptionModal();
            loadSubscriptions();
        });

        async function deleteSubscription(id) {
            if (confirm('Bạn có chắc muốn xóa gói dịch vụ này?')) {
                await fetch(`${API_BASE}/api/admin/subscriptions/${id}`, { method: 'DELETE' });
                loadSubscriptions();
            }
        }

        // Company
        async function loadCompany() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/company`);
                const data = await res.json();
                const c = data.data;
                document.getElementById('companyName').value = c.name || '';
                document.getElementById('companyShortName').value = c.shortName || '';
                document.getElementById('companySlogan').value = c.slogan || '';
                document.getElementById('companyDescription').value = c.description || '';
                document.getElementById('companyAddress').value = c.address || '';
                document.getElementById('companyPhone').value = c.phone || '';
                document.getElementById('companyHotline').value = c.hotline || '';
                document.getElementById('companyEmail').value = c.email || '';
                document.getElementById('companyWebsite').value = c.website || '';
            } catch (err) { console.error(err); }
        }

        document.getElementById('companyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const companyData = {
                name: document.getElementById('companyName').value,
                shortName: document.getElementById('companyShortName').value,
                slogan: document.getElementById('companySlogan').value,
                description: document.getElementById('companyDescription').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                hotline: document.getElementById('companyHotline').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value
            };
            await fetch(`${API_BASE}/api/admin/company`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(companyData)
            });
            alert('Đã lưu thông tin công ty!');
        });

        // Settings
        async function loadSettings() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/settings`);
                const data = await res.json();
                const s = data.data;
                document.getElementById('settingAppName').value = s.appName || '';
                document.getElementById('settingAppVersion').value = s.appVersion || '';
                document.getElementById('settingPrimaryColor').value = s.primaryColor || '#136DEC';
                document.getElementById('settingLogo').value = s.logo || '';
            } catch (err) { console.error(err); }
        }

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const settingsData = {
                appName: document.getElementById('settingAppName').value,
                appVersion: document.getElementById('settingAppVersion').value,
                primaryColor: document.getElementById('settingPrimaryColor').value,
                logo: document.getElementById('settingLogo').value
            };
            await fetch(`${API_BASE}/api/admin/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settingsData)
            });
            alert('Đã lưu cài đặt!');
        });

        // Helpers
        function getCategoryName(cat) {
            const names = { tax: 'Thuế', insurance: 'Bảo hiểm', labor: 'Lao động', finance: 'Tài chính', investment: 'Đầu tư' };
            return names[cat] || cat;
        }

        function getTypeName(type) {
            const names = { tax: 'Thuế', insurance: 'Bảo hiểm', notary: 'Công chứng', court: 'Tòa án', police: 'Công an' };
            return names[type] || type;
        }

        function getSubscriptionName(sub) {
            const names = { free: 'Miễn phí', pro: 'Pro', enterprise: 'Doanh nghiệp' };
            return names[sub] || 'Miễn phí';
        }

        function getSubscriptionColor(sub) {
            const colors = { 
                free: 'bg-gray-100 text-gray-700', 
                pro: 'bg-blue-100 text-blue-700', 
                enterprise: 'bg-purple-100 text-purple-700' 
            };
            return colors[sub] || colors.free;
        }

        function getPeriodName(period) {
            const names = { monthly: 'tháng', yearly: 'năm', forever: 'mãi mãi' };
            return names[period] || period;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`;
        }
    </script>
</body>
</html>
