<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã - HTIC Legal App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 50: '#e8eef5', 100: '#c5d4e8', 500: '#3d6d9e', 600: '#1e3a5f', 700: '#162d4a', 800: '#0f1f33' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 3px solid #f97316; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .table-row:hover { background: #f8fafc; }
        .stat-card:hover { transform: translateY(-2px); }
        /* Quill Editor Styling */
        .ql-toolbar.ql-snow { border-radius: 12px 12px 0 0; border-color: #e5e7eb; background: #f9fafb; }
        .ql-container.ql-snow { border-radius: 0 0 12px 12px; border-color: #e5e7eb; font-size: 16px; }
        .ql-editor { min-height: 180px; max-height: 400px; overflow-y: auto; }
        .ql-editor.ql-blank::before { font-style: normal; color: #9ca3af; }
        .ql-snow .ql-picker { color: #374151; }
        .ql-snow .ql-stroke { stroke: #374151; }
        .ql-snow .ql-fill { fill: #374151; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>
    <div id="modal-root"></div>

    <script>
        // ========== CONFIGURATION ==========
        const API = '/api';
        let token = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';
        let allData = { events: [], news: [], agencies: [], provinces: [], settings: {}, stats: {} };
        let quillEditor = null;

        const app = document.getElementById('app');
        const modalRoot = document.getElementById('modal-root');

        // ========== CONSTANTS ==========
        const CATEGORIES = [
            { id: 'tax', name: 'Thu·∫ø', icon: 'üí∞', color: 'blue' },
            { id: 'insurance', name: 'B·∫£o hi·ªÉm', icon: 'üè•', color: 'green' },
            { id: 'labor', name: 'Lao ƒë·ªông', icon: 'üë∑', color: 'orange' },
            { id: 'safety', name: 'An to√†n lao ƒë·ªông', icon: 'üõ°Ô∏è', color: 'red' },
            { id: 'environment', name: 'M√¥i tr∆∞·ªùng', icon: 'üåø', color: 'emerald' },
            { id: 'investment', name: 'ƒê·∫ßu t∆∞', icon: 'üìà', color: 'purple' },
            { id: 'report', name: 'B√°o c√°o', icon: 'üìä', color: 'indigo' },
            { id: 'license', name: 'Gi·∫•y ph√©p', icon: 'üìã', color: 'gray' },
            { id: 'holiday', name: 'Ngh·ªâ l·ªÖ', icon: 'üéâ', color: 'pink' }
        ];

        const FREQUENCIES = [
            { id: 'once', name: 'M·ªôt l·∫ßn (ng√†y c·ª• th·ªÉ)' },
            { id: 'monthly', name: 'H√†ng th√°ng' },
            { id: 'quarterly', name: 'H√†ng qu√Ω' },
            { id: 'yearly', name: 'H√†ng nƒÉm' }
        ];

        const NEWS_CATEGORIES = ['Thu·∫ø', 'BHXH', 'Doanh nghi·ªáp', 'Lao ƒë·ªông', 'Ph√°p lu·∫≠t', 'ƒê·∫ßu t∆∞', 'M√¥i tr∆∞·ªùng', 'Kh√°c'];

        const AGENCY_CATEGORIES = [
            { id: 'government', name: 'C∆° quan Nh√† n∆∞·ªõc', icon: 'üèõÔ∏è' },
            { id: 'lawfirm', name: 'C√¥ng ty Lu·∫≠t / VP Lu·∫≠t s∆∞', icon: '‚öñÔ∏è' },
            { id: 'notary', name: 'VƒÉn ph√≤ng C√¥ng ch·ª©ng', icon: 'üìù' },
            { id: 'bailiff', name: 'VƒÉn ph√≤ng Th·ª´a ph√°t l·∫°i', icon: 'üìú' }
        ];

        // ========== AUTHENTICATION ==========
        function checkAuth() {
            if (!token) showLogin();
            else loadDashboard();
        }

        function showLogin() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-600 to-navy-800 p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-navy-600 to-navy-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <span class="text-white text-3xl font-bold">H</span>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900">HTIC Legal Admin</h1>
                            <p class="text-gray-500 mt-2">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n tr·ªã h·ªá th·ªëng</p>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="username" value="admin" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="password" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition" onkeypress="if(event.key==='Enter')login()">
                            </div>
                            <button onclick="login()" class="w-full bg-gradient-to-r from-navy-600 to-navy-700 text-white py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                                ƒêƒÉng nh·∫≠p
                            </button>
                        </div>
                        <p class="text-center text-gray-400 text-sm mt-6">¬© 2024 HTIC Law Firm</p>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${API}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    loadDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loginError').textContent = 'L·ªói k·∫øt n·ªëi m√°y ch·ªß!';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // ========== DATA LOADING ==========
        async function loadDashboard() {
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="text-center">
                        <div class="animate-spin w-12 h-12 border-4 border-navy-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                        <p class="text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </div>
                </div>
            `;

            try {
                const [stats, events, news, agencies, provinces, settings] = await Promise.all([
                    fetch(`${API}/admin/stats`).then(r => r.json()),
                    fetch(`${API}/admin/events`).then(r => r.json()),
                    fetch(`${API}/admin/news`).then(r => r.json()),
                    fetch(`${API}/admin/agencies`).then(r => r.json()),
                    fetch(`${API}/admin/provinces`).then(r => r.json()),
                    fetch(`${API}/settings`).then(r => r.json())
                ]);

                allData = {
                    stats: stats.data || {},
                    events: events.data || [],
                    news: news.data || [],
                    agencies: agencies.data || [],
                    provinces: provinces.data || [],
                    settings: settings.data || {}
                };

                renderApp();
            } catch (e) {
                console.error(e);
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center">
                            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                            <p class="text-red-500 text-lg mb-4">L·ªói t·∫£i d·ªØ li·ªáu!</p>
                            <button onclick="loadDashboard()" class="px-6 py-3 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Th·ª≠ l·∫°i</button>
                        </div>
                    </div>
                `;
            }
        }

        // ========== MAIN APP RENDER ==========
        function renderApp() {
            app.innerHTML = `
                <div class="flex min-h-screen">
                    <!-- Sidebar -->
                    <div class="w-64 bg-gradient-to-b from-navy-700 to-navy-800 text-white flex flex-col shadow-xl">
                        <div class="p-6 border-b border-navy-600">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <span class="font-bold text-lg">H</span>
                                </div>
                                <div>
                                    <h1 class="text-lg font-bold">HTIC Admin</h1>
                                    <p class="text-navy-100 text-xs">Phi√™n b·∫£n 9.0</p>
                                </div>
                            </div>
                        </div>
                        <nav class="flex-1 py-4 overflow-y-auto hide-scrollbar">
                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider">T·ªïng quan</p>
                            <div onclick="setSection('dashboard')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'dashboard' ? 'active' : ''}">
                                <span>üìä</span> <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">N·ªôi dung</p>
                            <div onclick="setSection('events')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'events' ? 'active' : ''}">
                                <span>üìÖ</span> <span>L·ªãch ph√°p l√Ω</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.events.length}</span>
                            </div>
                            <div onclick="setSection('news')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'news' ? 'active' : ''}">
                                <span>üì∞</span> <span>Tin t·ª©c</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.news.length}</span>
                            </div>
                            <div onclick="setSection('agencies')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'agencies' ? 'active' : ''}">
                                <span>üè¢</span> <span>C∆° quan / T·ªï ch·ª©c</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.agencies.length}</span>
                            </div>
                            <div onclick="setSection('provinces')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'provinces' ? 'active' : ''}">
                                <span>üó∫Ô∏è</span> <span>T·ªânh / Th√†nh ph·ªë</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.provinces.length}</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">H·ªá th·ªëng</p>
                            <div onclick="setSection('settings')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'settings' ? 'active' : ''}">
                                <span>‚öôÔ∏è</span> <span>C√†i ƒë·∫∑t</span>
                            </div>
                        </nav>
                        <div class="p-4 border-t border-navy-600">
                            <div class="flex items-center gap-3 mb-4 px-2">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-sm font-bold">A</div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium">Admin</p>
                                    <p class="text-xs text-navy-300">Qu·∫£n tr·ªã vi√™n</p>
                                </div>
                            </div>
                            <button onclick="logout()" class="w-full py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2">
                                <span>üö™</span> ƒêƒÉng xu·∫•t
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 overflow-auto bg-gray-50">
                        <div id="content" class="p-6"></div>
                    </div>
                </div>
            `;
            renderSection();
        }

        function setSection(section) {
            currentSection = section;
            renderApp();
        }

        function renderSection() {
            const content = document.getElementById('content');
            switch (currentSection) {
                case 'dashboard': renderDashboard(content); break;
                case 'events': renderEvents(content); break;
                case 'news': renderNews(content); break;
                case 'agencies': renderAgencies(content); break;
                case 'provinces': renderProvinces(content); break;
                case 'settings': renderSettings(content); break;
            }
        }

        // ========== DASHBOARD ==========
        function renderDashboard(el) {
            const s = allData.stats;
            el.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                    <p class="text-gray-500">T·ªïng quan h·ªá th·ªëng HTIC Legal App</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-blue-500 transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">S·ª± ki·ªán ph√°p l√Ω</p>
                                <p class="text-3xl font-bold text-gray-900">${s.events?.total || 0}</p>
                                <p class="text-xs text-green-600 mt-1">${s.events?.active || 0} ƒëang ho·∫°t ƒë·ªông</p>
                            </div>
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">üìÖ</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-green-500 transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tin t·ª©c</p>
                                <p class="text-3xl font-bold text-gray-900">${s.news?.total || 0}</p>
                                <p class="text-xs text-gray-400 mt-1">b√†i vi·∫øt</p>
                            </div>
                            <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center text-2xl">üì∞</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-purple-500 transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">C∆° quan / T·ªï ch·ª©c</p>
                                <p class="text-3xl font-bold text-gray-900">${s.agencies?.total || 0}</p>
                                <p class="text-xs text-gray-400 mt-1">ƒë∆°n v·ªã</p>
                            </div>
                            <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">üè¢</div>
                        </div>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-6 shadow-sm border-l-4 border-orange-500 transition">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">T·ªânh / Th√†nh ph·ªë</p>
                                <p class="text-3xl font-bold text-gray-900">${allData.provinces.length}</p>
                                <p class="text-xs text-gray-400 mt-1">ƒë·ªãa ph∆∞∆°ng</p>
                            </div>
                            <div class="w-14 h-14 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">üó∫Ô∏è</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold text-gray-900 mb-4">Thao t√°c nhanh</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="setSection('events'); setTimeout(() => showEventModal(), 100)" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition flex items-center gap-2">
                            <span>üìÖ</span> Th√™m s·ª± ki·ªán
                        </button>
                        <button onclick="setSection('news'); setTimeout(() => showNewsModal(), 100)" class="px-4 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition flex items-center gap-2">
                            <span>üì∞</span> Th√™m tin t·ª©c
                        </button>
                        <button onclick="setSection('agencies'); setTimeout(() => showAgencyModal(), 100)" class="px-4 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition flex items-center gap-2">
                            <span>üè¢</span> Th√™m c∆° quan
                        </button>
                        <button onclick="setSection('provinces'); setTimeout(() => showProvinceModal(), 100)" class="px-4 py-2 bg-orange-50 text-orange-600 rounded-lg hover:bg-orange-100 transition flex items-center gap-2">
                            <span>üó∫Ô∏è</span> Th√™m t·ªânh/th√†nh
                        </button>
                    </div>
                </div>

                <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-4 border-b"><h3 class="font-bold text-gray-900">üìÖ S·ª± ki·ªán g·∫ßn ƒë√¢y</h3></div>
                        <div class="p-4 space-y-3">
                            ${allData.events.slice(0,5).map(e => {
                                const cat = CATEGORIES.find(c => c.id === e.category) || {};
                                return `<div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <span class="text-xl">${cat.icon || 'üìã'}</span>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-gray-900 truncate">${e.title}</p>
                                        <p class="text-sm text-gray-500">${cat.name || e.category} ‚Ä¢ ${e.frequency === 'monthly' ? 'Ng√†y ' + e.dayOfMonth : getFrequencyName(e.frequency)}</p>
                                    </div>
                                    ${e.isActive ? '<span class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full">Hi·ªán</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded-full">·∫®n</span>'}
                                </div>`;
                            }).join('') || '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ s·ª± ki·ªán</p>'}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="p-4 border-b"><h3 class="font-bold text-gray-900">üì∞ Tin t·ª©c m·ªõi nh·∫•t</h3></div>
                        <div class="p-4 space-y-3">
                            ${allData.news.slice(0,5).map(n => `
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="w-12 h-12 bg-gray-200 rounded-lg bg-cover bg-center" style="background-image: url('${n.image || n.imageUrl || ''}')"></div>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium text-gray-900 truncate">${n.title}</p>
                                        <p class="text-sm text-gray-500">${n.category} ‚Ä¢ ${n.date}</p>
                                    </div>
                                    ${n.isHot ? '<span class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded-full">üî• Hot</span>' : ''}
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ tin t·ª©c</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== EVENTS ==========
        function renderEvents(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">L·ªãch ph√°p l√Ω</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.events.length} s·ª± ki·ªán ph√°p l√Ω</p>
                    </div>
                    <button onclick="showEventModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m s·ª± ki·ªán
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Danh m·ª•c</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T·∫ßn su·∫•t</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng√†y</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Tr·∫°ng th√°i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.events.map(e => {
                                    const cat = CATEGORIES.find(c => c.id === e.category) || {};
                                    return `
                                    <tr class="table-row transition">
                                        <td class="px-4 py-3">
                                            <p class="font-medium text-gray-900">${e.title}</p>
                                            <p class="text-sm text-gray-500 truncate max-w-xs">${stripHtml(e.description || '')}</p>
                                        </td>
                                        <td class="px-4 py-3">
                                            <span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full">${cat.icon || ''} ${cat.name || e.category}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${getFrequencyName(e.frequency)}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${e.specificDate || (e.dayOfMonth ? 'Ng√†y ' + e.dayOfMonth : '-')}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 ${e.isActive ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'} text-xs rounded-full">${e.isActive ? '‚úì Hi·ªán' : '‚óã ·∫®n'}</span>
                                        </td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick='showEventModal(${JSON.stringify(e).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-3 text-sm">S·ª≠a</button>
                                            <button onclick="deleteEvent(${e.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                                ${allData.events.length === 0 ? '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ s·ª± ki·ªán n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showEventModal(event = null) {
            const isEdit = !!event;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a s·ª± ki·ªán' : 'Th√™m s·ª± ki·ªán m·ªõi'}</h3>
                                    <p class="text-navy-100 text-sm mt-1">ƒêi·ªÅn th√¥ng tin s·ª± ki·ªán ph√°p l√Ω</p>
                                </div>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ti√™u ƒë·ªÅ s·ª± ki·ªán <span class="text-red-500">*</span></label>
                                <input type="text" id="eventTitle" value="${event?.title || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition" placeholder="VD: N·ªôp t·ªù khai thu·∫ø GTGT th√°ng">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Danh m·ª•c <span class="text-red-500">*</span></label>
                                    <select id="eventCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                        ${CATEGORIES.map(c => `<option value="${c.id}" ${event?.category === c.id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T·∫ßn su·∫•t <span class="text-red-500">*</span></label>
                                    <select id="eventFrequency" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                        ${FREQUENCIES.map(f => `<option value="${f.id}" ${event?.frequency === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ng√†y trong th√°ng</label>
                                    <input type="number" id="eventDayOfMonth" min="1" max="31" value="${event?.dayOfMonth || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition" placeholder="VD: 20">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ho·∫∑c ng√†y c·ª• th·ªÉ</label>
                                    <input type="date" id="eventSpecificDate" value="${event?.specificDate || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M√¥ t·∫£ chi ti·∫øt</label>
                                <div id="eventDescriptionEditor"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">CƒÉn c·ª© ph√°p l√Ω</label>
                                <input type="text" id="eventLegalRef" value="${event?.legalReference || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition" placeholder="VD: Theo ƒêi·ªÅu 44 Lu·∫≠t Qu·∫£n l√Ω thu·∫ø 2019">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M·ª©c ph·∫°t n·∫øu vi ph·∫°m</label>
                                <input type="text" id="eventPenalty" value="${event?.penalty || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition" placeholder="VD: Ph·∫°t 2-5 tri·ªáu ƒë·ªìng n·∫øu n·ªôp ch·∫≠m">
                            </div>

                            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                                <input type="checkbox" id="eventIsActive" ${event?.isActive !== false ? 'checked' : ''} class="w-5 h-5 accent-navy-600">
                                <label class="text-sm font-semibold text-gray-700">Hi·ªÉn th·ªã trong ·ª©ng d·ª•ng</label>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveEvent(${event?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                quillEditor = new Quill('#eventDescriptionEditor', {
                    theme: 'snow',
                    placeholder: 'Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ s·ª± ki·ªán...',
                    modules: {
                        toolbar: [
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['link'],
                            ['clean']
                        ]
                    }
                });
                if (event?.description) {
                    quillEditor.root.innerHTML = event.description;
                }
            }, 100);
        }

        async function saveEvent(id) {
            const description = quillEditor ? quillEditor.root.innerHTML : '';
            const data = {
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                frequency: document.getElementById('eventFrequency').value,
                dayOfMonth: parseInt(document.getElementById('eventDayOfMonth').value) || null,
                specificDate: document.getElementById('eventSpecificDate').value || null,
                description: description,
                legalReference: document.getElementById('eventLegalRef').value,
                penalty: document.getElementById('eventPenalty').value,
                isActive: document.getElementById('eventIsActive').checked
            };

            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ s·ª± ki·ªán!'); return; }

            const url = id ? `${API}/admin/events/${id}` : `${API}/admin/events`;
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteEvent(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán n√†y?')) return;
            try {
                await fetch(`${API}/admin/events/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('L·ªói x√≥a d·ªØ li·ªáu!'); }
        }

        // ========== NEWS ==========
function renderNews(el) {
    // S·∫Øp x·∫øp tin m·ªõi nh·∫•t l√™n ƒë·∫ßu (theo id gi·∫£m d·∫ßn)
    const sortedNews = [...allData.news].sort((a, b) => b.id - a.id);
    
    el.innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Tin t·ª©c ph√°p lu·∫≠t</h2>
                <p class="text-gray-500">Qu·∫£n l√Ω ${allData.news.length} b√†i vi·∫øt</p>
            </div>
            <button onclick="showNewsModal()" class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                <span>+</span> Th√™m tin t·ª©c
            </button>
        </div>

        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-16">·∫¢nh</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Danh m·ª•c</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Ng√†y ƒëƒÉng</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-20">N·ªïi b·∫≠t</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-28">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
                        ${sortedNews.map(n => `
                        <tr class="table-row transition hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <div class="w-14 h-14 bg-gray-200 rounded-lg bg-cover bg-center" style="background-image: url('${n.image || n.imageUrl || 'https://images.unsplash.com/photo-1589829545856-d10d557cf95f?w=100'}')"></div>
                            </td>
                            <td class="px-4 py-3">
                                <p class="font-medium text-gray-900 line-clamp-1">${n.title}</p>
                                <p class="text-sm text-gray-500 line-clamp-1">${stripHtml(n.summary || n.content || '')}</p>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full">${n.category}</span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-600">${n.date}</td>
                            <td class="px-4 py-3 text-center">
                                ${n.isHot ? '<span class="px-2 py-1 bg-red-100 text-red-600 text-xs font-bold rounded-full">üî• Hot</span>' : '<span class="text-gray-400">-</span>'}
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button onclick='showNewsModal(${JSON.stringify(n).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-2 text-sm">S·ª≠a</button>
                                <button onclick="deleteNews(${n.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                            </td>
                        </tr>
                        `).join('')}
                        ${allData.news.length === 0 ? '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ tin t·ª©c n√†o</td></tr>' : ''}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

        function showNewsModal(news = null) {
            const isEdit = !!news;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-green-500 to-green-600 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a tin t·ª©c' : 'Th√™m tin t·ª©c m·ªõi'}</h3>
                                    <p class="text-green-100 text-sm mt-1">So·∫°n th·∫£o b√†i vi·∫øt ph√°p lu·∫≠t</p>
                                </div>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ti√™u ƒë·ªÅ b√†i vi·∫øt <span class="text-red-500">*</span></label>
                                <input type="text" id="newsTitle" value="${news?.title || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt...">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Danh m·ª•c</label>
                                    <select id="newsCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition">
                                        ${NEWS_CATEGORIES.map(c => `<option ${news?.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ng√†y ƒëƒÉng</label>
                                    <input type="text" id="newsDate" value="${news?.date || new Date().toLocaleDateString('vi-VN')}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="DD/MM/YYYY">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Link ·∫£nh ƒë·∫°i di·ªán</label>
                                <input type="text" id="newsImage" value="${news?.image || news?.imageUrl || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="https://...">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√≥m t·∫Øt</label>
                                <textarea id="newsSummary" rows="2" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none transition" placeholder="T√≥m t·∫Øt ng·∫Øn g·ªçn n·ªôi dung b√†i vi·∫øt...">${news?.summary || ''}</textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">N·ªôi dung b√†i vi·∫øt <span class="text-red-500">*</span></label>
                                <div id="newsContentEditor"></div>
                            </div>

                            <div class="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                                <input type="checkbox" id="newsIsHot" ${news?.isHot ? 'checked' : ''} class="w-5 h-5 accent-orange-500">
                                <label class="text-sm font-semibold text-gray-700">üî• ƒê√°nh d·∫•u l√† tin n·ªïi b·∫≠t</label>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveNews(${news?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'ƒêƒÉng b√†i'}</button>
                        </div>
                    </div>
                </div>
            `;

            setTimeout(() => {
                quillEditor = new Quill('#newsContentEditor', {
                    theme: 'snow',
                    placeholder: 'Nh·∫≠p n·ªôi dung b√†i vi·∫øt...',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'script': 'sub' }, { 'script': 'super' }],
                            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                            [{ 'indent': '-1' }, { 'indent': '+1' }],
                            [{ 'direction': 'rtl' }],
                            [{ 'align': [] }],
                            ['link', 'image', 'video'],
                            ['blockquote', 'code-block'],
                            ['clean']
                        ]
                    }
                });
                if (news?.content) {
                    quillEditor.root.innerHTML = news.content;
                }
            }, 100);
        }

        async function saveNews(id) {
            const content = quillEditor ? quillEditor.root.innerHTML : '';
            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                date: document.getElementById('newsDate').value,
                summary: document.getElementById('newsSummary').value,
                content: content,
                image: document.getElementById('newsImage').value,
                isHot: document.getElementById('newsIsHot').checked
            };

            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt!'); return; }

            const url = id ? `${API}/admin/news/${id}` : `${API}/admin/news`;
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteNews(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin t·ª©c n√†y?')) return;
            try {
                await fetch(`${API}/admin/news/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('L·ªói x√≥a d·ªØ li·ªáu!'); }
        }

        // ========== AGENCIES ==========
        function renderAgencies(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Danh b·∫° c∆° quan / T·ªï ch·ª©c</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.agencies.length} ƒë∆°n v·ªã</p>
                    </div>
                    <button onclick="showAgencyModal()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m c∆° quan
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T√™n c∆° quan</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Lo·∫°i h√¨nh</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T·ªânh/TP</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ƒê·ªãa ch·ªâ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">ƒêi·ªán tho·∫°i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.agencies.map(a => {
                                    const cat = AGENCY_CATEGORIES.find(c => c.id === a.category) || {};
                                    const province = allData.provinces.find(p => p.id === a.provinceId) || {};
                                    return `
                                    <tr class="table-row transition">
                                        <td class="px-4 py-3">
                                            <p class="font-medium text-gray-900">${a.name}</p>
                                            ${a.website ? `<p class="text-xs text-blue-600">${a.website}</p>` : ''}
                                        </td>
                                        <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full">${cat.icon || ''} ${cat.name || a.category}</span></td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${province.name || a.provinceId || '-'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate">${a.address || '-'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${a.phone || '-'}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick='showAgencyModal(${JSON.stringify(a).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-3 text-sm">S·ª≠a</button>
                                            <button onclick="deleteAgency(${a.id})" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                                ${allData.agencies.length === 0 ? '<tr><td colspan="6" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ c∆° quan n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showAgencyModal(agency = null) {
            const isEdit = !!agency;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a c∆° quan' : 'Th√™m c∆° quan m·ªõi'}</h3>
                                    <p class="text-purple-100 text-sm mt-1">Th√¥ng tin c∆° quan / t·ªï ch·ª©c</p>
                                </div>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n c∆° quan <span class="text-red-500">*</span></label>
                                <input type="text" id="agencyName" value="${agency?.name || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="VD: C·ª•c Thu·∫ø TP. H√† N·ªôi">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Lo·∫°i h√¨nh</label>
                                    <select id="agencyCategory" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                        ${AGENCY_CATEGORIES.map(c => `<option value="${c.id}" ${agency?.category === c.id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">T·ªânh / Th√†nh ph·ªë</label>
                                    <select id="agencyProvince" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition">
                                        <option value="">-- Ch·ªçn t·ªânh/TP --</option>
                                        ${allData.provinces.map(p => `<option value="${p.id}" ${agency?.provinceId === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</label>
                                <input type="text" id="agencyAddress" value="${agency?.address || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="text" id="agencyPhone" value="${agency?.phone || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="024 xxxx xxxx">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
                                    <input type="text" id="agencyWebsite" value="${agency?.website || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:outline-none transition" placeholder="www.example.gov.vn">
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveAgency(${agency?.id || 'null'})" class="px-6 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveAgency(id) {
            const data = {
                name: document.getElementById('agencyName').value,
                category: document.getElementById('agencyCategory').value,
                provinceId: document.getElementById('agencyProvince').value,
                address: document.getElementById('agencyAddress').value,
                phone: document.getElementById('agencyPhone').value,
                website: document.getElementById('agencyWebsite').value
            };

            if (!data.name) { alert('Vui l√≤ng nh·∫≠p t√™n c∆° quan!'); return; }

            // Note: Server kh√¥ng c√≥ PUT cho agencies, ch·ªâ c√≥ POST v√† DELETE
            // N·∫øu c·∫ßn s·ª≠a th√¨ x√≥a c≈© v√† th√™m m·ªõi
            const url = `${API}/admin/agencies`;
            const method = 'POST';

            try {
                if (id) {
                    // X√≥a c≈© tr∆∞·ªõc
                    await fetch(`${API}/admin/agencies/${id}`, { method: 'DELETE' });
                }
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteAgency(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c∆° quan n√†y?')) return;
            try {
                await fetch(`${API}/admin/agencies/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('L·ªói x√≥a d·ªØ li·ªáu!'); }
        }

        // ========== PROVINCES ==========
        function renderProvinces(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Danh s√°ch T·ªânh / Th√†nh ph·ªë</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.provinces.length} ƒë·ªãa ph∆∞∆°ng</p>
                    </div>
                    <button onclick="showProvinceModal()" class="px-4 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-semibold hover:opacity-90 transition shadow-md flex items-center gap-2">
                        <span>+</span> Th√™m t·ªânh/TP
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">M√£</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T√™n t·ªânh / th√†nh ph·ªë</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">S·ªë c∆° quan</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.provinces.map(p => {
                                    const agencyCount = allData.agencies.filter(a => a.provinceId === p.id).length;
                                    return `
                                    <tr class="table-row transition">
                                        <td class="px-4 py-3 font-mono text-sm text-gray-600">${p.id}</td>
                                        <td class="px-4 py-3 font-medium text-gray-900">${p.name}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${agencyCount} ƒë∆°n v·ªã</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick='showProvinceModal(${JSON.stringify(p).replace(/'/g, "&#39;")})' class="text-blue-600 hover:text-blue-800 mr-3 text-sm">S·ª≠a</button>
                                            <button onclick="deleteProvince('${p.id}')" class="text-red-600 hover:text-red-800 text-sm">X√≥a</button>
                                        </td>
                                    </tr>`;
                                }).join('')}
                                ${allData.provinces.length === 0 ? '<tr><td colspan="4" class="px-4 py-12 text-center text-gray-500">Ch∆∞a c√≥ t·ªânh/th√†nh ph·ªë n√†o</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function showProvinceModal(province = null) {
            const isEdit = !!province;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-md max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold">${isEdit ? 'Ch·ªânh s·ª≠a' : 'Th√™m'} T·ªânh / Th√†nh ph·ªë</h3>
                                </div>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M√£ t·ªânh/TP <span class="text-red-500">*</span></label>
                                <input type="text" id="provinceId" value="${province?.id || ''}" ${isEdit ? 'readonly' : ''} class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:outline-none transition ${isEdit ? 'bg-gray-100' : ''}" placeholder="VD: hanoi, hcm, danang...">
                                ${isEdit ? '<p class="text-xs text-gray-500 mt-1">M√£ kh√¥ng th·ªÉ thay ƒë·ªïi</p>' : ''}
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n t·ªânh/th√†nh ph·ªë <span class="text-red-500">*</span></label>
                                <input type="text" id="provinceName" value="${province?.name || ''}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-orange-500 focus:outline-none transition" placeholder="VD: H√† N·ªôi, TP. H·ªì Ch√≠ Minh...">
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100 transition font-medium">H·ªßy</button>
                            <button onclick="saveProvince('${province?.id || ''}')" class="px-6 py-2 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl hover:opacity-90 transition font-medium shadow-md">${isEdit ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveProvince(oldId) {
            const id = document.getElementById('provinceId').value.trim();
            const name = document.getElementById('provinceName').value.trim();

            if (!id || !name) { alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!'); return; }

            const data = { id, name };
            const url = oldId ? `${API}/admin/provinces/${oldId}` : `${API}/admin/provinces`;
            const method = oldId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await res.json();
                if (!result.success) {
                    alert(result.message || 'L·ªói l∆∞u d·ªØ li·ªáu!');
                    return;
                }
                closeModal();
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u d·ªØ li·ªáu!'); }
        }

        async function deleteProvince(id) {
            const agencyCount = allData.agencies.filter(a => a.provinceId === id).length;
            if (agencyCount > 0) {
                alert(`Kh√¥ng th·ªÉ x√≥a! C√≥ ${agencyCount} c∆° quan ƒëang thu·ªôc t·ªânh/TP n√†y.`);
                return;
            }
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·ªânh/TP n√†y?')) return;
            try {
                await fetch(`${API}/admin/provinces/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('L·ªói x√≥a d·ªØ li·ªáu!'); }
        }

        // ========== SETTINGS ==========
        function renderSettings(el) {
            const s = allData.settings || {};
            el.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                    <p class="text-gray-500">C·∫•u h√¨nh th√¥ng tin c√¥ng ty v√† ·ª©ng d·ª•ng</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>üè¢</span> Th√¥ng tin c√¥ng ty</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n c√¥ng ty</label>
                            <input type="text" id="settingCompanyName" value="${s.companyName || 'HTIC LAW FIRM'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Website</label>
                            <input type="text" id="settingWebsite" value="${s.website || 'www.htic.com.vn'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Hotline</label>
                            <input type="text" id="settingPhone" value="${s.phone || '0379 044 299'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email li√™n h·ªá</label>
                            <input type="text" id="settingEmail" value="${s.email || 'contact@htic.com.vn'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</label>
                            <textarea id="settingAddress" rows="2" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none transition">${s.address || 'H√† N·ªôi, Vi·ªát Nam'}</textarea>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button onclick="saveSettings()" class="px-8 py-3 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl font-semibold hover:opacity-90 transition shadow-lg flex items-center gap-2">
                            <span>üíæ</span> L∆∞u c√†i ƒë·∫∑t
                        </button>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const data = {
                companyName: document.getElementById('settingCompanyName').value,
                website: document.getElementById('settingWebsite').value,
                phone: document.getElementById('settingPhone').value,
                email: document.getElementById('settingEmail').value,
                address: document.getElementById('settingAddress').value
            };
            try {
                await fetch(`${API}/admin/settings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                alert('‚úì ƒê√£ l∆∞u c√†i ƒë·∫∑t th√†nh c√¥ng!');
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u c√†i ƒë·∫∑t!'); }
        }

        // ========== HELPERS ==========
        function closeModal() { modalRoot.innerHTML = ''; quillEditor = null; }
        function stripHtml(html) { const t = document.createElement('div'); t.innerHTML = html; return t.textContent || t.innerText || ''; }
        function getFrequencyName(freq) { const f = FREQUENCIES.find(x => x.id === freq); return f ? f.name : freq; }

        // ========== START ==========
        checkAuth();
    </script>
</body>
</html>
