<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - HTIC Legal App v9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config={theme:{extend:{colors:{navy:{50:'#e8eef5',100:'#c5d4e8',500:'#3d6d9e',600:'#1e3a5f',700:'#162d4a'}}}}}</script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 3px solid #f97316; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>
    <div id="modal-root"></div>
    
    <script>
        const API = '/api';
        let token = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';
        let allData = { events: [], news: [], agencies: [], users: [], lawyers: [], payments: [], stats: {} };

        const app = document.getElementById('app');
        const modalRoot = document.getElementById('modal-root');

        const CATEGORIES = [
            { id: 'tax', name: 'Thue', icon: 'üí∞', color: 'blue' },
            { id: 'insurance', name: 'Bao hiem', icon: 'üè•', color: 'green' },
            { id: 'labor', name: 'Lao dong', icon: 'üë∑', color: 'orange' },
            { id: 'safety', name: 'An toan', icon: 'üõ°Ô∏è', color: 'red' },
            { id: 'environment', name: 'Moi truong', icon: 'üåø', color: 'emerald' },
            { id: 'investment', name: 'Dau tu', icon: 'üìà', color: 'purple' },
            { id: 'report', name: 'Bao cao', icon: 'üìä', color: 'indigo' },
            { id: 'license', name: 'Giay phep', icon: 'üìã', color: 'gray' },
            { id: 'holiday', name: 'Nghi le', icon: 'üéâ', color: 'pink' }
        ];

        const FREQUENCIES = [
            { id: 'once', name: 'Mot lan' },
            { id: 'monthly', name: 'Hang thang' },
            { id: 'quarterly', name: 'Hang quy' },
            { id: 'yearly', name: 'Hang nam' }
        ];

        const NEWS_CATEGORIES = ['Thue', 'BHXH', 'Doanh nghiep', 'Lao dong', 'Phap luat'];

        const AGENCY_CATEGORIES = [
            { id: 'government', name: 'Co quan Nha nuoc' },
            { id: 'lawfirm', name: 'VP Luat su / Cong ty Luat' },
            { id: 'notary', name: 'Van phong Cong chung' },
            { id: 'bailiff', name: 'VP Thua phat lai' }
        ];

        // ========== AUTH ==========
        function checkAuth() {
            if (!token) showLogin();
            else loadDashboard();
        }

        function showLogin() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-600 to-navy-700 p-4">
                    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-navy-600 to-navy-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <span class="text-white text-3xl font-bold">H</span>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900">HTIC Legal Admin</h1>
                            <p class="text-gray-500 mt-2">Dang nhap de quan ly</p>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ten dang nhap</label>
                                <input type="text" id="username" value="admin" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Mat khau</label>
                                <input type="password" id="password" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none" onkeypress="if(event.key==='Enter')login()">
                            </div>
                            <button onclick="login()" class="w-full bg-navy-600 text-white py-3 rounded-xl font-bold hover:bg-navy-700 transition">Dang nhap</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(`${API}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    loadDashboard();
                } else {
                    document.getElementById('loginError').textContent = data.message || 'Sai thong tin';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loginError').textContent = 'Loi ket noi server';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // ========== DASHBOARD ==========
        async function loadDashboard() {
            app.innerHTML = `<div class="flex items-center justify-center min-h-screen"><div class="text-center"><div class="animate-spin w-12 h-12 border-4 border-navy-600 border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-gray-500">Dang tai...</p></div></div>`;
            
            try {
                const [stats, events, news, agencies, users, lawyers, payments] = await Promise.all([
                    fetch(`${API}/admin/stats`).then(r => r.json()),
                    fetch(`${API}/admin/events`).then(r => r.json()),
                    fetch(`${API}/admin/news`).then(r => r.json()),
                    fetch(`${API}/admin/agencies`).then(r => r.json()),
                    fetch(`${API}/admin/users`).then(r => r.json()),
                    fetch(`${API}/admin/lawyers`).then(r => r.json()),
                    fetch(`${API}/admin/payments`).then(r => r.json())
                ]);
                
                allData = {
                    stats: stats.data || {},
                    events: events.data || [],
                    news: news.data || [],
                    agencies: agencies.data || [],
                    users: users.data || [],
                    lawyers: lawyers.data || [],
                    payments: payments.data || []
                };
                
                renderApp();
            } catch (e) {
                console.error(e);
                app.innerHTML = `<div class="flex items-center justify-center min-h-screen"><div class="text-center text-red-500"><p>Loi tai du lieu</p><button onclick="loadDashboard()" class="mt-4 px-4 py-2 bg-navy-600 text-white rounded-lg">Thu lai</button></div></div>`;
            }
        }

        function renderApp() {
            app.innerHTML = `
                <div class="flex min-h-screen">
                    <!-- Sidebar -->
                    <div class="w-64 bg-navy-700 text-white flex flex-col">
                        <div class="p-6 border-b border-navy-600">
                            <h1 class="text-xl font-bold">HTIC Admin</h1>
                            <p class="text-navy-100 text-sm mt-1">v9.0 - Legal App</p>
                        </div>
                        <nav class="flex-1 py-4">
                            <div onclick="setSection('dashboard')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'dashboard' ? 'active' : ''}">
                                <span>üìä</span> Dashboard
                            </div>
                            <div onclick="setSection('events')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'events' ? 'active' : ''}">
                                <span>üìÖ</span> Lich phap ly
                            </div>
                            <div onclick="setSection('news')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'news' ? 'active' : ''}">
                                <span>üì∞</span> Tin tuc
                            </div>
                            <div onclick="setSection('agencies')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'agencies' ? 'active' : ''}">
                                <span>üè¢</span> Co quan
                            </div>
                            <div class="border-t border-navy-600 my-2"></div>
                            <div onclick="setSection('users')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'users' ? 'active' : ''}">
                                <span>üë•</span> Nguoi dung
                            </div>
                            <div onclick="setSection('lawyers')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'lawyers' ? 'active' : ''}">
                                <span>‚öñÔ∏è</span> Luat su
                            </div>
                            <div onclick="setSection('payments')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'payments' ? 'active' : ''}">
                                <span>üí≥</span> Thanh toan
                            </div>
                            <div class="border-t border-navy-600 my-2"></div>
                            <div onclick="setSection('settings')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'settings' ? 'active' : ''}">
                                <span>‚öôÔ∏è</span> Cai dat
                            </div>
                        </nav>
                        <div class="p-4 border-t border-navy-600">
                            <button onclick="logout()" class="w-full py-2 bg-red-500 hover:bg-red-600 rounded-lg text-sm font-semibold transition">Dang xuat</button>
                        </div>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="flex-1 overflow-auto">
                        <div id="content" class="p-6"></div>
                    </div>
                </div>
            `;
            renderSection();
        }

        function setSection(section) {
            currentSection = section;
            renderApp();
        }

        function renderSection() {
            const content = document.getElementById('content');
            switch (currentSection) {
                case 'dashboard': renderDashboard(content); break;
                case 'events': renderEvents(content); break;
                case 'news': renderNews(content); break;
                case 'agencies': renderAgencies(content); break;
                case 'users': renderUsers(content); break;
                case 'lawyers': renderLawyers(content); break;
                case 'payments': renderPayments(content); break;
                case 'settings': renderSettings(content); break;
            }
        }

        // ========== DASHBOARD SECTION ==========
        function renderDashboard(el) {
            const s = allData.stats;
            el.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Su kien phap ly</p>
                                <p class="text-3xl font-bold text-gray-900">${s.events?.total || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">üìÖ</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Tin tuc</p>
                                <p class="text-3xl font-bold text-gray-900">${s.news?.total || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">üì∞</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Nguoi dung</p>
                                <p class="text-3xl font-bold text-gray-900">${s.users?.total || 0}</p>
                                <p class="text-xs text-orange-500">${s.users?.pro || 0} Pro</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">üë•</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm border-l-4 border-orange-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Thanh toan</p>
                                <p class="text-3xl font-bold text-gray-900">${s.payments?.completed || 0}/${s.payments?.total || 0}</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center text-2xl">üí≥</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-900 mb-4">Nguoi dung moi</h3>
                        <div class="space-y-3">
                            ${allData.users.slice(-5).reverse().map(u => `
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="w-10 h-10 bg-navy-100 rounded-full flex items-center justify-center font-bold text-navy-600">${(u.name || u.email || '?')[0].toUpperCase()}</div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">${u.name || 'Chua dat ten'}</p>
                                        <p class="text-sm text-gray-500">${u.email}</p>
                                    </div>
                                    ${u.isPro ? '<span class="px-2 py-1 bg-orange-100 text-orange-600 text-xs font-bold rounded">PRO</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded">Free</span>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-900 mb-4">Thanh toan gan day</h3>
                        <div class="space-y-3">
                            ${allData.payments.slice(-5).reverse().map(p => `
                                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="w-10 h-10 ${p.status === 'completed' ? 'bg-green-100' : 'bg-yellow-100'} rounded-full flex items-center justify-center">
                                        ${p.status === 'completed' ? '‚úÖ' : '‚è≥'}
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">${p.orderId}</p>
                                        <p class="text-sm text-gray-500">${p.package || 'N/A'} - ${formatCurrency(p.amount)}</p>
                                    </div>
                                    <span class="px-2 py-1 ${p.status === 'completed' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'} text-xs font-bold rounded">${p.status}</span>
                                </div>
                            `).join('') || '<p class="text-gray-500 text-center py-4">Chua co thanh toan</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== EVENTS SECTION ==========
        function renderEvents(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Lich phap ly (${allData.events.length})</h2>
                    <button onclick="showEventModal()" class="px-4 py-2 bg-navy-600 text-white rounded-lg font-semibold hover:bg-navy-700 transition">+ Them su kien</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Tieu de</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Loai</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Tan suat</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ngay</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Trang thai</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao tac</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${allData.events.map(e => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <p class="font-medium text-gray-900">${e.title}</p>
                                        <p class="text-sm text-gray-500 truncate max-w-xs">${e.description || ''}</p>
                                    </td>
                                    <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded">${e.category}</span></td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${e.frequency}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${e.specificDate || (e.dayOfMonth ? 'Ngay ' + e.dayOfMonth : '-')}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 ${e.isActive ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-500'} text-xs rounded">${e.isActive ? 'Hien' : 'An'}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showEventModal(${JSON.stringify(e)})' class="text-blue-600 hover:text-blue-800 mr-2">Sua</button>
                                        <button onclick="deleteEvent(${e.id})" class="text-red-600 hover:text-red-800">Xoa</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showEventModal(event = null) {
            const isEdit = !!event;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b flex items-center justify-between">
                            <h3 class="text-xl font-bold">${isEdit ? 'Sua su kien' : 'Them su kien moi'}</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Tieu de *</label>
                                <input type="text" id="eventTitle" value="${event?.title || ''}" class="w-full p-3 border rounded-lg focus:border-navy-500 focus:outline-none">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Loai *</label>
                                    <select id="eventCategory" class="w-full p-3 border rounded-lg">
                                        ${CATEGORIES.map(c => `<option value="${c.id}" ${event?.category === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tan suat *</label>
                                    <select id="eventFrequency" class="w-full p-3 border rounded-lg" onchange="toggleDateFields()">
                                        ${FREQUENCIES.map(f => `<option value="${f.id}" ${event?.frequency === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div id="dateFields" class="grid grid-cols-2 gap-4">
                                <div id="dayOfMonthField">
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Ngay trong thang</label>
                                    <input type="number" id="eventDayOfMonth" min="1" max="31" value="${event?.dayOfMonth || ''}" class="w-full p-3 border rounded-lg">
                                </div>
                                <div id="specificDateField">
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Ngay cu the</label>
                                    <input type="date" id="eventSpecificDate" value="${event?.specificDate || ''}" class="w-full p-3 border rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Mo ta</label>
                                <textarea id="eventDescription" rows="3" class="w-full p-3 border rounded-lg">${event?.description || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Can cu phap ly</label>
                                <input type="text" id="eventLegalRef" value="${event?.legalReference || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Muc phat</label>
                                <input type="text" id="eventPenalty" value="${event?.penalty || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="eventIsActive" ${event?.isActive !== false ? 'checked' : ''} class="w-5 h-5">
                                <label class="text-sm font-semibold text-gray-700">Hien thi trong app</label>
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Huy</button>
                            <button onclick="saveEvent(${event?.id || 'null'})" class="px-4 py-2 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Luu</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveEvent(id) {
            const data = {
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                frequency: document.getElementById('eventFrequency').value,
                dayOfMonth: parseInt(document.getElementById('eventDayOfMonth').value) || null,
                specificDate: document.getElementById('eventSpecificDate').value || null,
                description: document.getElementById('eventDescription').value,
                legalReference: document.getElementById('eventLegalRef').value,
                penalty: document.getElementById('eventPenalty').value,
                isActive: document.getElementById('eventIsActive').checked
            };

            const url = id ? `${API}/admin/events/${id}` : `${API}/admin/events`;
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) {
                alert('Loi luu du lieu');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('Xac nhan xoa?')) return;
            try {
                await fetch(`${API}/admin/events/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) {
                alert('Loi xoa');
            }
        }

        // ========== NEWS SECTION ==========
        function renderNews(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Tin tuc (${allData.news.length})</h2>
                    <button onclick="showNewsModal()" class="px-4 py-2 bg-navy-600 text-white rounded-lg font-semibold hover:bg-navy-700 transition">+ Them tin</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${allData.news.map(n => `
                        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                            <div class="h-40 bg-gray-200 bg-cover bg-center" style="background-image: url('${n.imageUrl || ''}')"></div>
                            <div class="p-4">
                                <span class="text-xs text-orange-600 font-semibold">${n.category}</span>
                                <h3 class="font-bold text-gray-900 mt-1 line-clamp-2">${n.title}</h3>
                                <p class="text-sm text-gray-500 mt-2">${n.date}</p>
                                <div class="flex gap-2 mt-4">
                                    <button onclick='showNewsModal(${JSON.stringify(n)})' class="flex-1 py-2 text-center text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50">Sua</button>
                                    <button onclick="deleteNews(${n.id})" class="flex-1 py-2 text-center text-red-600 border border-red-600 rounded-lg hover:bg-red-50">Xoa</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showNewsModal(news = null) {
            const isEdit = !!news;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b flex items-center justify-between">
                            <h3 class="text-xl font-bold">${isEdit ? 'Sua tin' : 'Them tin moi'}</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Tieu de *</label>
                                <input type="text" id="newsTitle" value="${news?.title || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Danh muc</label>
                                <select id="newsCategory" class="w-full p-3 border rounded-lg">
                                    ${NEWS_CATEGORIES.map(c => `<option ${news?.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Tom tat</label>
                                <textarea id="newsSummary" rows="2" class="w-full p-3 border rounded-lg">${news?.summary || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Noi dung</label>
                                <textarea id="newsContent" rows="5" class="w-full p-3 border rounded-lg">${news?.content || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Link anh</label>
                                <input type="text" id="newsImage" value="${news?.imageUrl || ''}" class="w-full p-3 border rounded-lg" placeholder="https://...">
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="newsIsHot" ${news?.isHot ? 'checked' : ''} class="w-5 h-5">
                                <label class="text-sm font-semibold text-gray-700">Tin noi bat</label>
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Huy</button>
                            <button onclick="saveNews(${news?.id || 'null'})" class="px-4 py-2 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Luu</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveNews(id) {
            const data = {
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                summary: document.getElementById('newsSummary').value,
                content: document.getElementById('newsContent').value,
                imageUrl: document.getElementById('newsImage').value,
                isHot: document.getElementById('newsIsHot').checked
            };

            const url = id ? `${API}/admin/news/${id}` : `${API}/admin/news`;
            const method = id ? 'PUT' : 'POST';

            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) {
                alert('Loi');
            }
        }

        async function deleteNews(id) {
            if (!confirm('Xac nhan xoa?')) return;
            try {
                await fetch(`${API}/admin/news/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) {
                alert('Loi');
            }
        }

        // ========== AGENCIES SECTION ==========
        function renderAgencies(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Co quan (${allData.agencies.length})</h2>
                    <button onclick="showAgencyModal()" class="px-4 py-2 bg-navy-600 text-white rounded-lg font-semibold hover:bg-navy-700 transition">+ Them</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ten</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Loai</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Dia chi</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">SDT</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao tac</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${allData.agencies.map(a => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 font-medium text-gray-900">${a.name}</td>
                                    <td class="px-4 py-3"><span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${a.category}</span></td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${a.address || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${a.phone || '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showAgencyModal(${JSON.stringify(a)})' class="text-blue-600 hover:text-blue-800 mr-2">Sua</button>
                                        <button onclick="deleteAgency(${a.id})" class="text-red-600 hover:text-red-800">Xoa</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAgencyModal(agency = null) {
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b flex items-center justify-between">
                            <h3 class="text-xl font-bold">${agency ? 'Sua' : 'Them'} co quan</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ten *</label>
                                <input type="text" id="agencyName" value="${agency?.name || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Loai</label>
                                <select id="agencyCategory" class="w-full p-3 border rounded-lg">
                                    ${AGENCY_CATEGORIES.map(c => `<option value="${c.id}" ${agency?.category === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Dia chi</label>
                                <input type="text" id="agencyAddress" value="${agency?.address || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">SDT</label>
                                <input type="text" id="agencyPhone" value="${agency?.phone || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Huy</button>
                            <button onclick="saveAgency(${agency?.id || 'null'})" class="px-4 py-2 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Luu</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveAgency(id) {
            const data = {
                name: document.getElementById('agencyName').value,
                category: document.getElementById('agencyCategory').value,
                address: document.getElementById('agencyAddress').value,
                phone: document.getElementById('agencyPhone').value
            };
            const url = id ? `${API}/admin/agencies/${id}` : `${API}/admin/agencies`;
            const method = id ? 'PUT' : 'POST';
            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        async function deleteAgency(id) {
            if (!confirm('Xac nhan xoa?')) return;
            try {
                await fetch(`${API}/admin/agencies/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        // ========== USERS SECTION ==========
        function renderUsers(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Nguoi dung (${allData.users.length})</h2>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Nguoi dung</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Email</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">SDT</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Cong ty</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Goi</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao tac</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${allData.users.map(u => `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-navy-100 rounded-full flex items-center justify-center font-bold text-navy-600">${(u.name || u.email || '?')[0].toUpperCase()}</div>
                                            <div>
                                                <p class="font-medium text-gray-900">${u.name || 'Chua dat ten'}</p>
                                                <p class="text-xs text-gray-500">${u.provider || 'email'}</p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${u.email}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${u.phone || '-'}</td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${u.company || '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        ${u.isPro 
                                            ? `<span class="px-2 py-1 bg-orange-100 text-orange-600 text-xs font-bold rounded">PRO</span><br><span class="text-xs text-gray-500">${u.proExpiry || ''}</span>`
                                            : '<span class="px-2 py-1 bg-gray-100 text-gray-500 text-xs rounded">Free</span>'
                                        }
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button onclick='showUserModal(${JSON.stringify(u)})' class="text-blue-600 hover:text-blue-800 mr-2">Sua</button>
                                        <button onclick="deleteUser(${u.id})" class="text-red-600 hover:text-red-800">Xoa</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showUserModal(user) {
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b flex items-center justify-between">
                            <h3 class="text-xl font-bold">Sua thong tin nguoi dung</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ten</label>
                                <input type="text" id="userName" value="${user.name || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <input type="text" value="${user.email}" disabled class="w-full p-3 border rounded-lg bg-gray-100">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">SDT</label>
                                <input type="text" id="userPhone" value="${user.phone || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Cong ty</label>
                                <input type="text" id="userCompany" value="${user.company || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ma so thue</label>
                                <input type="text" id="userTaxCode" value="${user.taxCode || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Dia chi</label>
                                <input type="text" id="userAddress" value="${user.address || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div class="border-t pt-4">
                                <h4 class="font-semibold text-gray-700 mb-3">Goi dich vu</h4>
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="userIsPro" ${user.isPro ? 'checked' : ''} class="w-5 h-5">
                                        <span class="font-semibold text-orange-600">PRO</span>
                                    </label>
                                    <input type="date" id="userProExpiry" value="${user.proExpiry || ''}" class="p-2 border rounded-lg">
                                </div>
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Huy</button>
                            <button onclick="saveUser(${user.id})" class="px-4 py-2 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Luu</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveUser(id) {
            const data = {
                name: document.getElementById('userName').value,
                phone: document.getElementById('userPhone').value,
                company: document.getElementById('userCompany').value,
                taxCode: document.getElementById('userTaxCode').value,
                address: document.getElementById('userAddress').value,
                isPro: document.getElementById('userIsPro').checked,
                proExpiry: document.getElementById('userProExpiry').value
            };
            try {
                await fetch(`${API}/admin/users/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        async function deleteUser(id) {
            if (!confirm('Xac nhan xoa nguoi dung?')) return;
            try {
                await fetch(`${API}/admin/users/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        // ========== LAWYERS SECTION ==========
        function renderLawyers(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Luat su (${allData.lawyers.length})</h2>
                    <button onclick="showLawyerModal()" class="px-4 py-2 bg-navy-600 text-white rounded-lg font-semibold hover:bg-navy-700 transition">+ Them luat su</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${allData.lawyers.map(l => `
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-16 h-16 bg-navy-100 rounded-full flex items-center justify-center text-2xl font-bold text-navy-600">${l.name[0]}</div>
                                <div>
                                    <h3 class="font-bold text-gray-900">${l.name}</h3>
                                    <p class="text-sm text-gray-500">${l.title || ''}</p>
                                    ${l.isPrimary ? '<span class="px-2 py-1 bg-orange-100 text-orange-600 text-xs font-bold rounded">CHINH</span>' : ''}
                                </div>
                            </div>
                            <div class="space-y-2 text-sm text-gray-600">
                                <p><strong>Chuyen mon:</strong> ${l.specialty || '-'}</p>
                                <p><strong>SDT:</strong> ${l.phone || '-'}</p>
                                <p><strong>Zalo:</strong> ${l.zalo || '-'}</p>
                                <p><strong>Email:</strong> ${l.email || '-'}</p>
                                <p><strong>Kinh nghiem:</strong> ${l.experience || '-'}</p>
                            </div>
                            <div class="flex gap-2 mt-4 pt-4 border-t">
                                <button onclick='showLawyerModal(${JSON.stringify(l)})' class="flex-1 py-2 text-center text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50">Sua</button>
                                <button onclick="deleteLawyer(${l.id})" class="flex-1 py-2 text-center text-red-600 border border-red-600 rounded-lg hover:bg-red-50">Xoa</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showLawyerModal(lawyer = null) {
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg max-h-[90vh] overflow-auto m-4" onclick="event.stopPropagation()">
                        <div class="p-6 border-b flex items-center justify-between">
                            <h3 class="text-xl font-bold">${lawyer ? 'Sua' : 'Them'} luat su</h3>
                            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Ho ten *</label>
                                <input type="text" id="lawyerName" value="${lawyer?.name || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Chuc danh</label>
                                <input type="text" id="lawyerTitle" value="${lawyer?.title || ''}" class="w-full p-3 border rounded-lg" placeholder="Luat su dieu hanh">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Chuyen mon</label>
                                <input type="text" id="lawyerSpecialty" value="${lawyer?.specialty || ''}" class="w-full p-3 border rounded-lg" placeholder="Doanh nghiep, Thue, Dau tu">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">SDT</label>
                                    <input type="text" id="lawyerPhone" value="${lawyer?.phone || ''}" class="w-full p-3 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Zalo</label>
                                    <input type="text" id="lawyerZalo" value="${lawyer?.zalo || ''}" class="w-full p-3 border rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                                <input type="text" id="lawyerEmail" value="${lawyer?.email || ''}" class="w-full p-3 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Kinh nghiem</label>
                                <input type="text" id="lawyerExperience" value="${lawyer?.experience || ''}" class="w-full p-3 border rounded-lg" placeholder="15 nam">
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="lawyerIsPrimary" ${lawyer?.isPrimary ? 'checked' : ''} class="w-5 h-5">
                                    <span class="text-sm font-semibold text-gray-700">Luat su chinh</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="lawyerIsAvailable" ${lawyer?.isAvailable !== false ? 'checked' : ''} class="w-5 h-5">
                                    <span class="text-sm font-semibold text-gray-700">San sang</span>
                                </label>
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Huy</button>
                            <button onclick="saveLawyer(${lawyer?.id || 'null'})" class="px-4 py-2 bg-navy-600 text-white rounded-lg hover:bg-navy-700">Luu</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveLawyer(id) {
            const data = {
                name: document.getElementById('lawyerName').value,
                title: document.getElementById('lawyerTitle').value,
                specialty: document.getElementById('lawyerSpecialty').value,
                phone: document.getElementById('lawyerPhone').value,
                zalo: document.getElementById('lawyerZalo').value,
                email: document.getElementById('lawyerEmail').value,
                experience: document.getElementById('lawyerExperience').value,
                isPrimary: document.getElementById('lawyerIsPrimary').checked,
                isAvailable: document.getElementById('lawyerIsAvailable').checked
            };
            const url = id ? `${API}/admin/lawyers/${id}` : `${API}/admin/lawyers`;
            const method = id ? 'PUT' : 'POST';
            try {
                await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                closeModal();
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        async function deleteLawyer(id) {
            if (!confirm('Xac nhan xoa?')) return;
            try {
                await fetch(`${API}/admin/lawyers/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        // ========== PAYMENTS SECTION ==========
        function renderPayments(el) {
            const pending = allData.payments.filter(p => p.status === 'pending');
            const completed = allData.payments.filter(p => p.status === 'completed');
            
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Thanh toan (${allData.payments.length})</h2>
                    <div class="flex gap-2">
                        <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">${pending.length} cho xu ly</span>
                        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">${completed.length} hoan thanh</span>
                    </div>
                </div>
                
                ${pending.length > 0 ? `
                <div class="mb-6">
                    <h3 class="font-bold text-gray-700 mb-3">Cho xac nhan</h3>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-yellow-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ma don</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">User</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Goi</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">So tien</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Phuong thuc</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ngay tao</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao tac</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${pending.map(p => {
                                    const user = allData.users.find(u => u.id === p.userId);
                                    return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 font-medium text-gray-900">${p.orderId}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${user?.email || p.userId}</td>
                                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded">${p.package || 'N/A'}</span></td>
                                        <td class="px-4 py-3 text-right font-semibold text-gray-900">${formatCurrency(p.amount)}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${p.method || 'bank'}</td>
                                        <td class="px-4 py-3 text-sm text-gray-500">${new Date(p.createdAt).toLocaleDateString('vi-VN')}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick="confirmPayment(${p.id})" class="px-3 py-1 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">Xac nhan</button>
                                        </td>
                                    </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
                
                <div>
                    <h3 class="font-bold text-gray-700 mb-3">Tat ca giao dich</h3>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ma don</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">User</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Goi</th>
                                    <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">So tien</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Trang thai</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ngay</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${allData.payments.slice().reverse().map(p => {
                                    const user = allData.users.find(u => u.id === p.userId);
                                    return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 font-medium text-gray-900">${p.orderId}</td>
                                        <td class="px-4 py-3 text-sm text-gray-600">${user?.email || p.userId}</td>
                                        <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded">${p.package || 'N/A'}</span></td>
                                        <td class="px-4 py-3 text-right font-semibold text-gray-900">${formatCurrency(p.amount)}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-2 py-1 ${p.status === 'completed' ? 'bg-green-100 text-green-600' : 'bg-yellow-100 text-yellow-600'} text-xs font-bold rounded">${p.status}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-500">${new Date(p.createdAt).toLocaleDateString('vi-VN')}</td>
                                    </tr>
                                    `;
                                }).join('') || '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Chua co giao dich</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function confirmPayment(id) {
            if (!confirm('Xac nhan thanh toan nay? User se duoc kich hoat Pro.')) return;
            try {
                await fetch(`${API}/admin/payments/${id}/confirm`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                alert('Da xac nhan thanh toan!');
                loadDashboard();
            } catch (e) { alert('Loi'); }
        }

        // ========== SETTINGS SECTION ==========
        function renderSettings(el) {
            el.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Cai dat</h2>
                <div class="bg-white rounded-xl shadow-sm p-6 max-w-2xl">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Ten cong ty</label>
                            <input type="text" id="settingCompanyName" value="HTIC LAW FIRM" class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Website</label>
                            <input type="text" id="settingWebsite" value="www.htic.com.vn" class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Hotline</label>
                            <input type="text" id="settingPhone" value="0379 044 299" class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                            <input type="text" id="settingEmail" value="contact@htic.vn" class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Dia chi</label>
                            <input type="text" id="settingAddress" value="Ha Noi, Viet Nam" class="w-full p-3 border rounded-lg">
                        </div>
                        <button onclick="saveSettings()" class="px-6 py-3 bg-navy-600 text-white rounded-lg font-semibold hover:bg-navy-700">Luu cai dat</button>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const data = {
                companyName: document.getElementById('settingCompanyName').value,
                website: document.getElementById('settingWebsite').value,
                phone: document.getElementById('settingPhone').value,
                email: document.getElementById('settingEmail').value,
                address: document.getElementById('settingAddress').value
            };
            try {
                await fetch(`${API}/admin/settings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                alert('Da luu!');
            } catch (e) { alert('Loi'); }
        }

        // ========== HELPERS ==========
        function closeModal() {
            modalRoot.innerHTML = '';
        }

        function formatCurrency(amount) {
            if (!amount) return '0d';
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + 'd';
        }

        // Start
        checkAuth();
    </script>
</body>
</html>
