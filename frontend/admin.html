<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã - HTIC Legal App v10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { 50: '#e8eef5', 100: '#c5d4e8', 500: '#3d6d9e', 600: '#1e3a5f', 700: '#162d4a', 800: '#0f1f33' }
                    }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Inter', sans-serif; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background: rgba(255,255,255,0.1); }
        .sidebar-item.active { background: rgba(255,255,255,0.2); border-left: 3px solid #f97316; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .table-row:hover { background: #f8fafc; }
        .stat-card:hover { transform: translateY(-2px); }
        .ql-toolbar.ql-snow { border-radius: 12px 12px 0 0; border-color: #e5e7eb; background: #f9fafb; }
        .ql-container.ql-snow { border-radius: 0 0 12px 12px; border-color: #e5e7eb; font-size: 16px; }
        .ql-editor { min-height: 180px; max-height: 400px; overflow-y: auto; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .pulse-dot { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app"></div>
    <div id="modal-root"></div>

    <script>
        // ========== CONFIGURATION ==========
        const API = '/api';
        let token = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';
        let allData = { events: [], news: [], agencies: [], provinces: [], settings: {}, stats: {}, users: [], lawyers: [], payments: [], supportRequests: [] };
        let quillEditor = null;

        const app = document.getElementById('app');
        const modalRoot = document.getElementById('modal-root');

        // ========== CONSTANTS ==========
        const CATEGORIES = [
            { id: 'tax', name: 'Thu·∫ø', icon: 'üí∞', color: 'blue' },
            { id: 'insurance', name: 'B·∫£o hi·ªÉm', icon: 'üè•', color: 'green' },
            { id: 'labor', name: 'Lao ƒë·ªông', icon: 'üë∑', color: 'orange' },
            { id: 'safety', name: 'An to√†n lao ƒë·ªông', icon: 'üõ°Ô∏è', color: 'red' },
            { id: 'environment', name: 'M√¥i tr∆∞·ªùng', icon: 'üåø', color: 'emerald' },
            { id: 'investment', name: 'ƒê·∫ßu t∆∞', icon: 'üìà', color: 'purple' },
            { id: 'report', name: 'B√°o c√°o', icon: 'üìä', color: 'indigo' },
            { id: 'license', name: 'Gi·∫•y ph√©p', icon: 'üìã', color: 'gray' },
            { id: 'holiday', name: 'Ngh·ªâ l·ªÖ', icon: 'üéâ', color: 'pink' }
        ];

        const FREQUENCIES = [
            { id: 'once', name: 'M·ªôt l·∫ßn (ng√†y c·ª• th·ªÉ)' },
            { id: 'monthly', name: 'H√†ng th√°ng' },
            { id: 'quarterly', name: 'H√†ng qu√Ω' },
            { id: 'yearly', name: 'H√†ng nƒÉm' }
        ];

        const NEWS_CATEGORIES = ['Thu·∫ø', 'BHXH', 'Doanh nghi·ªáp', 'Lao ƒë·ªông', 'Ph√°p lu·∫≠t', 'ƒê·∫ßu t∆∞', 'M√¥i tr∆∞·ªùng', 'Kh√°c'];

        const AGENCY_CATEGORIES = [
            { id: 'government', name: 'C∆° quan Nh√† n∆∞·ªõc', icon: 'üèõÔ∏è' },
            { id: 'lawfirm', name: 'C√¥ng ty Lu·∫≠t / VP Lu·∫≠t s∆∞', icon: '‚öñÔ∏è' },
            { id: 'notary', name: 'VƒÉn ph√≤ng C√¥ng ch·ª©ng', icon: 'üìù' },
            { id: 'bailiff', name: 'VƒÉn ph√≤ng Th·ª´a ph√°t l·∫°i', icon: 'üìú' }
        ];

        const SUPPORT_CATEGORIES = {
            'general': { label: 'H·ªèi ƒë√°p chung', color: 'gray' },
            'account': { label: 'T√†i kho·∫£n', color: 'blue' },
            'subscription': { label: 'G√≥i Pro', color: 'purple' },
            'technical': { label: 'K·ªπ thu·∫≠t', color: 'red' },
            'legal': { label: 'Ph√°p l√Ω', color: 'indigo' },
            'feedback': { label: 'G√≥p √Ω', color: 'green' },
            'other': { label: 'Kh√°c', color: 'gray' }
        };

        const SUPPORT_STATUS = {
            'pending': { label: 'Ch·ªù x·ª≠ l√Ω', color: 'yellow', icon: '‚è≥' },
            'in-progress': { label: 'ƒêang x·ª≠ l√Ω', color: 'blue', icon: 'üîÑ' },
            'resolved': { label: 'ƒê√£ gi·∫£i quy·∫øt', color: 'green', icon: '‚úì' },
            'closed': { label: 'ƒê√£ ƒë√≥ng', color: 'gray', icon: '‚úó' }
        };

        // ========== AUTHENTICATION ==========
        function checkAuth() {
            if (!token) showLogin();
            else loadDashboard();
        }

        function showLogin() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-600 to-navy-800 p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-navy-600 to-navy-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <span class="text-white text-3xl font-bold">H</span>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900">HTIC Legal Admin</h1>
                            <p class="text-gray-500 mt-2">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n tr·ªã h·ªá th·ªëng</p>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="username" value="admin" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="password" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none" onkeypress="if(event.key==='Enter')login()">
                            </div>
                            <button onclick="login()" class="w-full bg-gradient-to-r from-navy-600 to-navy-700 text-white py-3 rounded-xl font-bold hover:opacity-90 transition shadow-lg">
                                ƒêƒÉng nh·∫≠p
                            </button>
                        </div>
                        <p class="text-center text-gray-400 text-sm mt-6">¬© 2024 HTIC Law Firm - v10.1</p>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                const res = await fetch(API + '/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    loadDashboard();
                } else {
                    document.getElementById('loginError').textContent = 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (e) {
                document.getElementById('loginError').textContent = 'L·ªói k·∫øt n·ªëi!';
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // ========== DATA LOADING ==========
        async function loadDashboard() {
            app.innerHTML = '<div class="flex items-center justify-center min-h-screen"><div class="animate-spin w-12 h-12 border-4 border-navy-600 border-t-transparent rounded-full"></div></div>';

            try {
                const [stats, events, news, agencies, provinces, settings, users, lawyers, payments, supportRequests] = await Promise.all([
                    fetch(API + '/admin/stats').then(r => r.json()),
                    fetch(API + '/admin/events').then(r => r.json()),
                    fetch(API + '/admin/news').then(r => r.json()),
                    fetch(API + '/admin/agencies').then(r => r.json()),
                    fetch(API + '/admin/provinces').then(r => r.json()),
                    fetch(API + '/settings').then(r => r.json()),
                    fetch(API + '/admin/users').then(r => r.json()).catch(() => ({ data: [] })),
                    fetch(API + '/admin/lawyers').then(r => r.json()).catch(() => ({ data: [] })),
                    fetch(API + '/admin/payments').then(r => r.json()).catch(() => ({ data: [] })),
                    fetch(API + '/admin/support-requests').then(r => r.json()).catch(() => ({ data: [] }))
                ]);

                allData = {
                    stats: stats.data || {},
                    events: events.data || [],
                    news: news.data || [],
                    agencies: agencies.data || [],
                    provinces: provinces.data || [],
                    settings: settings.data || {},
                    users: users.data || [],
                    lawyers: lawyers.data || [],
                    payments: payments.data || [],
                    supportRequests: supportRequests.data || []
                };

                renderApp();
            } catch (e) {
                console.error(e);
                app.innerHTML = '<div class="flex items-center justify-center min-h-screen"><div class="text-center"><p class="text-red-500 mb-4">L·ªói t·∫£i d·ªØ li·ªáu!</p><button onclick="loadDashboard()" class="px-6 py-2 bg-navy-600 text-white rounded-lg">Th·ª≠ l·∫°i</button></div></div>';
            }
        }

        // ========== MAIN APP RENDER ==========
        function renderApp() {
            const pendingSupport = allData.supportRequests.filter(r => r.status === 'pending').length;
            
            app.innerHTML = `
                <div class="flex min-h-screen">
                    <!-- Sidebar -->
                    <div class="w-64 bg-gradient-to-b from-navy-700 to-navy-800 text-white flex flex-col shadow-xl">
                        <div class="p-6 border-b border-navy-600">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center">
                                    <span class="font-bold text-lg">H</span>
                                </div>
                                <div>
                                    <h1 class="text-lg font-bold">HTIC Admin</h1>
                                    <p class="text-navy-100 text-xs">Phi√™n b·∫£n 10.1</p>
                                </div>
                            </div>
                        </div>
                        <nav class="flex-1 py-4 overflow-y-auto hide-scrollbar">
                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider">T·ªïng quan</p>
                            <div onclick="setSection('dashboard')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'dashboard' ? 'active' : ''}">
                                <span>üìä</span> <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">N·ªôi dung</p>
                            <div onclick="setSection('events')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'events' ? 'active' : ''}">
                                <span>üìÖ</span> <span>L·ªãch ph√°p l√Ω</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.events.length}</span>
                            </div>
                            <div onclick="setSection('news')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'news' ? 'active' : ''}">
                                <span>üì∞</span> <span>Tin t·ª©c</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.news.length}</span>
                            </div>
                            <div onclick="setSection('agencies')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'agencies' ? 'active' : ''}">
                                <span>üè¢</span> <span>C∆° quan / T·ªï ch·ª©c</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.agencies.length}</span>
                            </div>
                            <div onclick="setSection('provinces')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'provinces' ? 'active' : ''}">
                                <span>üó∫Ô∏è</span> <span>T·ªânh / Th√†nh ph·ªë</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.provinces.length}</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">Ng∆∞·ªùi d√πng</p>
                            <div onclick="setSection('users')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'users' ? 'active' : ''}">
                                <span>üë•</span> <span>Ng∆∞·ªùi d√πng</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.users.length}</span>
                            </div>
                            <div onclick="setSection('lawyers')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'lawyers' ? 'active' : ''}">
                                <span>‚öñÔ∏è</span> <span>Lu·∫≠t s∆∞</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.lawyers.length}</span>
                            </div>
                            <div onclick="setSection('payments')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'payments' ? 'active' : ''}">
                                <span>üí≥</span> <span>Thanh to√°n Pro</span>
                                <span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">${allData.payments.length}</span>
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">H·ªó tr·ª£</p>
                            <div onclick="setSection('support')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'support' ? 'active' : ''}">
                                <span>üéß</span> <span>Y√™u c·∫ßu h·ªó tr·ª£</span>
                                ${pendingSupport > 0 ? '<span class="ml-auto bg-red-500 px-2 py-0.5 rounded-full text-xs pulse-dot">' + pendingSupport + '</span>' : '<span class="ml-auto bg-navy-600 px-2 py-0.5 rounded-full text-xs">' + allData.supportRequests.length + '</span>'}
                            </div>

                            <p class="px-6 py-2 text-xs text-navy-300 uppercase tracking-wider mt-4">H·ªá th·ªëng</p>
                            <div onclick="setSection('settings')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3 ${currentSection === 'settings' ? 'active' : ''}">
                                <span>‚öôÔ∏è</span> <span>C√†i ƒë·∫∑t</span>
                            </div>
                        </nav>
                        <div class="p-4 border-t border-navy-600">
                            <div class="flex items-center gap-3 mb-4 px-2">
                                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-sm font-bold">A</div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium">Admin</p>
                                    <p class="text-xs text-navy-300">Qu·∫£n tr·ªã vi√™n</p>
                                </div>
                            </div>
                            <button onclick="logout()" class="w-full py-2 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-lg text-sm font-semibold transition flex items-center justify-center gap-2">
                                <span>üö™</span> ƒêƒÉng xu·∫•t
                            </button>
                        </div>
                    </div>

                    <!-- Main Content -->
                    <div class="flex-1 overflow-auto bg-gray-50">
                        <div id="content" class="p-6"></div>
                    </div>
                </div>
            `;
            renderSection();
        }

        function setSection(section) {
            currentSection = section;
            renderApp();
        }

        function renderSection() {
            const content = document.getElementById('content');
            switch (currentSection) {
                case 'dashboard': renderDashboard(content); break;
                case 'events': renderEvents(content); break;
                case 'news': renderNews(content); break;
                case 'agencies': renderAgencies(content); break;
                case 'provinces': renderProvinces(content); break;
                case 'users': renderUsers(content); break;
                case 'lawyers': renderLawyers(content); break;
                case 'payments': renderPayments(content); break;
                case 'support': renderSupportRequests(content); break;
                case 'settings': renderSettings(content); break;
            }
        }

        // ========== DASHBOARD ==========
        function renderDashboard(el) {
            const s = allData.stats;
            const pendingSupport = allData.supportRequests.filter(r => r.status === 'pending').length;
            const recentSupport = [...allData.supportRequests].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            
            el.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
                    <p class="text-gray-500">T·ªïng quan h·ªá th·ªëng HTIC Legal App v10.1</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                    <div class="stat-card bg-white rounded-xl p-5 shadow-sm border-l-4 border-blue-500 transition cursor-pointer" onclick="setSection('events')">
                        <p class="text-gray-500 text-sm">S·ª± ki·ªán ph√°p l√Ω</p>
                        <p class="text-2xl font-bold text-gray-900">${allData.events.length}</p>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-5 shadow-sm border-l-4 border-green-500 transition cursor-pointer" onclick="setSection('news')">
                        <p class="text-gray-500 text-sm">Tin t·ª©c</p>
                        <p class="text-2xl font-bold text-gray-900">${allData.news.length}</p>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-5 shadow-sm border-l-4 border-purple-500 transition cursor-pointer" onclick="setSection('users')">
                        <p class="text-gray-500 text-sm">Ng∆∞·ªùi d√πng</p>
                        <p class="text-2xl font-bold text-gray-900">${allData.users.length}</p>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-5 shadow-sm border-l-4 border-orange-500 transition cursor-pointer" onclick="setSection('payments')">
                        <p class="text-gray-500 text-sm">Thanh to√°n Pro</p>
                        <p class="text-2xl font-bold text-gray-900">${allData.payments.length}</p>
                    </div>
                    <div class="stat-card bg-white rounded-xl p-5 shadow-sm border-l-4 border-red-500 transition cursor-pointer" onclick="setSection('support')">
                        <p class="text-gray-500 text-sm">Y√™u c·∫ßu h·ªó tr·ª£</p>
                        <p class="text-2xl font-bold text-gray-900">${allData.supportRequests.length}</p>
                        ${pendingSupport > 0 ? '<p class="text-xs text-red-600 mt-1">' + pendingSupport + ' ch·ªù x·ª≠ l√Ω</p>' : ''}
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-900 mb-4">üì∞ Tin t·ª©c m·ªõi nh·∫•t</h3>
                        <div class="space-y-3">
                            ${allData.news.slice(0, 5).map(n => '<div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50"><span class="text-xl">' + (n.image ? 'üì∞' : 'üìÑ') + '</span><div class="flex-1 min-w-0"><p class="font-medium text-gray-900 truncate">' + escapeHtml(n.title) + '</p><p class="text-xs text-gray-500">' + (n.category || 'Tin t·ª©c') + '</p></div></div>').join('')}
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 shadow-sm">
                        <h3 class="font-bold text-gray-900 mb-4">üéß Y√™u c·∫ßu h·ªó tr·ª£ g·∫ßn ƒë√¢y</h3>
                        <div class="space-y-3">
                            ${recentSupport.length > 0 ? recentSupport.map(r => {
                                const st = SUPPORT_STATUS[r.status] || SUPPORT_STATUS['pending'];
                                return '<div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="setSection(\'support\')"><span class="w-8 h-8 bg-' + st.color + '-100 rounded-full flex items-center justify-center text-sm">' + st.icon + '</span><div class="flex-1 min-w-0"><p class="font-medium text-gray-900 truncate">' + escapeHtml(r.subject) + '</p><p class="text-xs text-gray-500">' + escapeHtml(r.name) + '</p></div><span class="px-2 py-1 bg-' + st.color + '-100 text-' + st.color + '-700 text-xs rounded-full">' + st.label + '</span></div>';
                            }).join('') : '<p class="text-gray-500 text-center py-4">Ch∆∞a c√≥ y√™u c·∫ßu h·ªó tr·ª£</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // ========== SUPPORT REQUESTS ==========
        function renderSupportRequests(el) {
            const sorted = [...allData.supportRequests].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const pending = sorted.filter(r => r.status === 'pending').length;
            const inProgress = sorted.filter(r => r.status === 'in-progress').length;
            const resolved = sorted.filter(r => r.status === 'resolved').length;
            const closed = sorted.filter(r => r.status === 'closed').length;
            
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">üéß Qu·∫£n l√Ω y√™u c·∫ßu h·ªó tr·ª£</h2>
                        <p class="text-gray-500">Qu·∫£n l√Ω ${allData.supportRequests.length} y√™u c·∫ßu t·ª´ kh√°ch h√†ng</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadDashboard()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg font-medium hover:bg-gray-200">üîÑ L√†m m·ªõi</button>
                        <button onclick="exportSupportRequests()" class="px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:opacity-90">üì• Xu·∫•t CSV</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-yellow-500">
                        <p class="text-gray-500 text-sm">Ch·ªù x·ª≠ l√Ω</p>
                        <p class="text-2xl font-bold text-yellow-600">${pending}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-blue-500">
                        <p class="text-gray-500 text-sm">ƒêang x·ª≠ l√Ω</p>
                        <p class="text-2xl font-bold text-blue-600">${inProgress}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-green-500">
                        <p class="text-gray-500 text-sm">ƒê√£ gi·∫£i quy·∫øt</p>
                        <p class="text-2xl font-bold text-green-600">${resolved}</p>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-gray-400">
                        <p class="text-gray-500 text-sm">ƒê√£ ƒë√≥ng</p>
                        <p class="text-2xl font-bold text-gray-600">${closed}</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Tr·∫°ng th√°i</label>
                            <select id="filterStatus" onchange="filterSupport()" class="w-full p-2 border rounded-lg">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="pending">‚è≥ Ch·ªù x·ª≠ l√Ω</option>
                                <option value="in-progress">üîÑ ƒêang x·ª≠ l√Ω</option>
                                <option value="resolved">‚úì ƒê√£ gi·∫£i quy·∫øt</option>
                                <option value="closed">‚úó ƒê√£ ƒë√≥ng</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Danh m·ª•c</label>
                            <select id="filterCategory" onchange="filterSupport()" class="w-full p-2 border rounded-lg">
                                <option value="">T·∫•t c·∫£</option>
                                ${Object.entries(SUPPORT_CATEGORIES).map(([k, v]) => '<option value="' + k + '">' + v.label + '</option>').join('')}
                            </select>
                        </div>
                        <div class="flex-1 min-w-[250px]">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">T√¨m ki·∫øm</label>
                            <input type="text" id="searchSupport" oninput="filterSupport()" placeholder="T√™n, email, ti√™u ƒë·ªÅ..." class="w-full p-2 border rounded-lg">
                        </div>
                        <button onclick="clearSupportFilters()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">X√≥a l·ªçc</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-16">ID</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Tr·∫°ng th√°i</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Danh m·ª•c</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng∆∞·ªùi g·ª≠i</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-36">Ng√†y g·ª≠i</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-28">Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y" id="supportTableBody">
                                ${renderSupportRows(sorted)}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderSupportRows(requests) {
            if (requests.length === 0) {
                return '<tr><td colspan="7" class="px-4 py-12 text-center text-gray-500">Kh√¥ng c√≥ y√™u c·∫ßu h·ªó tr·ª£ n√†o</td></tr>';
            }
            return requests.map(r => {
                const status = SUPPORT_STATUS[r.status] || SUPPORT_STATUS['pending'];
                const cat = SUPPORT_CATEGORIES[r.category] || SUPPORT_CATEGORIES['other'];
                const date = r.createdAt ? new Date(r.createdAt).toLocaleString('vi-VN') : '-';
                const isPending = r.status === 'pending';
                return `
                <tr class="table-row transition ${isPending ? 'bg-yellow-50' : ''}" data-status="${r.status}" data-category="${r.category}" data-search="${(r.name + r.email + r.subject + r.message).toLowerCase()}">
                    <td class="px-4 py-3 font-mono text-sm text-gray-500">#${r.id}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-${status.color}-100 text-${status.color}-700 text-xs rounded-full font-medium">${status.icon} ${status.label}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-${cat.color}-100 text-${cat.color}-600 text-xs rounded-full">${cat.label}</span>
                    </td>
                    <td class="px-4 py-3">
                        <p class="font-medium text-gray-900">${escapeHtml(r.name)}</p>
                        <p class="text-sm text-gray-500">${escapeHtml(r.email)}</p>
                    </td>
                    <td class="px-4 py-3">
                        <p class="text-gray-900 truncate max-w-xs">${escapeHtml(r.subject)}</p>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${date}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="showSupportModal(${r.id})" class="text-blue-600 hover:text-blue-800 mr-2 text-sm">üëÅÔ∏è Xem</button>
                        <button onclick="deleteSupport(${r.id})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function filterSupport() {
            const status = document.getElementById('filterStatus').value;
            const category = document.getElementById('filterCategory').value;
            const search = document.getElementById('searchSupport').value.toLowerCase();
            
            document.querySelectorAll('#supportTableBody tr').forEach(row => {
                if (!row.dataset.status) return;
                const matchStatus = !status || row.dataset.status === status;
                const matchCategory = !category || row.dataset.category === category;
                const matchSearch = !search || row.dataset.search.includes(search);
                row.style.display = matchStatus && matchCategory && matchSearch ? '' : 'none';
            });
        }

        function clearSupportFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCategory').value = '';
            document.getElementById('searchSupport').value = '';
            filterSupport();
        }

        function showSupportModal(id) {
            const request = allData.supportRequests.find(r => r.id === id);
            if (!request) return;
            
            const status = SUPPORT_STATUS[request.status] || SUPPORT_STATUS['pending'];
            const cat = SUPPORT_CATEGORIES[request.category] || SUPPORT_CATEGORIES['other'];
            const date = request.createdAt ? new Date(request.createdAt).toLocaleString('vi-VN') : '-';
            
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-t-2xl">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-xl font-bold">üéß Y√™u c·∫ßu h·ªó tr·ª£ #${request.id}</h3>
                                    <p class="text-navy-100 text-sm mt-1">${date}</p>
                                </div>
                                <button onclick="closeModal()" class="text-white/80 hover:text-white text-2xl">&times;</button>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">Ng∆∞·ªùi g·ª≠i</p>
                                    <p class="font-semibold">${escapeHtml(request.name)}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">Danh m·ª•c</p>
                                    <p class="font-semibold">${cat.label}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">Email</p>
                                    <p class="font-semibold">${escapeHtml(request.email)}</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <p class="text-xs text-gray-500">ƒêi·ªán tho·∫°i</p>
                                    <p class="font-semibold">${escapeHtml(request.phone) || '-'}</p>
                                </div>
                            </div>

                            <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                                <p class="text-sm font-semibold text-blue-800 mb-2">üìã ${escapeHtml(request.subject)}</p>
                                <p class="text-gray-700 whitespace-pre-wrap">${escapeHtml(request.message)}</p>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Tr·∫°ng th√°i</label>
                                <select id="modalStatus" class="w-full p-3 border-2 border-gray-200 rounded-xl">
                                    ${Object.entries(SUPPORT_STATUS).map(([k, v]) => '<option value="' + k + '"' + (request.status === k ? ' selected' : '') + '>' + v.icon + ' ' + v.label + '</option>').join('')}
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ghi ch√∫ n·ªôi b·ªô</label>
                                <textarea id="modalAdminNote" rows="2" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="Ghi ch√∫ cho nh√¢n vi√™n...">${escapeHtml(request.adminNote || '')}</textarea>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ph·∫£n h·ªìi cho kh√°ch h√†ng</label>
                                <textarea id="modalAdminResponse" rows="4" class="w-full p-3 border-2 border-gray-200 rounded-xl" placeholder="N·ªôi dung ph·∫£n h·ªìi...">${escapeHtml(request.adminResponse || '')}</textarea>
                            </div>
                        </div>
                        <div class="p-6 border-t bg-gray-50 rounded-b-2xl flex justify-between">
                            <button onclick="deleteSupport(${request.id}); closeModal();" class="px-4 py-2 bg-red-100 text-red-600 rounded-xl hover:bg-red-200">üóëÔ∏è X√≥a</button>
                            <div class="flex gap-3">
                                <button onclick="closeModal()" class="px-6 py-2 border-2 border-gray-300 rounded-xl hover:bg-gray-100">ƒê√≥ng</button>
                                <button onclick="saveSupportRequest(${request.id})" class="px-6 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl hover:opacity-90 shadow-md">üíæ L∆∞u</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveSupportRequest(id) {
            const data = {
                status: document.getElementById('modalStatus').value,
                adminNote: document.getElementById('modalAdminNote').value,
                adminResponse: document.getElementById('modalAdminResponse').value
            };
            
            try {
                const res = await fetch(API + '/admin/support-requests/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert('‚úì ƒê√£ c·∫≠p nh·∫≠t!');
                    closeModal();
                    loadDashboard();
                } else {
                    alert('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
                }
            } catch (e) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        async function deleteSupport(id) {
            if (!confirm('X√≥a y√™u c·∫ßu h·ªó tr·ª£ n√†y?')) return;
            try {
                await fetch(API + '/admin/support-requests/' + id, { method: 'DELETE' });
                loadDashboard();
            } catch (e) {
                alert('L·ªói x√≥a!');
            }
        }

        function exportSupportRequests() {
            const headers = ['ID', 'Tr·∫°ng th√°i', 'Danh m·ª•c', 'T√™n', 'Email', 'ƒêi·ªán tho·∫°i', 'Ti√™u ƒë·ªÅ', 'N·ªôi dung', 'Ghi ch√∫ Admin', 'Ph·∫£n h·ªìi', 'Ng√†y g·ª≠i'];
            const rows = allData.supportRequests.map(r => [
                r.id,
                SUPPORT_STATUS[r.status]?.label || r.status,
                SUPPORT_CATEGORIES[r.category]?.label || r.category,
                r.name,
                r.email,
                r.phone || '',
                r.subject,
                r.message.replace(/\n/g, ' '),
                r.adminNote || '',
                r.adminResponse || '',
                r.createdAt ? new Date(r.createdAt).toLocaleString('vi-VN') : ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'support_requests_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // ========== EVENTS ==========
        function renderEvents(el) {
            const sorted = [...allData.events].sort((a, b) => (a.date || '').localeCompare(b.date || ''));
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">üìÖ L·ªãch ph√°p l√Ω 2026</h2>
                        <p class="text-gray-500">${allData.events.length} s·ª± ki·ªán / nghƒ©a v·ª• ph√°p l√Ω</p>
                    </div>
                    <button onclick="showEventModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg shadow-lg hover:opacity-90">+ Th√™m s·ª± ki·ªán</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50"><tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">Ng√†y</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">Danh m·ª•c</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-24">Thao t√°c</th>
                        </tr></thead>
                        <tbody class="divide-y">
                            ${sorted.map(e => {
                                const cat = CATEGORIES.find(c => c.id === e.category) || { icon: 'üìã', name: e.category };
                                return `<tr class="table-row"><td class="px-4 py-3"><p class="font-medium text-gray-900">${escapeHtml(e.title)}</p><p class="text-sm text-gray-500 truncate max-w-md">${escapeHtml(stripHtml(e.description || ''))}</p></td><td class="px-4 py-3 text-gray-600">${e.date || '-'}</td><td class="px-4 py-3"><span class="px-2 py-1 bg-${cat.color || 'gray'}-100 text-${cat.color || 'gray'}-600 text-xs rounded-full">${cat.icon} ${cat.name}</span></td><td class="px-4 py-3 text-center"><button onclick="showEventModal('${e.id}')" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button><button onclick="deleteEvent('${e.id}')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showEventModal(id = null) {
            const event = id ? allData.events.find(e => e.id === id) : null;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b"><h3 class="text-xl font-bold">${event ? 'S·ª≠a s·ª± ki·ªán' : 'Th√™m s·ª± ki·ªán m·ªõi'}</h3></div>
                        <div class="p-6 space-y-4">
                            <div><label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ *</label><input type="text" id="eventTitle" value="${event?.title || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold mb-2">Ng√†y</label><input type="date" id="eventDate" value="${event?.date || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                                <div><label class="block text-sm font-semibold mb-2">Danh m·ª•c</label><select id="eventCategory" class="w-full p-3 border-2 rounded-xl">${CATEGORIES.map(c => '<option value="' + c.id + '"' + (event?.category === c.id ? ' selected' : '') + '>' + c.icon + ' ' + c.name + '</option>').join('')}</select></div>
                            </div>
                            <div><label class="block text-sm font-semibold mb-2">M√¥ t·∫£</label><textarea id="eventDesc" rows="4" class="w-full p-3 border-2 rounded-xl">${event?.description || ''}</textarea></div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3">
                            <button onclick="closeModal()" class="px-6 py-2 border-2 rounded-xl">H·ªßy</button>
                            <button onclick="saveEvent('${id || ''}')" class="px-6 py-2 bg-navy-600 text-white rounded-xl">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveEvent(id) {
            const data = { title: document.getElementById('eventTitle').value, date: document.getElementById('eventDate').value, category: document.getElementById('eventCategory').value, description: document.getElementById('eventDesc').value };
            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!'); return; }
            try {
                if (id) { await fetch(API + '/admin/events/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                else { data.id = 'evt_' + Date.now(); await fetch(API + '/admin/events', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                closeModal(); loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u!'); }
        }

        async function deleteEvent(id) { if (!confirm('X√≥a s·ª± ki·ªán n√†y?')) return; try { await fetch(API + '/admin/events/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== NEWS ==========
        function renderNews(el) {
            const sorted = [...allData.news].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div><h2 class="text-2xl font-bold text-gray-900">üì∞ Tin t·ª©c ph√°p lu·∫≠t</h2><p class="text-gray-500">${allData.news.length} b√†i vi·∫øt</p></div>
                    <button onclick="showNewsModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg shadow-lg hover:opacity-90">+ Th√™m tin</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ti√™u ƒë·ªÅ</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">Danh m·ª•c</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">Ng√†y</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-24">Thao t√°c</th></tr></thead>
                    <tbody class="divide-y">${sorted.map(n => '<tr class="table-row"><td class="px-4 py-3"><p class="font-medium text-gray-900">' + escapeHtml(n.title) + '</p></td><td class="px-4 py-3"><span class="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full">' + (n.category || 'Tin t·ª©c') + '</span></td><td class="px-4 py-3 text-gray-600">' + (n.date || '-') + '</td><td class="px-4 py-3 text-center"><button onclick="showNewsModal(\'' + n.id + '\')" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button><button onclick="deleteNews(\'' + n.id + '\')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>').join('')}</tbody>
                    </table>
                </div>
            `;
        }

        function showNewsModal(id = null) {
            const news = id ? allData.news.find(n => n.id === id) : null;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-auto m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b"><h3 class="text-xl font-bold">${news ? 'S·ª≠a tin t·ª©c' : 'Th√™m tin m·ªõi'}</h3></div>
                        <div class="p-6 space-y-4">
                            <div><label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ *</label><input type="text" id="newsTitle" value="${news?.title || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold mb-2">Danh m·ª•c</label><select id="newsCategory" class="w-full p-3 border-2 rounded-xl">${NEWS_CATEGORIES.map(c => '<option value="' + c + '"' + (news?.category === c ? ' selected' : '') + '>' + c + '</option>').join('')}</select></div>
                                <div><label class="block text-sm font-semibold mb-2">Ng√†y</label><input type="date" id="newsDate" value="${news?.date || new Date().toISOString().split('T')[0]}" class="w-full p-3 border-2 rounded-xl"></div>
                            </div>
                            <div><label class="block text-sm font-semibold mb-2">Link ·∫£nh</label><input type="text" id="newsImage" value="${news?.image || ''}" class="w-full p-3 border-2 rounded-xl" placeholder="https://..."></div>
                            <div><label class="block text-sm font-semibold mb-2">T√≥m t·∫Øt</label><textarea id="newsSummary" rows="2" class="w-full p-3 border-2 rounded-xl">${news?.summary || ''}</textarea></div>
                            <div><label class="block text-sm font-semibold mb-2">N·ªôi dung</label><div id="newsContent" style="height:200px">${news?.content || ''}</div></div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3"><button onclick="closeModal()" class="px-6 py-2 border-2 rounded-xl">H·ªßy</button><button onclick="saveNews('${id || ''}')" class="px-6 py-2 bg-navy-600 text-white rounded-xl">L∆∞u</button></div>
                    </div>
                </div>
            `;
            setTimeout(() => { quillEditor = new Quill('#newsContent', { theme: 'snow', modules: { toolbar: [[{ 'header': [1, 2, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link'], ['clean']] } }); }, 100);
        }

        async function saveNews(id) {
            const data = { title: document.getElementById('newsTitle').value, category: document.getElementById('newsCategory').value, date: document.getElementById('newsDate').value, image: document.getElementById('newsImage').value, summary: document.getElementById('newsSummary').value, content: quillEditor ? quillEditor.root.innerHTML : '' };
            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ!'); return; }
            try {
                if (id) { await fetch(API + '/admin/news/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                else { data.id = 'news_' + Date.now(); await fetch(API + '/admin/news', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                closeModal(); loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u!'); }
        }

        async function deleteNews(id) { if (!confirm('X√≥a tin n√†y?')) return; try { await fetch(API + '/admin/news/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== AGENCIES ==========
        function renderAgencies(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div><h2 class="text-2xl font-bold text-gray-900">üè¢ C∆° quan / T·ªï ch·ª©c</h2><p class="text-gray-500">${allData.agencies.length} ƒë∆°n v·ªã</p></div>
                    <button onclick="showAgencyModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg shadow-lg hover:opacity-90">+ Th√™m m·ªõi</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T√™n</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-40">Lo·∫°i</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-36">ƒêi·ªán tho·∫°i</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-24">Thao t√°c</th></tr></thead>
                    <tbody class="divide-y">${allData.agencies.map(a => { const cat = AGENCY_CATEGORIES.find(c => c.id === a.category) || { icon: 'üè¢', name: a.category }; return '<tr class="table-row"><td class="px-4 py-3"><p class="font-medium text-gray-900">' + escapeHtml(a.name) + '</p><p class="text-sm text-gray-500">' + escapeHtml(a.address || '') + '</p></td><td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full">' + cat.icon + ' ' + cat.name + '</span></td><td class="px-4 py-3 text-gray-600">' + (a.phone || '-') + '</td><td class="px-4 py-3 text-center"><button onclick="showAgencyModal(\'' + a.id + '\')" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button><button onclick="deleteAgency(\'' + a.id + '\')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>'; }).join('')}</tbody>
                    </table>
                </div>
            `;
        }

        function showAgencyModal(id = null) {
            const agency = id ? allData.agencies.find(a => a.id === id) : null;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b"><h3 class="text-xl font-bold">${agency ? 'S·ª≠a th√¥ng tin' : 'Th√™m c∆° quan m·ªõi'}</h3></div>
                        <div class="p-6 space-y-4">
                            <div><label class="block text-sm font-semibold mb-2">T√™n *</label><input type="text" id="agencyName" value="${agency?.name || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            <div><label class="block text-sm font-semibold mb-2">Lo·∫°i</label><select id="agencyCategory" class="w-full p-3 border-2 rounded-xl">${AGENCY_CATEGORIES.map(c => '<option value="' + c.id + '"' + (agency?.category === c.id ? ' selected' : '') + '>' + c.icon + ' ' + c.name + '</option>').join('')}</select></div>
                            <div><label class="block text-sm font-semibold mb-2">ƒê·ªãa ch·ªâ</label><input type="text" id="agencyAddress" value="${agency?.address || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold mb-2">ƒêi·ªán tho·∫°i</label><input type="text" id="agencyPhone" value="${agency?.phone || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                                <div><label class="block text-sm font-semibold mb-2">Email</label><input type="text" id="agencyEmail" value="${agency?.email || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            </div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3"><button onclick="closeModal()" class="px-6 py-2 border-2 rounded-xl">H·ªßy</button><button onclick="saveAgency('${id || ''}')" class="px-6 py-2 bg-navy-600 text-white rounded-xl">L∆∞u</button></div>
                    </div>
                </div>
            `;
        }

        async function saveAgency(id) {
            const data = { name: document.getElementById('agencyName').value, category: document.getElementById('agencyCategory').value, address: document.getElementById('agencyAddress').value, phone: document.getElementById('agencyPhone').value, email: document.getElementById('agencyEmail').value };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p t√™n!'); return; }
            try {
                if (id) { await fetch(API + '/admin/agencies/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                else { data.id = 'agency_' + Date.now(); await fetch(API + '/admin/agencies', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                closeModal(); loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u!'); }
        }

        async function deleteAgency(id) { if (!confirm('X√≥a c∆° quan n√†y?')) return; try { await fetch(API + '/admin/agencies/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== PROVINCES ==========
        function renderProvinces(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div><h2 class="text-2xl font-bold text-gray-900">üó∫Ô∏è T·ªânh / Th√†nh ph·ªë</h2><p class="text-gray-500">${allData.provinces.length} t·ªânh th√†nh</p></div>
                    <button onclick="showProvinceModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg shadow-lg hover:opacity-90">+ Th√™m m·ªõi</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${allData.provinces.map(p => '<div class="bg-white rounded-xl p-4 shadow-sm hover:shadow-md transition"><div class="flex items-center justify-between"><div><p class="font-semibold text-gray-900">' + escapeHtml(p.name) + '</p><p class="text-sm text-gray-500">ID: ' + p.id + '</p></div><div><button onclick="showProvinceModal(\'' + p.id + '\')" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button><button onclick="deleteProvince(\'' + p.id + '\')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></div></div></div>').join('')}
                </div>
            `;
        }

        function showProvinceModal(id = null) {
            const province = id ? allData.provinces.find(p => p.id === id) : null;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-md m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b"><h3 class="text-xl font-bold">${province ? 'S·ª≠a t·ªânh th√†nh' : 'Th√™m t·ªânh th√†nh m·ªõi'}</h3></div>
                        <div class="p-6 space-y-4">
                            <div><label class="block text-sm font-semibold mb-2">ID *</label><input type="text" id="provinceId" value="${province?.id || ''}" class="w-full p-3 border-2 rounded-xl" ${province ? 'readonly' : ''}></div>
                            <div><label class="block text-sm font-semibold mb-2">T√™n *</label><input type="text" id="provinceName" value="${province?.name || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3"><button onclick="closeModal()" class="px-6 py-2 border-2 rounded-xl">H·ªßy</button><button onclick="saveProvince('${id || ''}')" class="px-6 py-2 bg-navy-600 text-white rounded-xl">L∆∞u</button></div>
                    </div>
                </div>
            `;
        }

        async function saveProvince(id) {
            const data = { id: document.getElementById('provinceId').value, name: document.getElementById('provinceName').value };
            if (!data.id || !data.name) { alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!'); return; }
            try {
                if (id) { await fetch(API + '/admin/provinces/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                else { await fetch(API + '/admin/provinces', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                closeModal(); loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u!'); }
        }

        async function deleteProvince(id) { if (!confirm('X√≥a t·ªânh th√†nh n√†y?')) return; try { await fetch(API + '/admin/provinces/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== USERS ==========
        function renderUsers(el) {
            const proUsers = allData.users.filter(u => u.isPro);
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div><h2 class="text-2xl font-bold text-gray-900">üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2><p class="text-gray-500">${allData.users.length} ng∆∞·ªùi d√πng (${proUsers.length} Pro)</p></div>
                    <button onclick="loadDashboard()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">üîÑ L√†m m·ªõi</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng∆∞·ªùi d√πng</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">G√≥i</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-40">Ng√†y ƒëƒÉng k√Ω</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-24">Thao t√°c</th></tr></thead>
                    <tbody class="divide-y">${allData.users.map(u => '<tr class="table-row"><td class="px-4 py-3"><p class="font-medium text-gray-900">' + escapeHtml(u.name || u.email) + '</p><p class="text-sm text-gray-500">' + escapeHtml(u.email) + '</p></td><td class="px-4 py-3">' + (u.isPro ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full font-medium">‚≠ê PRO</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">Mi·ªÖn ph√≠</span>') + '</td><td class="px-4 py-3 text-sm text-gray-600">' + (u.createdAt ? new Date(u.createdAt).toLocaleDateString('vi-VN') : '-') + '</td><td class="px-4 py-3 text-center"><button onclick="toggleUserPro(\'' + u.id + '\', ' + !u.isPro + ')" class="text-blue-600 hover:text-blue-800 mr-2">' + (u.isPro ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è') + '</button><button onclick="deleteUser(\'' + u.id + '\')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>').join('')}</tbody>
                    </table>
                </div>
            `;
        }

        async function toggleUserPro(id, isPro) { try { await fetch(API + '/admin/users/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ isPro }) }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }
        async function deleteUser(id) { if (!confirm('X√≥a ng∆∞·ªùi d√πng n√†y?')) return; try { await fetch(API + '/admin/users/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== LAWYERS ==========
        function renderLawyers(el) {
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div><h2 class="text-2xl font-bold text-gray-900">‚öñÔ∏è Qu·∫£n l√Ω lu·∫≠t s∆∞</h2><p class="text-gray-500">${allData.lawyers.length} lu·∫≠t s∆∞</p></div>
                    <button onclick="showLawyerModal()" class="px-4 py-2 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-lg shadow-lg hover:opacity-90">+ Th√™m lu·∫≠t s∆∞</button>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Lu·∫≠t s∆∞</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-40">Chuy√™n m√¥n</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-36">ƒêi·ªán tho·∫°i</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-24">Thao t√°c</th></tr></thead>
                    <tbody class="divide-y">${allData.lawyers.map(l => '<tr class="table-row"><td class="px-4 py-3"><p class="font-medium text-gray-900">' + escapeHtml(l.name) + '</p><p class="text-sm text-gray-500">' + escapeHtml(l.email || '') + '</p></td><td class="px-4 py-3"><span class="px-2 py-1 bg-indigo-100 text-indigo-600 text-xs rounded-full">' + escapeHtml(l.specialty || 'T·ªïng h·ª£p') + '</span></td><td class="px-4 py-3 text-gray-600">' + (l.phone || '-') + '</td><td class="px-4 py-3 text-center"><button onclick="showLawyerModal(\'' + l.id + '\')" class="text-blue-600 hover:text-blue-800 mr-2">‚úèÔ∏è</button><button onclick="deleteLawyer(\'' + l.id + '\')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>').join('')}</tbody>
                    </table>
                </div>
            `;
        }

        function showLawyerModal(id = null) {
            const lawyer = id ? allData.lawyers.find(l => l.id === id) : null;
            modalRoot.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="bg-white rounded-2xl w-full max-w-lg m-4 shadow-2xl" onclick="event.stopPropagation()">
                        <div class="p-6 border-b"><h3 class="text-xl font-bold">${lawyer ? 'S·ª≠a th√¥ng tin lu·∫≠t s∆∞' : 'Th√™m lu·∫≠t s∆∞ m·ªõi'}</h3></div>
                        <div class="p-6 space-y-4">
                            <div><label class="block text-sm font-semibold mb-2">H·ªç t√™n *</label><input type="text" id="lawyerName" value="${lawyer?.name || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-semibold mb-2">Email</label><input type="email" id="lawyerEmail" value="${lawyer?.email || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                                <div><label class="block text-sm font-semibold mb-2">ƒêi·ªán tho·∫°i</label><input type="text" id="lawyerPhone" value="${lawyer?.phone || ''}" class="w-full p-3 border-2 rounded-xl"></div>
                            </div>
                            <div><label class="block text-sm font-semibold mb-2">Chuy√™n m√¥n</label><input type="text" id="lawyerSpecialty" value="${lawyer?.specialty || ''}" class="w-full p-3 border-2 rounded-xl" placeholder="VD: Doanh nghi·ªáp, ƒê·∫•t ƒëai, H√¨nh s·ª±..."></div>
                            <div><label class="block text-sm font-semibold mb-2">Gi·ªõi thi·ªáu</label><textarea id="lawyerBio" rows="3" class="w-full p-3 border-2 rounded-xl">${lawyer?.bio || ''}</textarea></div>
                        </div>
                        <div class="p-6 border-t flex justify-end gap-3"><button onclick="closeModal()" class="px-6 py-2 border-2 rounded-xl">H·ªßy</button><button onclick="saveLawyer('${id || ''}')" class="px-6 py-2 bg-navy-600 text-white rounded-xl">L∆∞u</button></div>
                    </div>
                </div>
            `;
        }

        async function saveLawyer(id) {
            const data = { name: document.getElementById('lawyerName').value, email: document.getElementById('lawyerEmail').value, phone: document.getElementById('lawyerPhone').value, specialty: document.getElementById('lawyerSpecialty').value, bio: document.getElementById('lawyerBio').value };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p h·ªç t√™n!'); return; }
            try {
                if (id) { await fetch(API + '/admin/lawyers/' + id, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                else { data.id = 'lawyer_' + Date.now(); await fetch(API + '/admin/lawyers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); }
                closeModal(); loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u!'); }
        }

        async function deleteLawyer(id) { if (!confirm('X√≥a lu·∫≠t s∆∞ n√†y?')) return; try { await fetch(API + '/admin/lawyers/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== PAYMENTS ==========
        function renderPayments(el) {
            const sorted = [...allData.payments].sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
            const pending = sorted.filter(p => p.status === 'pending').length;
            const completed = sorted.filter(p => p.status === 'completed').length;
            
            el.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div><h2 class="text-2xl font-bold text-gray-900">üí≥ Qu·∫£n l√Ω thanh to√°n Pro</h2><p class="text-gray-500">${allData.payments.length} giao d·ªãch (${pending} ch·ªù duy·ªát)</p></div>
                    <button onclick="loadDashboard()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200">üîÑ L√†m m·ªõi</button>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-yellow-500"><p class="text-gray-500 text-sm">Ch·ªù duy·ªát</p><p class="text-2xl font-bold text-yellow-600">${pending}</p></div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-green-500"><p class="text-gray-500 text-sm">ƒê√£ duy·ªát</p><p class="text-2xl font-bold text-green-600">${completed}</p></div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4 border-blue-500"><p class="text-gray-500 text-sm">T·ªïng c·ªông</p><p class="text-2xl font-bold text-blue-600">${allData.payments.length}</p></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <table class="w-full"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Ng∆∞·ªùi d√πng</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">G√≥i</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-32">S·ªë ti·ªÅn</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-28">Tr·∫°ng th√°i</th><th class="px-4 py-3 text-left text-sm font-semibold text-gray-600 w-36">Ng√†y</th><th class="px-4 py-3 text-center text-sm font-semibold text-gray-600 w-28">Thao t√°c</th></tr></thead>
                    <tbody class="divide-y">${sorted.map(p => '<tr class="table-row ' + (p.status === 'pending' ? 'bg-yellow-50' : '') + '"><td class="px-4 py-3"><p class="font-medium text-gray-900">' + escapeHtml(p.userName || p.userEmail) + '</p><p class="text-sm text-gray-500">' + escapeHtml(p.userEmail) + '</p></td><td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-600 text-xs rounded-full">' + (p.plan || 'Pro') + '</span></td><td class="px-4 py-3 font-medium text-gray-900">' + (p.amount ? p.amount.toLocaleString() + 'ƒë' : '-') + '</td><td class="px-4 py-3">' + (p.status === 'completed' ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">‚úì ƒê√£ duy·ªát</span>' : '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">‚è≥ Ch·ªù duy·ªát</span>') + '</td><td class="px-4 py-3 text-sm text-gray-600">' + (p.createdAt ? new Date(p.createdAt).toLocaleDateString('vi-VN') : '-') + '</td><td class="px-4 py-3 text-center">' + (p.status === 'pending' ? '<button onclick="approvePayment(\'' + p.id + '\')" class="text-green-600 hover:text-green-800 mr-2">‚úì</button>' : '') + '<button onclick="deletePayment(\'' + p.id + '\')" class="text-red-600 hover:text-red-800">üóëÔ∏è</button></td></tr>').join('')}</tbody>
                    </table>
                </div>
            `;
        }

        async function approvePayment(id) {
            if (!confirm('Duy·ªát thanh to√°n n√†y? Ng∆∞·ªùi d√πng s·∫Ω ƒë∆∞·ª£c n√¢ng c·∫•p l√™n Pro.')) return;
            try { await fetch(API + '/admin/payments/' + id + '/approve', { method: 'POST' }); loadDashboard(); } catch (e) { alert('L·ªói!'); }
        }

        async function deletePayment(id) { if (!confirm('X√≥a giao d·ªãch n√†y?')) return; try { await fetch(API + '/admin/payments/' + id, { method: 'DELETE' }); loadDashboard(); } catch (e) { alert('L·ªói!'); } }

        // ========== SETTINGS ==========
        function renderSettings(el) {
            const s = allData.settings || {};
            el.innerHTML = `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">‚öôÔ∏è C√†i ƒë·∫∑t h·ªá th·ªëng</h2>
                    <p class="text-gray-500">C·∫•u h√¨nh th√¥ng tin c√¥ng ty v√† ·ª©ng d·ª•ng</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>üè¢</span> Th√¥ng tin c√¥ng ty</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">T√™n c√¥ng ty</label><input type="text" id="settingCompanyName" value="${s.companyName || 'HTIC LAW FIRM'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Website</label><input type="text" id="settingWebsite" value="${s.website || 'www.htic.com.vn'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Hotline</label><input type="text" id="settingPhone" value="${s.phone || '0379 044 299'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none"></div>
                        <div><label class="block text-sm font-semibold text-gray-700 mb-2">Email li√™n h·ªá</label><input type="text" id="settingEmail" value="${s.email || 'contact@htic.com.vn'}" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none"></div>
                        <div class="md:col-span-2"><label class="block text-sm font-semibold text-gray-700 mb-2">ƒê·ªãa ch·ªâ</label><textarea id="settingAddress" rows="2" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-navy-500 focus:outline-none">${s.address || 'H√† N·ªôi, Vi·ªát Nam'}</textarea></div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button onclick="saveSettings()" class="px-8 py-3 bg-gradient-to-r from-navy-600 to-navy-700 text-white rounded-xl font-semibold hover:opacity-90 shadow-lg flex items-center gap-2"><span>üíæ</span> L∆∞u c√†i ƒë·∫∑t</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2"><span>‚ÑπÔ∏è</span> Th√¥ng tin h·ªá th·ªëng</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-gray-50 rounded-xl"><p class="text-sm text-gray-500">Phi√™n b·∫£n</p><p class="font-bold text-gray-900">10.1</p></div>
                        <div class="p-4 bg-gray-50 rounded-xl"><p class="text-sm text-gray-500">S·ª± ki·ªán</p><p class="font-bold text-gray-900">${allData.events.length}</p></div>
                        <div class="p-4 bg-gray-50 rounded-xl"><p class="text-sm text-gray-500">Ng∆∞·ªùi d√πng</p><p class="font-bold text-gray-900">${allData.users.length}</p></div>
                        <div class="p-4 bg-gray-50 rounded-xl"><p class="text-sm text-gray-500">H·ªó tr·ª£ ch·ªù</p><p class="font-bold text-gray-900">${allData.supportRequests.filter(r => r.status === 'pending').length}</p></div>
                    </div>
                </div>
            `;
        }

        async function saveSettings() {
            const data = {
                companyName: document.getElementById('settingCompanyName').value,
                website: document.getElementById('settingWebsite').value,
                phone: document.getElementById('settingPhone').value,
                email: document.getElementById('settingEmail').value,
                address: document.getElementById('settingAddress').value
            };
            try {
                await fetch(API + '/admin/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                alert('‚úì ƒê√£ l∆∞u c√†i ƒë·∫∑t!');
                loadDashboard();
            } catch (e) { alert('L·ªói l∆∞u!'); }
        }

        // ========== HELPERS ==========
        function closeModal() { modalRoot.innerHTML = ''; quillEditor = null; }
        function stripHtml(html) { const t = document.createElement('div'); t.innerHTML = html; return t.textContent || t.innerText || ''; }
        function getFrequencyName(freq) { const f = FREQUENCIES.find(x => x.id === freq); return f ? f.name : freq; }
        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }

        // ========== START ==========
        checkAuth();
    </script>
</body>
</html>
