<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTIC Legal Calendar - Admin v17.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>tailwind.config={theme:{extend:{colors:{navy:{50:'#e8eef5',100:'#c5d4e8',500:'#3d6d9e',600:'#1e3a5f',700:'#162d4a'}}}}}</script>
    <style>
        *{font-family:'Inter',sans-serif}
        .hide-scrollbar::-webkit-scrollbar{display:none}
        .sidebar-item{transition:all 0.2s}
        .sidebar-item:hover{background:rgba(255,255,255,0.1)}
        .sidebar-item.active{background:rgba(255,255,255,0.2);border-left:4px solid #f5c842}
        .card{background:white;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:100}
        .modal-content{background:white;border-radius:16px;max-width:800px;width:95%;max-height:90vh;overflow-y:auto}
        .btn-primary{background:#1e3a5f;color:white;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;border:none}
        .btn-primary:hover{background:#162d4a}
        .btn-danger{background:#dc2626;color:white;padding:8px 16px;border-radius:8px;cursor:pointer;border:none}
        .input-field{width:100%;padding:10px 14px;border:2px solid #e2e8f0;border-radius:8px;outline:none}
        .input-field:focus{border-color:#1e3a5f}
        select.input-field{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;background-size:20px}
        .badge{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
        .badge-green{background:#d1fae5;color:#059669}
        .badge-red{background:#fee2e2;color:#dc2626}
        .badge-blue{background:#dbeafe;color:#2563eb}
        .badge-yellow{background:#fef3c7;color:#d97706}
        .badge-gray{background:#f3f4f6;color:#6b7280}
        .table-row:hover{background:#f8fafc}
        .avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#1e3a5f,#3d6d9e);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;overflow:hidden}
        .avatar img{width:100%;height:100%;object-fit:cover}
        .tab-btn{padding:12px 24px;cursor:pointer;border-bottom:2px solid transparent}
        .tab-btn.active{border-color:#1e3a5f;color:#1e3a5f;font-weight:600}
        /* Quill Editor Styles */
        .ql-container{border-radius:0 0 8px 8px;min-height:150px;font-size:14px}
        .ql-toolbar{border-radius:8px 8px 0 0;background:#f8fafc}
        .ql-editor{min-height:150px}
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>
    <div id="modal-root"></div>

    <script>
        const API = '/api';
        let token = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';
        
        // Master data
        let provinces = [];
        let wards = [];
        let orgTypes = [];
        let categories = [];

        const app = document.getElementById('app');
        const modalRoot = document.getElementById('modal-root');

        // ========== CLEAN HTML - Lo·∫°i b·ªè CSS Tailwind ==========
        // X√≥a TO√ÄN B·ªò HTML tags, ch·ªâ gi·ªØ l·∫°i text thu·∫ßn (d√πng cho summary)
        function stripHTML(html) {
            if (!html) return '';
            let text = html;
            // Decode HTML entities
            text = text.replace(/&nbsp;/gi, ' ');
            text = text.replace(/&amp;/gi, '&');
            text = text.replace(/&lt;/gi, '<');
            text = text.replace(/&gt;/gi, '>');
            text = text.replace(/&quot;/gi, '"');
            // X√≥a t·∫•t c·∫£ HTML tags
            text = text.replace(/<[^>]*>/g, '');
            // X√≥a CSS variables c√≤n s√≥t
            text = text.replace(/--[\w-]+\s*:[^;]*;?\s*/g, '');
            // Clean up whitespace
            text = text.replace(/\s+/g, ' ');
            return text.trim();
        }

        // Gi·ªØ HTML structure nh∆∞ng x√≥a style/class (d√πng cho content)
        function cleanHTML(html) {
            if (!html) return '';
            let text = html;
            // Lo·∫°i b·ªè style attributes
            text = text.replace(/\s*style\s*=\s*"[^"]*"/gi, '');
            text = text.replace(/\s*style\s*=\s*'[^']*'/gi, '');
            // Lo·∫°i b·ªè class attributes
            text = text.replace(/\s*class\s*=\s*"[^"]*"/gi, '');
            text = text.replace(/\s*class\s*=\s*'[^']*'/gi, '');
            // Lo·∫°i b·ªè data-* attributes
            text = text.replace(/\s*data-[\w-]+\s*=\s*"[^"]*"/gi, '');
            // Lo·∫°i b·ªè CSS variables
            text = text.replace(/--[\w-]+\s*:[^;]*;?\s*/g, '');
            // Clean up whitespace trong tags
            text = text.replace(/<(\w+)\s+>/g, '<$1>');
            return text.trim();
        }

        // Escape HTML ƒë·ªÉ tr√°nh XSS v√† l·ªói hi·ªÉn th·ªã
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== CONSTANTS ==========
        const CATEGORIES = [
            { id: 'tax', name: 'Thu·∫ø', icon: 'üí∞', color: 'blue' },
            { id: 'insurance', name: 'B·∫£o hi·ªÉm', icon: 'üè•', color: 'green' },
            { id: 'labor', name: 'Lao ƒë·ªông', icon: 'üë∑', color: 'orange' },
            { id: 'safety', name: 'An to√†n', icon: 'üõ°Ô∏è', color: 'red' },
            { id: 'environment', name: 'M√¥i tr∆∞·ªùng', icon: 'üåø', color: 'emerald' },
            { id: 'investment', name: 'ƒê·∫ßu t∆∞', icon: 'üìà', color: 'purple' },
            { id: 'report', name: 'B√°o c√°o', icon: 'üìä', color: 'indigo' },
            { id: 'license', name: 'Gi·∫•y ph√©p', icon: 'üìã', color: 'gray' },
            { id: 'holiday', name: 'Ngh·ªâ l·ªÖ', icon: 'üéâ', color: 'pink' }
        ];

        const FREQUENCIES = [
            { id: 'once', name: 'M·ªôt l·∫ßn (c√≥ ng√†y c·ª• th·ªÉ)' },
            { id: 'monthly', name: 'H√†ng th√°ng' },
            { id: 'quarterly', name: 'H√†ng qu√Ω' },
            { id: 'yearly', name: 'H√†ng nƒÉm' }
        ];

        const NEWS_CATEGORIES = ['Thu·∫ø', 'BHXH', 'Doanh nghi·ªáp', 'Lao ƒë·ªông', 'Ph√°p lu·∫≠t'];

        // ========== AUTH ==========
        function checkAuth() {
            if (!token) showLogin();
            else { loadMasterData(); showDashboard(); }
        }

        async function loadMasterData() {
            try {
                const headers = { 'Authorization': 'Bearer ' + token };
                const [provRes, typesRes, catRes] = await Promise.all([
                    fetch(API + '/admin/provinces', { headers }),
                    fetch(API + '/admin/org-types', { headers }),
                    fetch(API + '/categories', { headers })
                ]);
                const provData = await provRes.json();
                const typesData = await typesRes.json();
                const catData = await catRes.json();
                if (provData.success) provinces = provData.data;
                if (typesData.success) orgTypes = typesData.data;
                if (catData.success) categories = catData.data;
            } catch (e) { console.error('Load master data error:', e); }
        }

        async function loadWardsByProvince(provinceId) {
            if (!provinceId) return [];
            try {
                const res = await fetch(API + '/admin/wards?province_id=' + provinceId, { 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                const data = await res.json();
                if (data.success) return data.data;
            } catch (e) { console.error(e); }
            return [];
        }

        function showLogin() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-600 to-navy-700 p-4">
                    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-navy-600 to-navy-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <span class="text-white text-3xl font-bold">H</span>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900">HTIC Admin v17.3</h1>
                            <p class="text-gray-500 mt-2">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω</p>
                        </div>
                        <div id="loginError" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                                <input type="text" id="username" class="input-field" placeholder="admin" value="admin">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">M·∫≠t kh·∫©u</label>
                                <input type="password" id="password" class="input-field" placeholder="********" onkeypress="if(event.key==='Enter')login()">
                            </div>
                            <button onclick="login()" class="w-full btn-primary py-3">ƒêƒÉng nh·∫≠p</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('loginError');
            try {
                const res = await fetch(API + '/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    loadMasterData();
                    showDashboard();
                } else {
                    errorEl.textContent = data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i';
                    errorEl.classList.remove('hidden');
                }
            } catch (e) {
                errorEl.textContent = 'L·ªói k·∫øt n·ªëi server';
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            localStorage.removeItem('adminToken');
            showLogin();
        }

        // ========== DASHBOARD LAYOUT ==========
        function showDashboard() {
            app.innerHTML = `
                <div class="flex h-screen">
                    <div class="w-64 bg-navy-600 text-white flex flex-col fixed h-full">
                        <div class="p-6 border-b border-white/10">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center font-bold text-xl">H</div>
                                <div>
                                    <div class="font-bold">HTIC Admin</div>
                                    <div class="text-xs text-white/60">Legal Calendar v17.1</div>
                                </div>
                            </div>
                        </div>
                        <nav class="flex-1 py-4 overflow-y-auto hide-scrollbar">
                            <div onclick="loadSection('dashboard')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="dashboard">
                                <span class="material-icons text-sm">dashboard</span> T·ªïng quan
                            </div>
                            <div onclick="loadSection('events')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="events">
                                <span class="material-icons text-sm">event</span> L·ªãch ph√°p l√Ω
                            </div>
                            <div onclick="loadSection('news')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="news">
                                <span class="material-icons text-sm">article</span> Tin t·ª©c
                            </div>
                            <div onclick="loadSection('organizations')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="organizations">
                                <span class="material-icons text-sm">business</span> C∆° quan tra c·ª©u
                            </div>
                            <div onclick="loadSection('lawyers')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="lawyers">
                                <span class="material-icons text-sm">gavel</span> Lu·∫≠t s∆∞ h·ªó tr·ª£
                            </div>
                            <div onclick="loadSection('support')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="support">
                                <span class="material-icons text-sm">support_agent</span> Y√™u c·∫ßu t∆∞ v·∫•n
                            </div>
                            <div class="border-t border-white/10 my-2"></div>
                            <div onclick="loadSection('locations')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="locations">
                                <span class="material-icons text-sm">location_on</span> Qu·∫£n l√Ω ƒë·ªãa ƒëi·ªÉm
                            </div>
                            <div onclick="loadSection('settings')" class="sidebar-item px-6 py-3 cursor-pointer flex items-center gap-3" data-section="settings">
                                <span class="material-icons text-sm">settings</span> C√†i ƒë·∫∑t App
                            </div>
                        </nav>
                        <div class="p-4 border-t border-white/10">
                            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 py-2 text-red-300 hover:text-red-200">
                                <span class="material-icons text-sm">logout</span> ƒêƒÉng xu·∫•t
                            </button>
                        </div>
                    </div>
                    <div class="ml-64 flex-1 overflow-auto bg-gray-100">
                        <div id="content" class="p-6"></div>
                    </div>
                </div>
            `;
            loadSection(currentSection);
        }

        function loadSection(section) {
            currentSection = section;
            document.querySelectorAll('.sidebar-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.section === section) el.classList.add('active');
            });
            
            switch(section) {
                case 'dashboard': loadDashboardContent(); break;
                case 'events': loadEventsContent(); break;
                case 'news': loadNewsContent(); break;
                case 'organizations': loadOrganizationsContent(); break;
                case 'lawyers': loadLawyersContent(); break;
                case 'support': loadSupportContent(); break;
                case 'locations': loadLocationsContent(); break;
                case 'settings': loadSettingsContent(); break;
            }
        }

        function closeModal() { modalRoot.innerHTML = ''; }
        function getHeaders() { return { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }; }

        // ========== DASHBOARD ==========
        async function loadDashboardContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/stats', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    const s = data.data;
                    content.innerHTML = `
                        <h1 class="text-2xl font-bold text-gray-900 mb-6">T·ªïng quan</h1>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="card p-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center"><span class="material-icons text-blue-600">event</span></div>
                                    <div><div class="text-2xl font-bold">${s.events?.total || 0}</div><div class="text-sm text-gray-500">S·ª± ki·ªán ph√°p l√Ω</div></div>
                                </div>
                            </div>
                            <div class="card p-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center"><span class="material-icons text-green-600">article</span></div>
                                    <div><div class="text-2xl font-bold">${s.news?.total || 0}</div><div class="text-sm text-gray-500">Tin t·ª©c</div></div>
                                </div>
                            </div>
                            <div class="card p-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center"><span class="material-icons text-purple-600">gavel</span></div>
                                    <div><div class="text-2xl font-bold">${s.lawyers?.total || 0}</div><div class="text-sm text-gray-500">Lu·∫≠t s∆∞</div></div>
                                </div>
                            </div>
                            <div class="card p-6">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center"><span class="material-icons text-orange-600">support_agent</span></div>
                                    <div><div class="text-2xl font-bold">${s.support_requests?.pending || 0}</div><div class="text-sm text-gray-500">Y√™u c·∫ßu ch·ªù x·ª≠ l√Ω</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="card p-6">
                                <h2 class="text-lg font-bold mb-4">Th·ªëng k√™ h·ªá th·ªëng</h2>
                                <div class="space-y-3">
                                    <div class="flex justify-between py-2 border-b"><span class="text-gray-600">T·ªânh/Th√†nh ph·ªë</span><span class="font-semibold">${provinces.length}</span></div>
                                    <div class="flex justify-between py-2 border-b"><span class="text-gray-600">C∆° quan tra c·ª©u</span><span class="font-semibold">${s.organizations?.total || 0}</span></div>
                                    <div class="flex justify-between py-2 border-b"><span class="text-gray-600">Lo·∫°i c∆° quan</span><span class="font-semibold">${orgTypes.length}</span></div>
                                    <div class="flex justify-between py-2"><span class="text-gray-600">Phi√™n b·∫£n</span><span class="font-semibold text-navy-600">v17.1</span></div>
                                </div>
                            </div>
                            <div class="card p-6">
                                <h2 class="text-lg font-bold mb-4">Y√™u c·∫ßu g·∫ßn ƒë√¢y</h2>
                                <div id="recent-requests" class="text-gray-500 text-center py-4">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                    `;
                    loadRecentRequests();
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500 text-center py-10">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        async function loadRecentRequests() {
            try {
                const res = await fetch(API + '/admin/support-requests', { headers: getHeaders() });
                const data = await res.json();
                const container = document.getElementById('recent-requests');
                if (data.success && data.data.length > 0) {
                    container.innerHTML = data.data.slice(0, 5).map(r => `
                        <div class="flex items-center justify-between py-2 border-b last:border-0">
                            <div>
                                <div class="font-medium text-sm">${r.name}</div>
                                <div class="text-xs text-gray-500">${r.subject || r.category}</div>
                            </div>
                            <span class="badge ${r.status === 'pending' ? 'badge-yellow' : r.status === 'completed' ? 'badge-green' : 'badge-blue'}">${r.status === 'pending' ? 'Ch·ªù' : r.status === 'completed' ? 'Xong' : r.status}</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="text-gray-400">Ch∆∞a c√≥ y√™u c·∫ßu</div>';
                }
            } catch (e) { console.error(e); }
        }

        // ========== EVENTS ==========
        async function loadEventsContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/events', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    content.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">L·ªãch ph√°p l√Ω</h1>
                            <button onclick="showEventModal()" class="btn-primary flex items-center gap-2"><span class="material-icons text-sm">add</span> Th√™m m·ªõi</button>
                        </div>
                        <div class="card overflow-hidden">
                            <table class="w-full">
                                <thead><tr class="bg-gray-50 text-left text-sm text-gray-500"><th class="p-4">TI√äU ƒê·ªÄ</th><th class="p-4">DANH M·ª§C</th><th class="p-4">NG√ÄY</th><th class="p-4">TR·∫†NG TH√ÅI</th><th class="p-4">THAO T√ÅC</th></tr></thead>
                                <tbody>${data.data.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ s·ª± ki·ªán</td></tr>' : data.data.map(e => `
                                    <tr class="table-row border-t">
                                        <td class="p-4"><div class="font-medium">${e.title}</div><div class="text-xs text-gray-500 mt-1">${(e.description || '').substring(0, 50)}...</div></td>
                                        <td class="p-4"><span class="badge badge-blue">${e.category || '-'}</span></td>
                                        <td class="p-4 text-sm">${e.date ? new Date(e.date).toLocaleDateString('vi-VN') : '-'}</td>
                                        <td class="p-4"><span class="badge ${e.is_active ? 'badge-green' : 'badge-gray'}">${e.is_active ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}</span></td>
                                        <td class="p-4">
                                            <button onclick='showEventModal(${JSON.stringify(e).replace(/'/g, "\\'")})' class="text-blue-600 hover:text-blue-800 mr-2"><span class="material-icons text-sm">edit</span></button>
                                            <button onclick="deleteEvent(${e.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                                        </td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        function showEventModal(event = null) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">${event ? 'S·ª≠a' : 'Th√™m'} s·ª± ki·ªán</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ *</label>
                                <input type="text" id="event-title" class="input-field" value="${event?.title || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Danh m·ª•c</label>
                                <select id="event-category" class="input-field">
                                    ${CATEGORIES.map(c => `<option value="${c.id}" ${event?.category === c.id ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">T·∫ßn su·∫•t</label>
                                <select id="event-frequency" class="input-field">
                                    ${FREQUENCIES.map(f => `<option value="${f.id}" ${event?.frequency === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ng√†y</label>
                                <input type="date" id="event-date" class="input-field" value="${event?.date ? event.date.split('T')[0] : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ng√†y trong th√°ng (n·∫øu h√†ng th√°ng)</label>
                                <input type="number" id="event-day" class="input-field" min="1" max="31" value="${event?.day_of_month || ''}">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">M√¥ t·∫£</label>
                                <textarea id="event-desc" class="input-field" rows="3">${event?.description || ''}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">CƒÉn c·ª© ph√°p l√Ω</label>
                                <input type="text" id="event-legal" class="input-field" value="${event?.legal_basis || ''}">
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="flex items-center gap-2"><input type="checkbox" id="event-active" ${event?.is_active !== false ? 'checked' : ''}> K√≠ch ho·∫°t</label>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 border rounded-lg">H·ªßy</button>
                            <button onclick="saveEvent(${event?.id || 'null'})" class="btn-primary">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveEvent(id) {
            const data = {
                title: document.getElementById('event-title').value,
                category: document.getElementById('event-category').value,
                frequency: document.getElementById('event-frequency').value,
                date: document.getElementById('event-date').value || null,
                day_of_month: document.getElementById('event-day').value || null,
                description: document.getElementById('event-desc').value,
                legal_basis: document.getElementById('event-legal').value,
                is_active: document.getElementById('event-active').checked
            };
            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ'); return; }
            try {
                const res = await fetch(API + '/admin/events' + (id ? '/' + id : ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { closeModal(); loadEventsContent(); }
                else alert(result.message || 'L·ªói');
            } catch (e) { alert('L·ªói k·∫øt n·ªëi'); }
        }

        async function deleteEvent(id) {
            if (!confirm('X√≥a s·ª± ki·ªán n√†y?')) return;
            try {
                const res = await fetch(API + '/admin/events/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) loadEventsContent();
            } catch (e) { alert('L·ªói'); }
        }

        // ========== NEWS ==========
        let newsData = []; // L∆∞u danh s√°ch tin t·ª©c
        
        async function loadNewsContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/news', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    newsData = data.data || []; // L∆∞u v√†o bi·∫øn
                    content.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">Tin t·ª©c</h1>
                            <div class="flex gap-2">
                                <button onclick="cleanAllNews()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg flex items-center gap-2" title="X√≥a CSS Tailwind kh·ªèi t·∫•t c·∫£ tin t·ª©c"><span class="material-icons text-sm">cleaning_services</span> Clean CSS</button>
                                <button onclick="showNewsModal()" class="btn-primary flex items-center gap-2"><span class="material-icons text-sm">add</span> Th√™m m·ªõi</button>
                            </div>
                        </div>
                        <div class="card overflow-hidden">
                            <table class="w-full">
                                <thead><tr class="bg-gray-50 text-left text-sm text-gray-500"><th class="p-4">TI√äU ƒê·ªÄ</th><th class="p-4">DANH M·ª§C</th><th class="p-4">NG√ÄY ƒêƒÇNG</th><th class="p-4">TR·∫†NG TH√ÅI</th><th class="p-4">THAO T√ÅC</th></tr></thead>
                                <tbody>${data.data.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ tin t·ª©c</td></tr>' : data.data.map(n => `
                                    <tr class="table-row border-t">
                                        <td class="p-4"><div class="font-medium" style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(n.title || '')}</div></td>
                                        <td class="p-4"><span class="badge badge-blue">${escapeHtml(n.category || '-')}</span></td>
                                        <td class="p-4 text-sm">${n.published_at ? new Date(n.published_at).toLocaleDateString('vi-VN') : '-'}</td>
                                        <td class="p-4"><span class="badge ${n.is_active ? 'badge-green' : 'badge-gray'}">${n.is_active ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}</span></td>
                                        <td class="p-4">
                                            <button onclick="editNews(${n.id})" class="text-blue-600 hover:text-blue-800 mr-2"><span class="material-icons text-sm">edit</span></button>
                                            <button onclick="deleteNews(${n.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                                        </td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        function showNewsModal(news = null) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6" style="max-width:900px">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">${news ? 'S·ª≠a' : 'Th√™m'} tin t·ª©c</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ti√™u ƒë·ªÅ *</label>
                                <input type="text" id="news-title" class="input-field" value="${news?.title || ''}">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Danh m·ª•c</label>
                                    <select id="news-category" class="input-field">
                                        ${NEWS_CATEGORIES.map(c => `<option value="${c}" ${news?.category === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ngu·ªìn</label>
                                    <input type="text" id="news-source" class="input-field" value="${news?.source || ''}">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">T√≥m t·∫Øt</label>
                                <textarea id="news-summary" class="input-field" rows="2">${news?.summary || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">N·ªôi dung</label>
                                <div id="news-editor" style="border:2px solid #e2e8f0;border-radius:8px;overflow:hidden"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">URL h√¨nh ·∫£nh</label>
                                    <input type="text" id="news-image" class="input-field" value="${news?.image_url || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Link b√†i g·ªëc</label>
                                    <input type="text" id="news-source-url" class="input-field" value="${news?.source_url || ''}" placeholder="https://...">
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ng√†y ƒëƒÉng</label>
                                    <input type="datetime-local" id="news-published" class="input-field" value="${news?.published_at ? new Date(news.published_at).toISOString().slice(0,16) : new Date().toISOString().slice(0,16)}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">T√°c gi·∫£</label>
                                    <input type="text" id="news-author" class="input-field" value="${news?.author || ''}" placeholder="T√™n t√°c gi·∫£">
                                </div>
                                <div class="flex items-end pb-2">
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2"><input type="checkbox" id="news-featured" ${news?.is_featured ? 'checked' : ''}> N·ªïi b·∫≠t</label>
                                        <label class="flex items-center gap-2"><input type="checkbox" id="news-active" ${news?.is_active !== false ? 'checked' : ''}> K√≠ch ho·∫°t</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 border rounded-lg">H·ªßy</button>
                            <button onclick="saveNews(${news?.id || 'null'})" class="btn-primary">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
            // Init Quill editor
            setTimeout(() => {
                window.newsEditor = new Quill('#news-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'align': [] }],
                            ['link', 'image'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Nh·∫≠p n·ªôi dung tin t·ª©c...'
                });
                if (news?.content) {
                    window.newsEditor.root.innerHTML = news.content;
                }
            }, 100);
        }

        async function saveNews(id) {
            const data = {
                title: document.getElementById('news-title').value,
                category: document.getElementById('news-category').value,
                source: document.getElementById('news-source').value,
                // stripHTML cho summary (plain text), cleanHTML cho content (gi·ªØ format)
                summary: stripHTML(document.getElementById('news-summary').value),
                content: cleanHTML(window.newsEditor ? window.newsEditor.root.innerHTML : ''),
                image_url: document.getElementById('news-image').value,
                source_url: document.getElementById('news-source-url')?.value || '',
                published_at: document.getElementById('news-published').value || new Date().toISOString(),
                author: document.getElementById('news-author')?.value || '',
                is_featured: document.getElementById('news-featured').checked,
                is_active: document.getElementById('news-active').checked
            };
            if (!data.title) { alert('Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ'); return; }
            try {
                const res = await fetch(API + '/admin/news' + (id ? '/' + id : ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { closeModal(); loadNewsContent(); }
                else alert(result.message || 'L·ªói');
            } catch (e) { alert('L·ªói k·∫øt n·ªëi'); }
        }

        async function editNews(id) {
            // T√¨m tin t·ª©c t·ª´ d·ªØ li·ªáu ƒë√£ load
            const news = newsData.find(n => n.id === id);
            if (news) {
                showNewsModal(news);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y tin t·ª©c');
            }
        }

        async function deleteNews(id) {
            if (!confirm('X√≥a tin t·ª©c n√†y?')) return;
            try {
                const res = await fetch(API + '/admin/news/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) loadNewsContent();
            } catch (e) { alert('L·ªói'); }
        }

        async function cleanAllNews() {
            if (!confirm('Clean CSS Tailwind kh·ªèi t·∫•t c·∫£ tin t·ª©c?\n\nThao t√°c n√†y s·∫Ω lo·∫°i b·ªè c√°c style CSS kh√¥ng c·∫ßn thi·∫øt t·ª´ n·ªôi dung tin t·ª©c.')) return;
            try {
                const btn = event.target.closest('button');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons text-sm animate-spin">sync</span> ƒêang x·ª≠ l√Ω...';
                
                const res = await fetch(API + '/admin/clean-news', { headers: getHeaders() });
                const result = await res.json();
                
                if (result.success) {
                    alert(`‚úÖ Ho√†n t·∫•t!\n\n${result.message}`);
                    loadNewsContent();
                } else {
                    alert('‚ùå L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ clean'));
                }
            } catch (e) {
                alert('‚ùå L·ªói k·∫øt n·ªëi: ' + e.message);
            }
        }

        // ========== ORGANIZATIONS ==========
        async function loadOrganizationsContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/organizations', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    content.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">C∆° quan tra c·ª©u</h1>
                            <button onclick="showOrgModal()" class="btn-primary flex items-center gap-2"><span class="material-icons text-sm">add</span> Th√™m m·ªõi</button>
                        </div>
                        <div class="card overflow-hidden">
                            <table class="w-full">
                                <thead><tr class="bg-gray-50 text-left text-sm text-gray-500"><th class="p-4">T√äN C∆† QUAN</th><th class="p-4">LO·∫†I</th><th class="p-4">ƒê·ªäA CH·ªà</th><th class="p-4">TR·∫†NG TH√ÅI</th><th class="p-4">THAO T√ÅC</th></tr></thead>
                                <tbody>${data.data.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>' : data.data.map(o => `
                                    <tr class="table-row border-t">
                                        <td class="p-4 font-medium">${o.name}</td>
                                        <td class="p-4"><span class="badge badge-blue">${o.type_name || '-'}</span></td>
                                        <td class="p-4 text-sm text-gray-600">${[o.ward_name, o.province_name].filter(Boolean).join(', ') || o.address || '-'}</td>
                                        <td class="p-4"><span class="badge ${o.is_active ? 'badge-green' : 'badge-gray'}">${o.is_active ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}</span></td>
                                        <td class="p-4">
                                            <button onclick='showOrgModal(${JSON.stringify(o).replace(/'/g, "\\'")})' class="text-blue-600 hover:text-blue-800 mr-2"><span class="material-icons text-sm">edit</span></button>
                                            <button onclick="deleteOrg(${o.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                                        </td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        function showOrgModal(org = null) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">${org ? 'S·ª≠a' : 'Th√™m'} c∆° quan</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">T√™n c∆° quan *</label>
                                <input type="text" id="org-name" class="input-field" value="${org?.name || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Lo·∫°i c∆° quan</label>
                                <select id="org-type" class="input-field">
                                    <option value="">-- Ch·ªçn lo·∫°i --</option>
                                    ${orgTypes.map(t => `<option value="${t.id}" ${org?.type_id == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">T·ªânh/Th√†nh ph·ªë</label>
                                <select id="org-province" class="input-field" onchange="loadOrgWards()">
                                    <option value="">-- Ch·ªçn --</option>
                                    ${provinces.map(p => `<option value="${p.id}" ${org?.province_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ph∆∞·ªùng/X√£</label>
                                <select id="org-ward" class="input-field">
                                    <option value="">-- Ch·ªçn t·ªânh/th√†nh tr∆∞·ªõc --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                                <input type="text" id="org-address" class="input-field" value="${org?.address || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">ƒêi·ªán tho·∫°i</label>
                                <input type="text" id="org-phone" class="input-field" value="${org?.phone || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Email</label>
                                <input type="email" id="org-email" class="input-field" value="${org?.email || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Website</label>
                                <input type="text" id="org-website" class="input-field" value="${org?.website || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Gi·ªù l√†m vi·ªác</label>
                                <input type="text" id="org-hours" class="input-field" value="${org?.working_hours || ''}" placeholder="VD: 7:30 - 16:30">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">M√¥ t·∫£ / D·ªãch v·ª•</label>
                                <textarea id="org-desc" class="input-field" rows="2">${org?.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="flex items-center gap-2"><input type="checkbox" id="org-active" ${org?.is_active !== false ? 'checked' : ''}> K√≠ch ho·∫°t</label>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 border rounded-lg">H·ªßy</button>
                            <button onclick="saveOrg(${org?.id || 'null'})" class="btn-primary">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
            if (org?.province_id) setTimeout(() => loadOrgWards(org.ward_id), 100);
        }

        async function loadOrgWards(selectedWardId = null) {
            const provinceId = document.getElementById('org-province').value;
            const wardSelect = document.getElementById('org-ward');
            if (!provinceId) {
                wardSelect.innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh tr∆∞·ªõc --</option>';
                return;
            }
            const wardsData = await loadWardsByProvince(provinceId);
            wardSelect.innerHTML = '<option value="">-- Ch·ªçn --</option>' + wardsData.map(w => 
                `<option value="${w.id}" ${selectedWardId == w.id ? 'selected' : ''}>${w.name}</option>`
            ).join('');
        }

        async function saveOrg(id) {
            const data = {
                name: document.getElementById('org-name').value,
                type_id: document.getElementById('org-type').value || null,
                province_id: document.getElementById('org-province').value || null,
                ward_id: document.getElementById('org-ward').value || null,
                address: document.getElementById('org-address').value,
                phone: document.getElementById('org-phone').value,
                email: document.getElementById('org-email').value,
                website: document.getElementById('org-website').value,
                working_hours: document.getElementById('org-hours').value,
                description: document.getElementById('org-desc').value,
                is_active: document.getElementById('org-active').checked
            };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p t√™n'); return; }
            try {
                const res = await fetch(API + '/admin/organizations' + (id ? '/' + id : ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { closeModal(); loadOrganizationsContent(); }
                else alert(result.message || 'L·ªói');
            } catch (e) { alert('L·ªói k·∫øt n·ªëi'); }
        }

        async function deleteOrg(id) {
            if (!confirm('X√≥a c∆° quan n√†y?')) return;
            try {
                const res = await fetch(API + '/admin/organizations/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) loadOrganizationsContent();
            } catch (e) { alert('L·ªói'); }
        }

        // ========== LAWYERS ==========
        async function loadLawyersContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/lawyers', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    content.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">Lu·∫≠t s∆∞ h·ªó tr·ª£</h1>
                            <button onclick="showLawyerModal()" class="btn-primary flex items-center gap-2"><span class="material-icons text-sm">add</span> Th√™m m·ªõi</button>
                        </div>
                        <div class="card overflow-hidden">
                            <table class="w-full">
                                <thead><tr class="bg-gray-50 text-left text-sm text-gray-500"><th class="p-4">H·ªå T√äN</th><th class="p-4">C√îNG TY</th><th class="p-4">ƒêI·ªÜN THO·∫†I</th><th class="p-4">ƒê·ªäA CH·ªà</th><th class="p-4">ONLINE</th><th class="p-4">THAO T√ÅC</th></tr></thead>
                                <tbody>${data.data.length === 0 ? '<tr><td colspan="6" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>' : data.data.map(l => `
                                    <tr class="table-row border-t">
                                        <td class="p-4">
                                            <div class="flex items-center gap-3">
                                                <div class="avatar">${l.avatar_url ? `<img src="${l.avatar_url}" onerror="this.style.display='none';this.parentElement.innerHTML='${l.name.charAt(0)}'">` : l.name.charAt(0)}</div>
                                                <div><div class="font-medium">${l.name}</div>${l.is_primary ? '<span class="badge badge-blue text-xs">Ch√≠nh</span>' : ''}</div>
                                            </div>
                                        </td>
                                        <td class="p-4 text-gray-600">${l.company || '-'}</td>
                                        <td class="p-4">${l.phone || '-'}</td>
                                        <td class="p-4 text-sm text-gray-500">${[l.ward_name, l.province_name].filter(Boolean).join(', ') || '-'}</td>
                                        <td class="p-4"><span class="badge ${l.is_online ? 'badge-green' : 'badge-red'}">${l.is_online ? 'Online' : 'Offline'}</span></td>
                                        <td class="p-4">
                                            <button onclick='showLawyerModal(${JSON.stringify(l).replace(/'/g, "\\'")})' class="text-blue-600 hover:text-blue-800 mr-2"><span class="material-icons text-sm">edit</span></button>
                                            <button onclick="deleteLawyer(${l.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                                        </td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        function showLawyerModal(lawyer = null) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">${lawyer ? 'S·ª≠a' : 'Th√™m'} lu·∫≠t s∆∞</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="flex gap-6 mb-6">
                            <div class="flex flex-col items-center">
                                <div class="avatar w-20 h-20 text-2xl" id="lawyer-avatar-preview">${lawyer?.avatar_url ? `<img src="${lawyer.avatar_url}">` : (lawyer?.name?.charAt(0) || 'LS')}</div>
                                <span class="text-xs text-gray-400 mt-2">Avatar</span>
                            </div>
                            <div class="flex-1">
                                <label class="block text-sm font-semibold mb-2">URL ·∫¢nh ƒë·∫°i di·ªán</label>
                                <input type="text" id="lawyer-avatar" class="input-field" value="${lawyer?.avatar_url || ''}" placeholder="https://..." oninput="updateLawyerPreview()">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">H·ªç t√™n *</label>
                                <input type="text" id="lawyer-name" class="input-field" value="${lawyer?.name || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">C√¥ng ty</label>
                                <input type="text" id="lawyer-company" class="input-field" value="${lawyer?.company || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">ƒêi·ªán tho·∫°i</label>
                                <input type="text" id="lawyer-phone" class="input-field" value="${lawyer?.phone || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Zalo</label>
                                <input type="text" id="lawyer-zalo" class="input-field" value="${lawyer?.zalo || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Email</label>
                                <input type="email" id="lawyer-email" class="input-field" value="${lawyer?.email || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Chuy√™n m√¥n</label>
                                <input type="text" id="lawyer-spec" class="input-field" value="${lawyer?.specialization || ''}" placeholder="VD: Thu·∫ø, M&A">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">T·ªânh/Th√†nh ph·ªë</label>
                                <select id="lawyer-province" class="input-field" onchange="loadLawyerWards()">
                                    <option value="">-- Ch·ªçn --</option>
                                    ${provinces.map(p => `<option value="${p.id}" ${lawyer?.province_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ph∆∞·ªùng/X√£</label>
                                <select id="lawyer-ward" class="input-field">
                                    <option value="">-- Ch·ªçn t·ªânh/th√†nh tr∆∞·ªõc --</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">ƒê·ªãa ch·ªâ c·ª• th·ªÉ</label>
                                <input type="text" id="lawyer-address" class="input-field" value="${lawyer?.address || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Gi·ªù l√†m vi·ªác</label>
                                <input type="text" id="lawyer-hours" class="input-field" value="${lawyer?.working_hours || ''}" placeholder="8:00 - 18:00">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Ng√†y l√†m vi·ªác</label>
                                <input type="text" id="lawyer-days" class="input-field" value="${lawyer?.working_days || ''}" placeholder="Th·ª© 2 - Th·ª© 6">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold mb-2">Gi·ªõi thi·ªáu</label>
                                <textarea id="lawyer-bio" class="input-field" rows="2">${lawyer?.bio || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex gap-6 mt-4">
                            <label class="flex items-center gap-2"><input type="checkbox" id="lawyer-online" ${lawyer?.is_online !== false ? 'checked' : ''}> ƒêang online</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="lawyer-primary" ${lawyer?.is_primary ? 'checked' : ''}> Lu·∫≠t s∆∞ ch√≠nh</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="lawyer-active" ${lawyer?.is_active !== false ? 'checked' : ''}> K√≠ch ho·∫°t</label>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 border rounded-lg">H·ªßy</button>
                            <button onclick="saveLawyer(${lawyer?.id || 'null'})" class="btn-primary">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
            if (lawyer?.province_id) setTimeout(() => loadLawyerWards(lawyer.ward_id), 100);
        }

        async function loadLawyerWards(selectedWardId = null) {
            const provinceId = document.getElementById('lawyer-province').value;
            const wardSelect = document.getElementById('lawyer-ward');
            if (!provinceId) {
                wardSelect.innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh tr∆∞·ªõc --</option>';
                return;
            }
            const wardsData = await loadWardsByProvince(provinceId);
            wardSelect.innerHTML = '<option value="">-- Ch·ªçn --</option>' + wardsData.map(w => 
                `<option value="${w.id}" ${selectedWardId == w.id ? 'selected' : ''}>${w.name}</option>`
            ).join('');
        }

        function updateLawyerPreview() {
            const url = document.getElementById('lawyer-avatar').value;
            const preview = document.getElementById('lawyer-avatar-preview');
            if (url) preview.innerHTML = `<img src="${url}" onerror="this.parentElement.innerHTML='LS'">`;
            else preview.innerHTML = 'LS';
        }

        async function saveLawyer(id) {
            const data = {
                name: document.getElementById('lawyer-name').value,
                company: document.getElementById('lawyer-company').value,
                phone: document.getElementById('lawyer-phone').value,
                zalo: document.getElementById('lawyer-zalo').value,
                email: document.getElementById('lawyer-email').value,
                avatar_url: document.getElementById('lawyer-avatar').value,
                address: document.getElementById('lawyer-address').value,
                province_id: document.getElementById('lawyer-province').value || null,
                ward_id: document.getElementById('lawyer-ward').value || null,
                working_hours: document.getElementById('lawyer-hours').value,
                working_days: document.getElementById('lawyer-days').value,
                bio: document.getElementById('lawyer-bio').value,
                specialization: document.getElementById('lawyer-spec').value,
                is_online: document.getElementById('lawyer-online').checked,
                is_primary: document.getElementById('lawyer-primary').checked,
                is_active: document.getElementById('lawyer-active').checked
            };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p h·ªç t√™n'); return; }
            try {
                const res = await fetch(API + '/admin/lawyers' + (id ? '/' + id : ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { closeModal(); loadLawyersContent(); }
                else alert(result.message || 'L·ªói');
            } catch (e) { alert('L·ªói k·∫øt n·ªëi'); }
        }

        async function deleteLawyer(id) {
            if (!confirm('X√≥a lu·∫≠t s∆∞ n√†y?')) return;
            try {
                const res = await fetch(API + '/admin/lawyers/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) loadLawyersContent();
            } catch (e) { alert('L·ªói'); }
        }

        // ========== SUPPORT REQUESTS ==========
        async function loadSupportContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/support-requests', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    content.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">Y√™u c·∫ßu t∆∞ v·∫•n</h1>
                        </div>
                        <div class="card overflow-hidden">
                            <table class="w-full">
                                <thead><tr class="bg-gray-50 text-left text-sm text-gray-500"><th class="p-4">KH√ÅCH H√ÄNG</th><th class="p-4">CH·ª¶ ƒê·ªÄ</th><th class="p-4">NG√ÄY G·ª¨I</th><th class="p-4">TR·∫†NG TH√ÅI</th><th class="p-4">THAO T√ÅC</th></tr></thead>
                                <tbody>${data.data.length === 0 ? '<tr><td colspan="5" class="p-8 text-center text-gray-400">Ch∆∞a c√≥ y√™u c·∫ßu</td></tr>' : data.data.map(r => `
                                    <tr class="table-row border-t">
                                        <td class="p-4"><div class="font-medium">${r.name}</div><div class="text-xs text-gray-500">${r.phone || ''} ${r.email || ''}</div></td>
                                        <td class="p-4">${r.subject || r.category || '-'}</td>
                                        <td class="p-4 text-sm">${r.created_at ? new Date(r.created_at).toLocaleDateString('vi-VN') : '-'}</td>
                                        <td class="p-4">
                                            <select class="text-sm border rounded px-2 py-1" onchange="updateRequestStatus(${r.id}, this.value)">
                                                <option value="pending" ${r.status === 'pending' ? 'selected' : ''}>Ch·ªù x·ª≠ l√Ω</option>
                                                <option value="processing" ${r.status === 'processing' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                                                <option value="completed" ${r.status === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                                            </select>
                                        </td>
                                        <td class="p-4">
                                            <button onclick='viewRequest(${JSON.stringify(r).replace(/'/g, "\\'")})' class="text-blue-600 hover:text-blue-800 mr-2"><span class="material-icons text-sm">visibility</span></button>
                                            <button onclick="deleteRequest(${r.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                                        </td>
                                    </tr>
                                `).join('')}</tbody>
                            </table>
                        </div>
                    `;
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        function viewRequest(req) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Chi ti·∫øt y√™u c·∫ßu</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-sm text-gray-500">H·ªç t√™n</label><div class="font-medium">${req.name}</div></div>
                                <div><label class="text-sm text-gray-500">ƒêi·ªán tho·∫°i</label><div>${req.phone || '-'}</div></div>
                                <div><label class="text-sm text-gray-500">Email</label><div>${req.email || '-'}</div></div>
                                <div><label class="text-sm text-gray-500">C√¥ng ty</label><div>${req.company || '-'}</div></div>
                            </div>
                            <div><label class="text-sm text-gray-500">Ch·ªß ƒë·ªÅ</label><div class="font-medium">${req.subject || req.category || '-'}</div></div>
                            <div><label class="text-sm text-gray-500">N·ªôi dung</label><div class="bg-gray-50 p-4 rounded-lg mt-1">${req.message || '-'}</div></div>
                        </div>
                        <div class="flex justify-end mt-6">
                            <button onclick="closeModal()" class="btn-primary">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function updateRequestStatus(id, status) {
            try {
                await fetch(API + '/admin/support-requests/' + id, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({ status })
                });
            } catch (e) { alert('L·ªói'); }
        }

        async function deleteRequest(id) {
            if (!confirm('X√≥a y√™u c·∫ßu n√†y?')) return;
            try {
                const res = await fetch(API + '/admin/support-requests/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) loadSupportContent();
            } catch (e) { alert('L·ªói'); }
        }

        // ========== LOCATIONS (PROVINCES & WARDS) ==========
        let locationTab = 'provinces';

        async function loadLocationsContent() {
            await loadMasterData();
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold">Qu·∫£n l√Ω ƒë·ªãa ƒëi·ªÉm</h1>
                </div>
                <div class="card">
                    <div class="flex border-b">
                        <div onclick="switchLocationTab('provinces')" class="tab-btn ${locationTab === 'provinces' ? 'active' : ''}" id="loc-tab-provinces">T·ªânh/Th√†nh ph·ªë (${provinces.length})</div>
                        <div onclick="switchLocationTab('wards')" class="tab-btn ${locationTab === 'wards' ? 'active' : ''}" id="loc-tab-wards">Ph∆∞·ªùng/X√£</div>
                    </div>
                    <div id="location-content" class="p-6"></div>
                </div>
            `;
            switchLocationTab(locationTab);
        }

        function switchLocationTab(tab) {
            locationTab = tab;
            document.getElementById('loc-tab-provinces').className = 'tab-btn ' + (tab === 'provinces' ? 'active' : '');
            document.getElementById('loc-tab-wards').className = 'tab-btn ' + (tab === 'wards' ? 'active' : '');
            if (tab === 'provinces') renderProvincesTab();
            else renderWardsTab();
        }

        async function renderProvincesTab() {
            document.getElementById('location-content').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <p class="text-gray-600">Danh s√°ch t·ªânh/th√†nh ph·ªë - d·ªØ li·ªáu do b·∫°n t·ª± nh·∫≠p</p>
                    <button onclick="showProvinceModal()" class="btn-primary flex items-center gap-2"><span class="material-icons text-sm">add</span> Th√™m m·ªõi</button>
                </div>
                <table class="w-full">
                    <thead><tr class="text-left text-sm text-gray-500 border-b"><th class="pb-3">T√äN</th><th class="pb-3">M√É</th><th class="pb-3">V√ôNG</th><th class="pb-3">THAO T√ÅC</th></tr></thead>
                    <tbody id="provinces-list"></tbody>
                </table>
            `;
            loadProvincesList();
        }

        async function loadProvincesList() {
            try {
                const res = await fetch(API + '/admin/provinces', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    provinces = data.data;
                    document.getElementById('provinces-list').innerHTML = provinces.length === 0 
                        ? '<tr><td colspan="4" class="text-center py-8 text-gray-400">Ch∆∞a c√≥ d·ªØ li·ªáu. Nh·∫•n "Th√™m m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</td></tr>'
                        : provinces.map(p => `
                        <tr class="table-row border-b">
                            <td class="py-4 font-medium">${p.name}</td>
                            <td class="py-4 text-gray-500">${p.code || '-'}</td>
                            <td class="py-4"><span class="badge ${p.region === 'north' ? 'badge-blue' : p.region === 'central' ? 'badge-green' : 'badge-yellow'}">${p.region === 'north' ? 'Mi·ªÅn B·∫Øc' : p.region === 'central' ? 'Mi·ªÅn Trung' : p.region === 'south' ? 'Mi·ªÅn Nam' : '-'}</span></td>
                            <td class="py-4">
                                <button onclick="showProvinceModal(${JSON.stringify(p).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mr-3"><span class="material-icons text-sm">edit</span></button>
                                <button onclick="deleteProvince(${p.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        function showProvinceModal(province = null) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6" style="max-width:500px">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">${province ? 'S·ª≠a' : 'Th√™m'} T·ªânh/Th√†nh</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">T√™n t·ªânh/th√†nh *</label>
                                <input type="text" id="prov-name" class="input-field" value="${province?.name || ''}" placeholder="VD: TP. H·ªì Ch√≠ Minh">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">M√£ (t√πy ch·ªçn)</label>
                                    <input type="text" id="prov-code" class="input-field" value="${province?.code || ''}" placeholder="VD: hcm">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">V√πng mi·ªÅn</label>
                                    <select id="prov-region" class="input-field">
                                        <option value="">-- Ch·ªçn --</option>
                                        <option value="north" ${province?.region === 'north' ? 'selected' : ''}>Mi·ªÅn B·∫Øc</option>
                                        <option value="central" ${province?.region === 'central' ? 'selected' : ''}>Mi·ªÅn Trung</option>
                                        <option value="south" ${province?.region === 'south' ? 'selected' : ''}>Mi·ªÅn Nam</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 border rounded-lg">H·ªßy</button>
                            <button onclick="saveProvince(${province?.id || 'null'})" class="btn-primary">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveProvince(id) {
            const data = {
                name: document.getElementById('prov-name').value,
                code: document.getElementById('prov-code').value || null,
                region: document.getElementById('prov-region').value || null
            };
            if (!data.name) { alert('Vui l√≤ng nh·∫≠p t√™n'); return; }
            try {
                const res = await fetch(API + '/admin/provinces' + (id ? '/' + id : ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { closeModal(); loadProvincesList(); loadMasterData(); }
                else alert(result.message || 'L·ªói');
            } catch (e) { alert('L·ªói k·∫øt n·ªëi'); }
        }

        async function deleteProvince(id) {
            if (!confirm('X√≥a t·ªânh/th√†nh n√†y s·∫Ω x√≥a lu√¥n t·∫•t c·∫£ ph∆∞·ªùng/x√£ thu·ªôc n√≥. Ti·∫øp t·ª•c?')) return;
            try {
                const res = await fetch(API + '/admin/provinces/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) { loadProvincesList(); loadMasterData(); }
            } catch (e) { alert('L·ªói'); }
        }

        // Wards tab
        let selectedProvinceForWards = null;

        async function renderWardsTab() {
            document.getElementById('location-content').innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-4">
                        <label class="font-semibold">Ch·ªçn T·ªânh/Th√†nh:</label>
                        <select id="ward-province-filter" class="input-field w-64" onchange="filterWardsByProvince()">
                            <option value="">-- Ch·ªçn ƒë·ªÉ xem --</option>
                            ${provinces.map(p => `<option value="${p.id}" ${selectedProvinceForWards == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <button onclick="showWardModal()" class="btn-primary flex items-center gap-2"><span class="material-icons text-sm">add</span> Th√™m Ph∆∞·ªùng/X√£</button>
                </div>
                <table class="w-full">
                    <thead><tr class="text-left text-sm text-gray-500 border-b"><th class="pb-3">T√äN PH∆Ø·ªúNG/X√É</th><th class="pb-3">THU·ªòC T·ªàNH/TH√ÄNH</th><th class="pb-3">THAO T√ÅC</th></tr></thead>
                    <tbody id="wards-list"><tr><td colspan="3" class="text-center py-8 text-gray-400">Ch·ªçn t·ªânh/th√†nh ƒë·ªÉ xem danh s√°ch</td></tr></tbody>
                </table>
            `;
            if (selectedProvinceForWards) filterWardsByProvince();
        }

        async function filterWardsByProvince() {
            selectedProvinceForWards = document.getElementById('ward-province-filter').value;
            if (!selectedProvinceForWards) {
                document.getElementById('wards-list').innerHTML = '<tr><td colspan="3" class="text-center py-8 text-gray-400">Ch·ªçn t·ªânh/th√†nh ƒë·ªÉ xem danh s√°ch</td></tr>';
                return;
            }
            try {
                const res = await fetch(API + '/admin/wards?province_id=' + selectedProvinceForWards, { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    const prov = provinces.find(p => p.id == selectedProvinceForWards);
                    document.getElementById('wards-list').innerHTML = data.data.length === 0
                        ? `<tr><td colspan="3" class="text-center py-8 text-gray-400">Ch∆∞a c√≥ ph∆∞·ªùng/x√£ cho ${prov?.name}</td></tr>`
                        : data.data.map(w => `
                        <tr class="table-row border-b">
                            <td class="py-4 font-medium">${w.name}</td>
                            <td class="py-4 text-gray-500">${prov?.name || '-'}</td>
                            <td class="py-4">
                                <button onclick="showWardModal(${JSON.stringify(w).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-800 mr-3"><span class="material-icons text-sm">edit</span></button>
                                <button onclick="deleteWard(${w.id})" class="text-red-600 hover:text-red-800"><span class="material-icons text-sm">delete</span></button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        function showWardModal(ward = null) {
            modalRoot.innerHTML = `
                <div class="modal" onclick="if(event.target===this)closeModal()">
                    <div class="modal-content p-6" style="max-width:500px">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">${ward ? 'S·ª≠a' : 'Th√™m'} Ph∆∞·ªùng/X√£</h2>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><span class="material-icons">close</span></button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Thu·ªôc T·ªânh/Th√†nh *</label>
                                <select id="ward-province" class="input-field">
                                    <option value="">-- Ch·ªçn --</option>
                                    ${provinces.map(p => `<option value="${p.id}" ${(ward?.province_id || selectedProvinceForWards) == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">T√™n Ph∆∞·ªùng/X√£ *</label>
                                <input type="text" id="ward-name" class="input-field" value="${ward?.name || ''}" placeholder="VD: Ph∆∞·ªùng T√¢n Ph√∫">
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeModal()" class="px-6 py-2 border rounded-lg">H·ªßy</button>
                            <button onclick="saveWard(${ward?.id || 'null'})" class="btn-primary">L∆∞u</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveWard(id) {
            const data = {
                province_id: document.getElementById('ward-province').value,
                name: document.getElementById('ward-name').value
            };
            if (!data.province_id || !data.name) { alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß'); return; }
            try {
                const res = await fetch(API + '/admin/wards' + (id ? '/' + id : ''), {
                    method: id ? 'PUT' : 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) { closeModal(); filterWardsByProvince(); }
                else alert(result.message || 'L·ªói');
            } catch (e) { alert('L·ªói k·∫øt n·ªëi'); }
        }

        async function deleteWard(id) {
            if (!confirm('X√≥a ph∆∞·ªùng/x√£ n√†y?')) return;
            try {
                const res = await fetch(API + '/admin/wards/' + id, { method: 'DELETE', headers: getHeaders() });
                if ((await res.json()).success) filterWardsByProvince();
            } catch (e) { alert('L·ªói'); }
        }

        // ========== SETTINGS ==========
        async function loadSettingsContent() {
            const content = document.getElementById('content');
            content.innerHTML = '<div class="flex justify-center py-20"><div class="animate-spin w-8 h-8 border-4 border-navy-500 border-t-transparent rounded-full"></div></div>';
            try {
                const res = await fetch(API + '/admin/settings', { headers: getHeaders() });
                const data = await res.json();
                if (data.success) {
                    const settings = {};
                    data.data.forEach(s => settings[s.key] = s.value);
                    content.innerHTML = `
                        <h1 class="text-2xl font-bold mb-6">C√†i ƒë·∫∑t App</h1>
                        <div class="card p-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-semibold mb-2">T√™n c√¥ng ty</label>
                                    <input type="text" id="set-company" class="input-field" value="${settings.company_name || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Hotline</label>
                                    <input type="text" id="set-hotline" class="input-field" value="${settings.hotline || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Email li√™n h·ªá</label>
                                    <input type="text" id="set-email" class="input-field" value="${settings.contact_email || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Website</label>
                                    <input type="text" id="set-website" class="input-field" value="${settings.website || ''}">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-semibold mb-2">ƒê·ªãa ch·ªâ</label>
                                    <input type="text" id="set-address" class="input-field" value="${settings.address || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Gi·ªù l√†m vi·ªác</label>
                                    <input type="text" id="set-hours" class="input-field" value="${settings.working_hours || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Ng√†y l√†m vi·ªác</label>
                                    <input type="text" id="set-days" class="input-field" value="${settings.working_days || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Zalo Link</label>
                                    <input type="text" id="set-zalo" class="input-field" value="${settings.zalo_link || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Facebook</label>
                                    <input type="text" id="set-fb" class="input-field" value="${settings.facebook || ''}">
                                </div>
                            </div>
                            <div class="mt-6">
                                <button onclick="saveSettings()" class="btn-primary">L∆∞u c√†i ƒë·∫∑t</button>
                            </div>
                        </div>
                    `;
                }
            } catch (e) { content.innerHTML = '<div class="text-red-500">L·ªói t·∫£i d·ªØ li·ªáu</div>'; }
        }

        async function saveSettings() {
            const settings = [
                { key: 'company_name', value: document.getElementById('set-company').value },
                { key: 'hotline', value: document.getElementById('set-hotline').value },
                { key: 'contact_email', value: document.getElementById('set-email').value },
                { key: 'website', value: document.getElementById('set-website').value },
                { key: 'address', value: document.getElementById('set-address').value },
                { key: 'working_hours', value: document.getElementById('set-hours').value },
                { key: 'working_days', value: document.getElementById('set-days').value },
                { key: 'zalo_link', value: document.getElementById('set-zalo').value },
                { key: 'facebook', value: document.getElementById('set-fb').value }
            ];
            try {
                for (const s of settings) {
                    await fetch(API + '/admin/settings', {
                        method: 'POST',
                        headers: getHeaders(),
                        body: JSON.stringify(s)
                    });
                }
                alert('ƒê√£ l∆∞u c√†i ƒë·∫∑t');
            } catch (e) { alert('L·ªói'); }
        }

        // ========== INIT ==========
        checkAuth();
    </script>
</body>
</html>
